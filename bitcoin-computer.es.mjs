import{crypto as t,Transaction as e,PrivateKey as n,Opcode as r,Script as s,PublicKey as o,Mnemonic as i}from"bitcoinsource";import c from"axios";import a from"crypto";import u from"crypto-js";import*as d from"eciesjs";
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */function h(t,e){var n={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.indexOf(r)<0&&(n[r]=t[r]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var s=0;for(r=Object.getOwnPropertySymbols(t);s<r.length;s++)e.indexOf(r[s])<0&&Object.prototype.propertyIsEnumerable.call(t,r[s])&&(n[r[s]]=t[r[s]])}return n}function l(t,e,n,r){var s,o=arguments.length,i=o<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(t,e,n,r);else for(var c=t.length-1;c>=0;c--)(s=t[c])&&(i=(o<3?s(i):o>3?s(e,n,i):s(e,n))||i);return o>3&&i&&Object.defineProperty(e,n,i),i}function f(t,e,n,r){return new(n||(n=Promise))((function(s,o){function i(t){try{a(r.next(t))}catch(t){o(t)}}function c(t){try{a(r.throw(t))}catch(t){o(t)}}function a(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(i,c)}a((r=r.apply(t,e||[])).next())}))}const p=process.env.BC_CHAIN||"BSV";const v=process.env.BC_NETWORK||"testnet";const _=parseInt(process.env.BC_DUST_LIMIT||"",10)||4e3;const g=parseInt(process.env.BC_DEFAULT_FEE||"",10)||("BSV"===p?500:2500);const w=parseInt(process.env.BC_SCRIPT_CHUNK_SIZE||"",10)||("BSV"===p?1/0:479);const b=process.env.BSV_TESTNET_BBS_URL?process.env.BSV_TESTNET_BBS_URL:"http://50.18.114.11";const m=process.env.BCH_TESTNET_BBS_URL?process.env.BCH_TESTNET_BBS_URL:"http://13.52.113.43";let y="";"BSV"===p&&"testnet"===v&&(y=b),"BCH"===p&&"testnet"===v&&(y=m);const O=t=>{y=t};const x=new URL(y).origin;var S={CHAIN:p,NETWORK:v,MIN_NON_DUST_AMOUNT:_,SCRIPT_CHUNK_SIZE:w,BBS_URL:y,setBbsUrl:O,BBS_ORIGIN:x,DEFAULT_FEE:g};const j=e=>{const n=Date.now();const r=t.Hash.sha256(Buffer.from(S.BBS_ORIGIN+n));const s=[t.ECDSA.sign(r,e,"big").toString("hex"),e.publicKey.toString(),n];return`Bearer ${Buffer.from(s.join(":")).toString("base64")}`};const I=(t,e={})=>{const{path:n="m/44'/0'/0'/0",passphrase:r=""}=e;let s=t.toHDPrivateKey(r,S.NETWORK);return n&&(s=s.derive(n)),s.privateKey};function E(t){try{const n=JSON.parse(t);if("object"!=typeof n)throw new Error("Invalid object");if("string"!=typeof n.txhex)throw new Error("Invalid object");return new e(n.txhex)}catch(t){return null}}function $(t){return f(this,void 0,void 0,(function*(){const{message:e,config:n,response:r}=t;const s=E(null==n?void 0:n.data);const o=`message\t${e}`;const i=`request\t${null==n?void 0:n.method} ${null==n?void 0:n.url}`;const c=s?`transaction\t ${JSON.stringify(s.toJSON(),null,2)}`:"";const a="post"===(null==n?void 0:n.method)?`data\t${null==n?void 0:n.data}`:"";const u=r?`response\t${JSON.stringify(r.data)}`:"";const d=s?c:a;throw t.message=`\n    Communication Error\n    ${o}\n    ${i}\n    ${d}\n    ${u}`,t}))}class B{constructor(t,e={},n){this.baseUrl=t,this.headers=e,this.privateKey=n}get(t){return f(this,void 0,void 0,(function*(){const e=`${this.baseUrl}${t}`;try{let t={};return this.privateKey&&(t={Authentication:j(this.privateKey)}),(yield c.get(e,{headers:Object.assign(Object.assign({},this.headers),t)})).data}catch(t){return $(t)}}))}post(t,e){return f(this,void 0,void 0,(function*(){const n=`${this.baseUrl}${t}`;try{let t={};return this.privateKey&&(t={Authentication:j(this.privateKey)}),(yield c.post(n,e,{headers:Object.assign(Object.assign({},this.headers),t)})).data}catch(t){return $(t)}}))}delete(t){return f(this,void 0,void 0,(function*(){const e=`${this.baseUrl}${t}`;try{let t={};return this.privateKey&&(t={Authentication:j(this.privateKey)}),(yield c.delete(e,{headers:Object.assign(Object.assign({},this.headers),t)})).data}catch(t){return $(t)}}))}}function R(t){return void 0!==t._url}function T(t){return void 0!==t.__cypher&&void 0!==t.__secrets}const D=()=>t=>t;function N(t){if(!/^[0-9A-Fa-f]{64}$/.test(t))throw new Error(`Invalid txId: ${t}`)}function C(t){if(!/^[0-9A-Fa-f]{64}:\d+$/.test(t))throw new Error(`Invalid outId: ${t}`)}function A(t){C(t);const[e,n]=t.split(":");return{txId:e,outIndex:parseInt(n,10)}}let K=class{constructor(t=S.CHAIN,e=S.NETWORK,r=new n){this.chain=t,this.network=e,this.bbs=new B(S.BBS_URL,{},r)}getBalance(t){return f(this,void 0,void 0,(function*(){return yield this.bbs.get(`/balance/${t}`)}))}getTransaction(t){return f(this,void 0,void 0,(function*(){return new e(yield this.getRawTx(t))}))}getRawTx(t){return f(this,void 0,void 0,(function*(){N(t);const e="livenet"===this.network?"main":"test";return this.bbs.get(`/tx/${this.chain}/${e}/${t}`)}))}getRawTxData(t){return f(this,void 0,void 0,(function*(){N(t);const e="livenet"===this.network?"main":"test";return this.bbs.get(`/tx-data/${this.chain}/${e}/${t}`)}))}getTransactions(t){return f(this,void 0,void 0,(function*(){return(yield this.getRawTxs(t)).map((t=>new e(t)))}))}getRawTxs(t){return f(this,void 0,void 0,(function*(){t.map(N);const e="livenet"===this.network?"main":"test";return this.bbs.post(`/tx-bulk/${this.chain}/${e}`,{txIds:t})}))}sendTransaction(t){return f(this,void 0,void 0,(function*(){return this.bbs.post("/tx",{rawTx:t})}))}getUtxosFromAddress(t){return f(this,void 0,void 0,(function*(){return this.bbs.get(`/utxos/${t.toString()}`)}))}postOutData(t){return f(this,void 0,void 0,(function*(){return this.bbs.post("/postOutData",t)}))}getOutData(t){return f(this,void 0,void 0,(function*(){return this.bbs.get(`/un-p2sh/${t}`)}))}getOwnedRevs(t){return f(this,void 0,void 0,(function*(){return this.bbs.get(`/txos/${t.toString()}`)}))}queryRevs(t){return f(this,void 0,void 0,(function*(){const{publicKey:e,contractName:n,contractHash:r}=t;if(void 0===e&&void 0===n&&void 0===r)throw new Error("Filter parameter for queryRevs endpoint cannot be empty.");let s="";return e&&(s+=`?publicKey=${e}`),n&&(s+=0===s.length?"?":"&",s+=`contractName=${n}`),r&&(s+=0===s.length?"?":"&",s+=`contractHash=${r}`),this.bbs.get(`/query-revs${s}`)}))}getLatestRev(t){return f(this,void 0,void 0,(function*(){C(t);const[{rev:e}]=yield this.bbs.get(`/get-rev/${t}`);return e}))}getLatestRevs(t){return f(this,void 0,void 0,(function*(){return t.map(C),t.map(C),yield this.bbs.post("/get-revs",{ids:t})}))}static getSecretOutput({_url:t,privateKey:e}){return f(this,void 0,void 0,(function*(){const n=t.split("/");const r=n[n.length-1];const s=n.slice(0,-2).join("/");const o=new B(s,{},e);return{host:s,data:yield o.get(`/store/${r}`)}}))}static setSecretOutput({secretOutput:t,host:e,privateKey:n}){return f(this,void 0,void 0,(function*(){return new B(e,{},n).post("/store/",t)}))}static deleteSecretOutput({_url:t,privateKey:e}){return f(this,void 0,void 0,(function*(){const n=t.split("/");const r=n[n.length-1];const s=n.slice(0,-2).join("/");const o=new B(s,{},e);yield o.delete(`/store/${r}`)}))}};K=l([D()],K);const P=()=>`__temp__:${Math.random()}`;const U=["_id","_rev","_owners","_amount","_readers","_url","__vouts","__cls","__func","__index","__args"];const H=t=>(Object.prototype.toString.call(t).match(/\s([a-zA-Z]+)/)||[])[1];const k=t=>"object"==typeof t?H(t):H(t).toLowerCase();const V=t=>["number","string","boolean","undefined","Null"].includes(k(t));const F=t=>"Array"===k(t);const L=t=>"Object"===k(t);const J=t=>V(t)||["Array","Object"].includes(k(t));const M=t=>"Object"===k(t)&&Object.keys(t).every((t=>!Number.isNaN(parseInt(t,10))));const W=(t,e)=>{if(!J(t)||!J(e))throw new Error(`Unsupported data types for deep equals: ${k(t)} & ${k(e)}`);if(k(t)!==k(e))return!1;if(V(t)&&V(e))return t===e;const n=(t,e)=>Object.entries(t).every((([t,n])=>W(e[t],n)));return t&&e&&n(t,e)&&n(e,t)};const q=t=>{if(V(t))return t;if(F(t))return t.map(q);if(L(t)){const e=Object.keys(t).reduce(((e,n)=>(e[n]=q(t[n]),e)),{});const n=Object.create(Object.getPrototypeOf(t));return Object.assign(n,e)}throw new Error(`Unsupported data type for clone: ${k(t)}`)};const Z=(t,e)=>t.reduce((([t,n],r,s)=>e(r,s)?[[...t,r],n]:[t,[...n,r]]),[[],[]]);const G=(t,e)=>Object.fromEntries(Object.entries(t).map((t=>e(t))));const z=(t,e)=>G(t,(([t,n])=>[t,e(n)]));const Q=(t,e)=>Object.fromEntries(Object.entries(t).filter((([,t])=>e(t))));const X=(t,e,n,r)=>{if(V(t))return t;if(F(t))return t.map((t=>X(t,e,n,r)));if(L(t)){t._rev=`${r}:${n}`;const s=e[n];return Object.entries(t).forEach((([n,o])=>{"object"==typeof s&&Object.keys(s).includes(n)&&(t[n]=X(o,e,s[n],r))})),t}throw new Error(`Unsupported type ${k(t)} in deep.updateRev`)};const Y=t=>{if(V(t))return t;if(F(t))return t.map((t=>Y(t)));if(L(t))return t.__cls=t.constructor.toString(),Object.entries(t).forEach((([e,n])=>{t[e]=Y(n)})),t;throw new Error(`Unsupported type ${k(t)} in deep.addClass`)};const tt=(t,e)=>{if(V(t))return t;if(F(t))return t.map((t=>tt(t,e)));if(L(t))return t._id=!t._id||t._id.startsWith("__temp__")?t._rev:t._id,t._rootId=t._rootId||e,Object.entries(t).forEach((([n,r])=>{t[n]=tt(r,e)})),t;throw new Error(`Unsupported type ${k(t)} in deep.addId`)};const et=t=>{if(V(t))return t;if(F(t))return t.map((t=>et(t)));if(L(t)){const e=P();return t._id=t._id||e,t._rev=t._rev||e,Object.values(t).map((t=>et(t))),t}throw new Error(`Unsupported type ${k(t)} in addRandomId`)};const nt=t=>{if(V(t))return t;if(F(t))return t.map((t=>nt(t)));if(L(t))return G(t,(([t,e])=>["_owners","_readers","_url"].includes(t)?[t,JSON.stringify(e)]:V(e)?[t,e]:[t,nt(e)]));throw new Error(`Unexpected type ${k(t)} in stringifyOwners`)};const rt=t=>(t._owners&&(t._owners=JSON.parse(t._owners)),t._readers&&(t._readers=JSON.parse(t._readers)),t._url&&(t._url=JSON.parse(t._url)),t);const st=t=>{if(V(t))return t;if(F(t)||L(t))return Object.entries(t).reduce(((t,[e,n])=>{const r=st(n);return M(r)?Object.entries(r).forEach((([n,r])=>{t[`${e}_${n}`]=r})):t[e]=r,t}),{});throw new Error(`Unsupported type ${k(t)} in encodeArraysAsObjects`)};const ot=t=>{const e={[t._id]:Object.entries(t).reduce(((t,[e,n])=>U.includes(e)?Object.assign(Object.assign({},t),{[e]:n}):V(n)?Object.assign(Object.assign({},t),{[`__basic__${e}`]:n}):Object.assign(Object.assign({},t),{[e]:n._id})),{})};return Object.values(t).filter((t=>!V(t))).reduce(((t,e)=>Object.assign(Object.assign({},t),ot(e))),e)};const it=t=>Object.fromEntries(Object.entries(t).filter((([t])=>!t.startsWith("__basic__"))));const ct=(t,e)=>Object.fromEntries(Object.entries(e).map((([e,n])=>{const r=t[e];var s;return n.__change=(s=r)?W(s,n)?"same":"diff":"new",[e,n]})));const at=(t,e)=>(t[e].__contains=Object.entries(t[e]).reduce(((e,[n,r])=>["__contains"].concat(U).includes(n)?e:"__change"===n?"new"===r||"diff"===r||e:at(t,r)[r].__contains||e),!1),t);const ut=t=>t.reduce(((t,e,n)=>Object.assign(Object.assign({},t),{[e._id]:n})),{});const dt=(t,e)=>t.map((t=>Object.entries(t).reduce(((t,[n,r])=>{const s="string"==typeof r&&"undefined"!==k(e[r])?e[r]:r;return Object.assign(Object.assign({},t),{[n]:s})}),{})));const ht=(t,e,n)=>{const[r,...s]=[e,...t].map(((t,e)=>{const r=h(t,["_id","_rev","__change","__contains"]);return 0===e||e<=n.length?h(r,["__cls"]):r}));return[r,...s.map((t=>Object.fromEntries(Object.entries(t).filter((([t,e])=>U.filter((t=>"__cls"!==t)).includes(t)||"__cls"===t&&"string"==typeof e&&"function Object() { [native code] }"!==e||"number"==typeof e)))))]};const lt=(t,e)=>{const n=et(e);const r=n._id;const s=q(t);const o=q(n);Y(s),Y(o);const i=nt(s);const c=nt(o);const a=st(i);const u=st(c);const d=ot(a);const h=ot(u);const l=ct(d,h);const f=z(l,it);const p=at(f,r);const v=p[r];delete v.__cls,delete p[r];const _=z(p,(t=>t._rev));const g=Q(p,(t=>t.__contains||Object.values(v).includes(t._id)));const w=Object.values(g);const[b,m]=Z(w,(t=>"new"===t.__change));const y=[...m,...b];const O=ut(y);const x=dt(y,O);const[S]=dt([v],O);const j=m.map((t=>t._rev));const[I,...E]=ht(x,S,j);return[j,E.map(rt).map((t=>Object.entries(t).reduce(((t,[e,n])=>Object.assign(Object.assign({},t),{[e]:_[n]||n})),{}))),I]};function ft(t,e){let n=0;return e.map((e=>"__"===e?t[n++]:e))}class pt{constructor(t){this.db=t}get(t){return f(this,void 0,void 0,(function*(){const{txId:e,outIndex:n}=A(t);const{inRevs:r,outData:s}=yield this.db.fromTxId(e);if(!Array.isArray(r)||!Array.isArray(s)||0===s.length)return;const o=s[0].__index||{};const i=s[o.obj].__cls||"";const c=s[o.obj].__func||"";const a=s[o.obj].__args||[];const u=yield Promise.all(Object.values(o).map((t=>{const e=r[t];return e?this.get(e):Promise.resolve({})})));const d=Object.keys(o).map(((t,e)=>[t,u[e]]));const h=Object.fromEntries(d);let l=h.obj;delete h.obj;const f=Object.entries(h).reduce(((t,[e,n])=>{const r=parseInt(e,10);return Number.isNaN(r)||(t[r]=n),t}),[]);const p=ft(f,a);let v;if("constructor"===c){const t=eval(`(${i})`);l=Reflect.construct(t,p)}else v=Reflect.apply(l[c].bind(l),l,p);Object.entries(o).forEach((([t,n])=>{const r=parseInt(t,10);let o=f[r];"obj"===t?o=l:"res"===t&&(o=v),X(o,s,n,e)}));const _=l._rootId||`${e}:${o.obj}`;return tt([v,l,...f],_),[...f,l,v][n]}))}}function vt(t){return{smartArgs:t.filter((t=>t._rev)),dumbArgs:t.map((t=>t._rev?"__":t))}}function _t(t){return f(this,void 0,void 0,(function*(){let e;let n;let r;let s;let o;let i;let c;if("Cls"in t){const{Cls:a,args:u}=t;e=a.toString(),n=null,r=Reflect.construct(a,u),s=q(u),o=u,i=null,c=void 0}else{const{target:a,property:u,args:d}=t;e=null,n=q(a),r=a,s=q(d),o=d,i=u,c=Reflect.apply(a[u],a,o)}const{smartArgs:a,dumbArgs:u}=vt(s);const{smartArgs:d}=vt(o);const h=Object.assign(Object.assign(Object.assign({},a),{obj:n}),{_id:"index"});const l=Object.assign(Object.assign(Object.assign({},d),{obj:r}),{_id:"index"});"Object"===k(c)&&(l.res=c);const[f,p,v]=lt(h,l);void 0!==p[0]&&(p[0].__index=v);const _=v.obj;return void 0!==p[_]&&(null!==e&&(p[_].__cls=e),p[_].__func=null===i?"constructor":String(i),p[_].__args=u),[f,p,r,d,c,v]}))}class gt{constructor(t){this.db=t}construct(t,e){return f(this,void 0,void 0,(function*(){const[n,r,s,o,,i]=yield _t({Cls:t,args:e});const[c]=yield this.db.update(n,r);const{txId:a}=A(c);Object.entries(i).forEach((([t,e])=>{const n=parseInt(t,10);let i=o[n];"obj"===t&&(i=s),X(i,r,e,a)}));const u=`${a}:${i.obj}`;return tt([s,...o],u),s}))}call(t,e,n){return f(this,void 0,void 0,(function*(){const[r,s,,o,i,c]=yield _t({target:t,property:e,args:n});const[a]=yield this.db.update(r,s);const{txId:u}=A(a);Object.entries(c).forEach((([e,n])=>{const r=parseInt(e,10);let c=o[r];"obj"===e?c=t:"res"===e&&(c=i),X(c,s,n,u)}));const d="string"==typeof t._rootId?t._rootId:`${u}:${c.obj}`;return tt([i,t,...o],d),i}))}get(t,e){return"function"==typeof t[e]?(...n)=>this.call(t,e,n):Reflect.get(t,e)}}function wt(t,e){const n=[];let r=0;for(;r<t.length;){const s=r+e;n.push(t.slice(r,s)),r=s}return n}function bt(t,e){const n=new s;if(!Array.isArray(e))throw new Error("Owners is not defined");if(e.length>16)throw new Error("Too many owners");return n.add("OP_1"),e.forEach((t=>{n.add(o.fromString(t).toBuffer())})),n.add(`OP_${e.length}`),n.add("OP_CHECKMULTISIG"),n.add(t),n.add("OP_DROP"),n}function mt(t){const e=t.chunks.length;return!(!t.chunks[e-2].buf||t.chunks[e-1].opcodenum!==r.OP_DROP)}function yt(t){const{_amount:e,__vouts:n,_owners:r}=t,s=h(t,["_amount","__vouts","_owners"]);const o=Buffer.from(JSON.stringify(s));return("BSV"===S.CHAIN?[o]:wt(o,S.SCRIPT_CHUNK_SIZE)).map((t=>bt(t,r)))}function Ot(t){if(mt(t))return t.chunks.slice(1,t.chunks.length-4).map((t=>{if(!t.buf)throw new Error("Illegal state");return new o(t.buf).toString()}));throw new Error("Cannot get owners from non-data script")}function xt(t){if(mt(t)){const e=t.chunks[t.chunks.length-2];if(!e.buf)throw new Error("Illegal state");const n=JSON.parse(e.buf.toString());const r=Ot(t);return void 0!==r&&(n._owners=r),n}throw new Error("Not a data script.")}function St(t){const{chunks:e}=t;return e[0].opcodenum===r.OP_HASH160&&e[e.length-1].opcodenum===r.OP_EQUAL}function jt(t){let e=0;const n=[];for(let r=0;r<t.length;r+=1)n.push(e),e+=t[r];return n}function It(t,e){let n=0;for(let r=0;r<e.length;r+=1){const s=[];for(let t=0;t<e[r];t+=1)s.push(n),n+=1;if(s[0]===t)return s}throw new Error("No match found")}function Et(t,e){let n=0;for(let r=0;r<e.length;r+=1){const s=[];for(let t=0;t<e[r];t+=1)s.push(n),n+=1;if(s[0]===t)return r}throw new Error("No match found")}const $t=(t,e)=>t.length===e.length&&t.every(((t,n)=>t===e[n]));var Bt;const{Output:Rt}=e;const{MultiSigScriptHash:Tt}=e.Input;const{UnspentOutput:Dt}=e;let Nt=Bt=class{constructor(t,n,r,s){const o=new e(s);o.feePerKb(S.DEFAULT_FEE),this.restClient=new K(t,n,r),this._tx=o,this._outData=[],this._privateKey=r}get chain(){return this.restClient.chain}get network(){return this.restClient.network}get tx(){return this._tx}get inputs(){return this.tx.inputs.map((t=>`${t.prevTxId.toString("hex")}:${t.outputIndex}`))}get inRevs(){let t=0;const{opReturns:e}=this;if(0===e.length)return;const[{__vins:n}]=e;if(!Array.isArray(n))throw new Error("Virtual inputs not found");return n.map((e=>{if(!this.tx.inputs[t])throw new Error("Input not found in inRevs");const{prevTxId:n,outputIndex:r}=this.tx.inputs[t];return t+=e,`${n.toString("hex")}:${r}`}))}get outRevs(){let t=0;const{opReturns:e}=this;if(0===e.length)return;const[{__vouts:n}]=e;if(!Array.isArray(n))throw new Error("Virtual inputs not found");const r=this.tx.id;return n.map((e=>{const n=`${r}:${t}`;return t+=e,n}))}get outData(){return this._outData}get opReturns(){const{outputs:t}=this.tx;return t.filter((t=>new s(t.script.toBuffer()).toString().startsWith("OP_RETURN"))).map((t=>{var e,n;const r=new s(t.script.toBuffer());const{chunks:o}=r;return JSON.parse((null===(n=null===(e=o[1])||void 0===e?void 0:e.buf)||void 0===n?void 0:n.toString())||"")}))}checkOutDataBCH(t){const e=t.map((t=>yt(h(t,["_amount"])).map((t=>s.buildScriptHashOut(t))))).flat().map((t=>t.toString()));const n=this.tx.outputs.map((t=>new s(t.script))).filter((t=>St(t))).map((t=>t.toString()));return $t(n,e)}addMetaData(t){return t.map(((t,e)=>{const n=this.tx.outputs[e];const r="BSV"===this.chain?Ot(new s(n.script)):t._owners;const o=n.satoshis;return void 0!==r&&(t._owners=r),void 0!==o&&(t._amount=o),t}))}spendFromDataBsv(t){return f(this,void 0,void 0,(function*(){const e=t.map(A);const n=e.map((t=>t.txId));const r=yield this.restClient.getTransactions(n);for(let t=0;t<e.length;t+=1){const{txId:n,outIndex:o}=e[t];const{outputs:i}=r[t];const c=i[o];const a=new s(c.script);const u=Math.round(c.satoshis);const d=Ot(a);const h={txId:n,outputIndex:o,script:a,satoshis:u};this.tx.from([new Dt(h)],d,1)}return new Array(e.length).fill(1)}))}spendFromDataBch(t){return f(this,void 0,void 0,(function*(){const e=[];for(const n of t){const{txId:t,outIndex:r}=A(n);const o=yield Bt.fromTxId(t,this.chain,this.network,this._privateKey);const{outData:i}=o;const[{__vouts:c}]=o.opReturns;const a=It(r,c).map((e=>{const{script:n,satoshis:r}=o.tx.outputs[e];const s=n.toBuffer().toString("hex");return{txId:t,vout:e,scriptPubKey:s,satoshis:r,amount:r/1e8}}));const u=i[Et(r,c)];const d=yt(h(u,["_amount"]));d.forEach(((t,e)=>{const{scriptPubKey:n,satoshis:r,txId:o,vout:i}=a[e];const c=new Rt({script:new s(n),satoshis:r});const d=new s;const h=new Tt({prevTxId:o,output:c,outputIndex:i,script:d},u._owners||[],1,null,t);this.tx.addInput(h)})),e.push(d.length)}return e}))}spendFromData(t){return f(this,void 0,void 0,(function*(){return 0===t.length?[]:"BSV"===this.chain?this.spendFromDataBsv(t):this.spendFromDataBch(t)}))}createOpReturnOut(t){this.tx.addData(JSON.stringify(t))}createDataOut(t){const{_amount:e}=t,n=h(t,["_amount"]);const r=e||S.MIN_NON_DUST_AMOUNT;const o=yt(n);if(this._outData.push(n),"BSV"===this.chain){const t=new Rt({script:o[0],satoshis:r});return this.tx.addOutput(t),1}return o.forEach((t=>{const e=new Rt({script:s.buildScriptHashOut(t),satoshis:r});this.tx.addOutput(e)})),o.length}static fromHexBSV(t,e,n){const r=new this("BSV",e,n);r.tx.fromString(t);const o=r.tx.outputs.filter((t=>mt(new s(t._scriptBuffer)))).map((t=>xt(new s(t._scriptBuffer))));return r._outData=r.addMetaData(o),r}static fromHexBCH(t,e,n,r){const s=new this("BCH",e,n);if(s.tx.fromString(t),!s.checkOutDataBCH(r))throw new Error("Invalid data from server in fromHexBCH.");return s._outData=s.addMetaData(r),s}static fromTxId(t,e,n,r){return f(this,void 0,void 0,(function*(){const s=new K(e,n,r);if("BSV"===e){const e=yield s.getRawTx(t);return this.fromHexBSV(e,n,r)}const{hex:o,data:i}=yield s.getRawTxData(t);return this.fromHexBCH(o,n,r,i)}))}};function Ct(t){return Buffer.from(u.SHA256(t).toString(),"hex").toString("hex").substr(0,4)}function At(t,e){return Ct(t)===e}function Kt(t){return`${Ct(t)};${t}`}function Pt(t){const e=t.substr(0,4);const n=t.substr(5);if(!At(n,e))throw new Error("Decryption failure");return n}function Ut(){return a.randomBytes(32).toString("hex")}function Ht(t,e){if(!/^[0-9a-f]{64}$/.test(e))throw new Error("Invalid secret");const n=Buffer.from(e,"hex").toString("binary");const r=Kt(t);return u.AES.encrypt(r,n).toString()}function kt(t,e){if(!/^[0-9a-f]{64}$/.test(e))throw new Error("Invalid secret");const n=Buffer.from(e,"hex").toString("binary");return Pt(u.AES.decrypt(t,n).toString(u.enc.Utf8))}function Vt(t,e){if(!/^0[2-3][0-9a-f]{64}|04[0-9a-f]{128}$/.test(e))throw new Error("Invalid publicKey");const n=Kt(t);return d.encrypt(e,Buffer.from(n,"utf8")).toString("base64")}function Ft(t,e){if(!/^[0-9a-f]{64}$/.test(e))throw new Error("Invalid privateKey");return Pt(d.decrypt(e,Buffer.from(t,"base64")).toString("utf8"))}function Lt(t,e){const n=Ut();return{__cypher:Ht(t,n),__secrets:e.map((t=>Vt(n,t)))}}function Jt({__cypher:t,__secrets:e},n){let r="";if(n.forEach((n=>{e.forEach((e=>{try{const s=Ft(e,n);r=kt(t,s)}catch(t){if(!["Decryption failure","Unsupported state or unable to authenticate data"].includes(t.message))throw t}}))})),r)return r;throw new Error("Decryption failure")}function Mt(t){if(void 0!==t._readers){const{_readers:e,_url:n,_owners:r,_amount:s}=t,o=h(t,["_readers","_url","_owners","_amount"]);const i=Lt(JSON.stringify(o),e);return void 0!==n&&(i._url=n),void 0!==r&&(i._owners=r),void 0!==s&&(i._amount=s),i}return t}function Wt(t,e){if(T(t)){const{__cypher:n,__secrets:r}=t,s=h(t,["__cypher","__secrets"]);return Object.assign(Object.assign(Object.assign({},s),JSON.parse(Jt({__cypher:n,__secrets:r},e))),{_readers:[]})}return t}function qt(t){return e=>f(this,void 0,void 0,(function*(){if(void 0!==e._url){const{_url:n,_owners:r,_amount:s}=e,o=h(e,["_url","_owners","_amount"]);const i=yield K.setSecretOutput({host:n,secretOutput:{data:JSON.stringify(o)},privateKey:t.getPrivateKey()});return void 0!==r&&(i._owners=r),void 0!==s&&(i._amount=s),i}return e}))}function Zt(t){return e=>f(this,void 0,void 0,(function*(){if(R(e)){const{_url:n}=e,r=h(e,["_url"]);const{host:s,data:o}=yield K.getSecretOutput({_url:n,privateKey:t.getPrivateKey()});return Object.assign(Object.assign(Object.assign({},r),JSON.parse(o)),{_url:s})}return e}))}Nt=Bt=l([D()],Nt);class Gt{constructor(t){this.wallet=t}get chain(){return this.wallet.chain}get network(){return this.wallet.network}fromDataTx(t,e=!0,n=!0){return f(this,void 0,void 0,(function*(){const r=t.tx.id;const{inputs:s,inRevs:o,outRevs:i,opReturns:c}=t;const a=this.wallet.getPrivateKey().toBuffer().toString("hex");return{inRevs:o,outRevs:i,inputs:s,outData:yield Promise.all(t.outData.map((t=>f(this,void 0,void 0,(function*(){const r=n?yield Zt(this.wallet)(t):t;return e?Wt(r,[a]):r}))))),opReturns:c,txId:r}}))}fromTxHex(t,e=!0,n=!0){return f(this,void 0,void 0,(function*(){const{network:r,wallet:s}=this;const o=s.getPrivateKey();let i;if("BSV"===this.chain)i=Nt.fromHexBSV(t,r,o);else{i=new Nt("BCH",r,o),i.tx.fromString(t);const e=yield s.restClient.getOutData(i.tx.id);if(!i.checkOutDataBCH(e))throw new Error("Invalid data from server in fromTxHex.");i._outData=i.addMetaData(e)}return this.fromDataTx(i,e,n)}))}fromTxId(t,e=!0,n=!0){return f(this,void 0,void 0,(function*(){const{chain:r,network:s,wallet:o}=this;const i=o.getPrivateKey();const c=yield Nt.fromTxId(t,r,s,i);return this.fromDataTx(c,e,n)}))}get(t,e,n){return f(this,void 0,void 0,(function*(){const r=t.map(A);return Promise.all(r.map((({txId:t,outIndex:r})=>f(this,void 0,void 0,(function*(){const{outData:s,opReturns:o}=yield this.fromTxId(t,e,n);const[{__vouts:i}]=o;return s[Et(r,i)]})))))}))}put(t){return this.update([],t)}update(t,e){return f(this,void 0,void 0,(function*(){const{chain:n,network:r,wallet:s}=this;const o=s.getPrivateKey();const i=new Nt(n,r,o);const c=e.map((t=>{var{_owners:e}=t,n=h(t,["_owners"]);return Object.assign({_owners:e||[this.wallet.getPublicKey().toString()]},n)})).map(Mt);const a=yield Promise.all(c.map(qt(this.wallet)));const u=yield i.spendFromData(t);const d=a.map(i.createDataOut.bind(i));i.createOpReturnOut({__vins:u,__vouts:d});const l=yield this.wallet.fundAndSendTransaction(i,!0);return jt(d).map((t=>`${l}:${t}`))}))}}function zt(t){const e=t;for(let t=e.length-1;t>0;t-=1){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}}class Qt{constructor(t,e,n={}){const{path:r="m/44'/0'/0'/0",passphrase:s=""}=n;let o=t.toHDPrivateKey(s,S.NETWORK);r&&(o=o.derive(r));const i=o.publicKey.toAddress(e.network);this.mnemonic=t,this.restClient=e,this.path=r,this.passphrase=s,this.hdPrivateKey=o,this.address=i}get chain(){return this.restClient.chain}get network(){return this.restClient.network}getMnemonic(){return this.mnemonic}getPath(){return this.path}derive(t="0"){const e=`${this.path}${this.path.length>0?"/":""}${t}`;return new Qt(this.mnemonic,this.restClient,{path:e})}getPrivateKey(){return this.hdPrivateKey.privateKey}getPublicKey(){return this.hdPrivateKey.publicKey}getAddress(){return this.address}getBalance(){return f(this,void 0,void 0,(function*(){return this.restClient.getBalance(this.getAddress())}))}getUtxos(t=this.getAddress()){return f(this,void 0,void 0,(function*(){return this.restClient.getUtxosFromAddress(t)}))}selectUtxos(t,e){let n=0;const r=[];zt(t);for(let s=0;s<t.length;s+=1){const o=t[s];if(n+=o.satoshis,r.push(o),n>=e)return r}throw new Error(`Insufficient balance in address ${this.getAddress().toString()} on ${S.NETWORK} ${S.CHAIN}. Found ${n}, required ${e}.`)}fundAndSendTransaction(t,n=!1){return f(this,void 0,void 0,(function*(){t.tx.feePerKb(S.DEFAULT_FEE);const r=t.tx._getInputAmount();const s=t.tx._getOutputAmount()-r+(t.tx._estimateFee()+100);if(s>0){const n=yield this.getUtxos(this.getAddress());this.selectUtxos(n,s).forEach((n=>{t.tx.from([new e.UnspentOutput(n)])}))}t.tx.change(this.getAddress()),t.tx.sign(this.getPrivateKey());const o=yield this.restClient.sendTransaction(t.tx.toString());return n&&(yield this.storeResult(o,t)),o}))}storeResult(t,e){return f(this,void 0,void 0,(function*(){const{outData:n,inputs:r,inRevs:s,outRevs:o}=e;const i=JSON.stringify(n);yield this.restClient.postOutData({outData:i,txId:t,inputs:r,inRevs:s,outRevs:o})}))}send(t,e){return f(this,void 0,void 0,(function*(){const n=new Nt(this.chain,this.network,this.getPrivateKey());return n.tx.to(e,t),this.fundAndSendTransaction(n)}))}}class Xt{constructor(t={}){if(void 0===t.bbsUrl){if("livenet"===t.network)throw new Error('Bitcoincomputer.io does not support mainnet Bitcoin networks by default.\n          Please either use testnet or provide a self-managed Bitcoin Broadcast Server by setting the "bbsUrl" option.');t.chain&&!["BSV","BCH"].includes(t.chain)&&console.log("Chain not set when calling new Computer({ ... }), defaulting to BSV"),t.network&&!["livenet","testnet"].includes(t.network)&&console.log("Network not set when calling new Computer({ ... }), defaulting to testnet")}t.bbsUrl&&S.setBbsUrl(t.bbsUrl);const e=t.chain||S.CHAIN||"BSV";const n=t.network||S.NETWORK||"testnet";const r=t.mnemonic||new i(t.seed);const s=t.path||"m/44'/0'/0'/0";const o=t.passphrase||"";const c=I(r,{path:s,passphrase:o});const a=new K(e,n,c);const u=t.db||new Gt(new Qt(r,a,{path:s,passphrase:o}));this.db=u}get chain(){return this.db.chain}get network(){return this.db.network}parseContract(t){const e=t.startsWith("export ")?t.slice(7):t;const n=e.startsWith("default ")?e.slice(8):e;return eval(`(${n})`)}new(t,e){return f(this,void 0,void 0,(function*(){const n=t.toString();const r=yield this.parseContract(n);const s=new gt(this.db);const o=yield s.construct(r,e);return new Proxy(o,s)}))}sync(t){return f(this,void 0,void 0,(function*(){C(t);const e=new pt(this.db);const n=new gt(this.db);const r=yield e.get(t);return new Proxy(r,n)}))}getOwnedRevs(t=this.db.wallet.getPublicKey()){return this.db.wallet.restClient.getOwnedRevs(t)}queryRevs(t){return f(this,void 0,void 0,(function*(){const{publicKey:e,contractName:n,contractHash:r}=t;const s=e?new o(e):void 0;return this.db.wallet.restClient.queryRevs({publicKey:s,contractName:n,contractHash:r})}))}getRevs(t=this.db.wallet.getPublicKey()){return f(this,void 0,void 0,(function*(){return(yield this.getOwnedRevs(t)).map((({txId:t,outIndex:e})=>`${t}:${e}`))}))}getLatestRev(t){return this.db.wallet.restClient.getLatestRev(t)}getLatestRevs(t){return this.db.wallet.restClient.getLatestRevs(t)}}var Yt=(t,e,r)=>f(void 0,void 0,void 0,(function*(){let s;if("BSV"===t)s=Nt.fromHexBSV(r,e,new n);else{s=new Nt("BCH",e,new n),s.tx.fromString(r);const o=new K(t,e,new n);const i=yield o.getOutData(s.tx.id);if(!s.checkOutDataBCH(i))throw new Error("Invalid data from server in parseOutputData.");s._outData=s.addMetaData(i)}return{txId:s.tx.id,outData:JSON.stringify(s.outData),inputs:s.tx.toJSON().inputs.map((t=>`${t.prevTxId}:${t.outputIndex}`))}}));export{Xt as Computer,Yt as parseOutData};
