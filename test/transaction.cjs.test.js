"use strict";var t=require("bitcoin-computer-bitcore");var e=require("axios");var n=require("crypto");var o=require("crypto-js");var r=require("eciesjs");var s=require("http");var i=require("https");var a=require("url");function c(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}function u(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(n){if("default"!==n){var o=Object.getOwnPropertyDescriptor(t,n);Object.defineProperty(e,n,o.get?o:{enumerable:!0,get:function(){return t[n]}})}})),e.default=t,Object.freeze(e)}require("util"),require("ses");var d=c(e);var p=c(n);var l=c(o);var f=u(r);var h=c(s);var g=c(i);var w=c(a);function x(t,e){var n={};for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&e.indexOf(o)<0&&(n[o]=t[o]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(o=Object.getOwnPropertySymbols(t);r<o.length;r++)e.indexOf(o[r])<0&&Object.prototype.propertyIsEnumerable.call(t,o[r])&&(n[o[r]]=t[o[r]])}return n}function b(t,e,n,o){var r,s=arguments.length,i=s<3?e:null===o?o=Object.getOwnPropertyDescriptor(e,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(t,e,n,o);else for(var a=t.length-1;a>=0;a--)(r=t[a])&&(i=(s<3?r(i):s>3?r(e,n,i):r(e,n))||i);return s>3&&i&&Object.defineProperty(e,n,i),i}function v(t,e,n,o){return new(n||(n=Promise))((function(r,s){function i(t){try{c(o.next(t))}catch(t){s(t)}}function a(t){try{c(o.throw(t))}catch(t){s(t)}}function c(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(i,a)}c((o=o.apply(t,e||[])).next())}))}const S=process.env.CHAIN||"LTC";const m=process.env.NETWORK||"testnet";const _=process.env.BCN_URL||"https://node.bitcoincomputer.io";const O=parseInt(process.env.BC_DUST_LIMIT||"",10)||1546;const y=parseInt(process.env.BC_DEFAULT_FEE||"",10)||2500;var B={CHAIN:S,NETWORK:m,BCN_URL:_,MIN_NON_DUST_AMOUNT:O,SCRIPT_CHUNK_SIZE:parseInt(process.env.BC_SCRIPT_CHUNK_SIZE||"",10)||479,DEFAULT_FEE:y,SIGHASH_ALL:1,FEE_PER_KB:2e4,PUBLIC_KEY_SIZE:65,ANYONE_CAN_SPEND_SEED:"replace this seed",PASSPHRASE:"",ENCODING_LENGTH:3,ENCODING_NUMBER_LENGTH:3,MAX_PUBKEYS_PER_SCRIPT:3,OP_RETURN_SIZE:80};const{crypto:I}=t.Bitcoin;const T=(t,e)=>{const n=Date.now();const o=I.Hash.sha256(Buffer.from(e+n));const r=[I.ECDSA.sign(o,t,"big").toString("hex"),t.publicKey.toString(),n];return`Bearer ${Buffer.from(r.join(":")).toString("base64")}`};const{Transaction:E}=t.Bitcoin;function N(t){return v(this,void 0,void 0,(function*(){if(!function(t){return void 0!==t.config}(t))throw new Error("Unknown error");const{message:e,config:n,response:o}=t;const r=function(t){try{const e=JSON.parse(t);if("object"!=typeof e)throw new Error("Invalid object");if("string"!=typeof e.txhex)throw new Error("Invalid object");return new E(e.txhex)}catch(t){return null}}(null==n?void 0:n.data);const s=`message\t${e}`;const i=`request\t${null==n?void 0:n.method} ${null==n?void 0:n.url}`;const a=r?`transaction\t ${JSON.stringify(r.toJSON(),null,2)}`:"";const c="post"===(null==n?void 0:n.method)?`data\t${null==n?void 0:n.data}`:"";const u=o?`response\t${JSON.stringify(o.data)}`:"";const d=r?a:c;throw t.message=`\n    Communication Error\n    ${s}\n    ${i}\n    ${d}\n    ${u}`,t}))}class P{constructor(t,e,n={}){this.baseUrl=t,this.headers=n,this.privateKey=e}get(t){return v(this,void 0,void 0,(function*(){const e=`${this.baseUrl}${t}`;try{let t={};return this.privateKey&&(t={Authentication:T(this.privateKey,this.baseUrl)}),(yield d.default.get(e,{headers:Object.assign(Object.assign({},this.headers),t)})).data}catch(t){return N(t)}}))}post(t,e){return v(this,void 0,void 0,(function*(){const n=`${this.baseUrl}${t}`;try{let t={};return this.privateKey&&(t={Authentication:T(this.privateKey,this.baseUrl)}),(yield d.default.post(n,e,{headers:Object.assign(Object.assign({},this.headers),t)})).data}catch(t){return N(t)}}))}delete(t){return v(this,void 0,void 0,(function*(){const e=`${this.baseUrl}${t}`;try{let t={};return this.privateKey&&(t={Authentication:T(this.privateKey,this.baseUrl)}),(yield d.default.delete(e,{headers:Object.assign(Object.assign({},this.headers),t)})).data}catch(t){return N(t)}}))}}const{PrivateKey:R,Transaction:A}=t.Bitcoin;function C(t){if(!/^[0-9A-Fa-f]{64}$/.test(t))throw new Error(`Invalid txId: ${t}`)}function U(t){if(!/^[0-9A-Fa-f]{64}\/\d+$/.test(t))throw new Error(`Invalid outId: ${t}`)}function D(t){U(t);const[e,n]=t.split("/");return{txId:e,outputIndex:parseInt(n,10)}}let j=class{constructor(t,e=new R){this.nodeConfig=t,this.bcn=new P(t.url,e)}get chain(){return this.nodeConfig.chain}get network(){return this.nodeConfig.network}getBalance(t){return v(this,void 0,void 0,(function*(){const{chain:e,network:n}=this;return yield this.bcn.get(`/v1/${e}/${n}/address/${t}/balance`)}))}getTransaction(t){return v(this,void 0,void 0,(function*(){return new A(yield this.getRawTx(t))}))}getRawTx(t){return v(this,void 0,void 0,(function*(){C(t);const{chain:e,network:n}=this;return this.bcn.get(`/v1/${e}/${n}/tx/${t}`)}))}getRawTxData(t){return v(this,void 0,void 0,(function*(){C(t);const{chain:e,network:n}=this;return this.bcn.get(`/v1/${e}/${n}/tx-data/${t}`)}))}getTransactions(t){return v(this,void 0,void 0,(function*(){return(yield this.getRawTxs(t)).map((t=>new A(t)))}))}getRawTxs(t){return v(this,void 0,void 0,(function*(){t.map(C);const{chain:e,network:n}=this;return this.bcn.post(`/v1/${e}/${n}/tx/bulk/`,{txIds:t})}))}sendTransaction(t){return v(this,void 0,void 0,(function*(){return this.bcn.post(`/v1/${this.chain}/${this.network}/tx/send`,{rawTx:t})}))}getUtxosFromAddress(t){return v(this,void 0,void 0,(function*(){const{chain:e,network:n}=this;return this.bcn.get(`/v1/${e}/${n}/wallet/${t.toString()}/utxos`)}))}postNonStandardUtxo(t){return v(this,void 0,void 0,(function*(){const{chain:e,network:n}=this;return this.bcn.post(`/v1/${e}/${n}/non-standard-utxo`,t)}))}getOwnedRevs(t){return v(this,void 0,void 0,(function*(){const{chain:e,network:n}=this;return this.bcn.get(`/v1/${e}/${n}/wallet/${t.toString()}/non-standard-utxos`)}))}queryRevs(t){return v(this,void 0,void 0,(function*(){const{publicKey:e,contractName:n,contractHash:o}=t;if(void 0===e&&void 0===n&&void 0===o)throw new Error("Filter parameter for queryRevs endpoint cannot be empty.");let r="";e&&(r+=`?publicKey=${e}`),n&&(r+=0===r.length?"?":"&",r+=`contractName=${n}`),o&&(r+=0===r.length?"?":"&",r+=`contractHash=${o}`);const{chain:s,network:i}=this;return this.bcn.get(`/v1/${s}/${i}/non-standard-utxos${r}`)}))}getLatestRev(t){return v(this,void 0,void 0,(function*(){U(t);const{chain:e,network:n}=this;const[{rev:o}]=yield this.bcn.get(`/v1/${e}/${n}/rev/${t}`);return o}))}getLatestRevs(t){return v(this,void 0,void 0,(function*(){t.map(U),t.map(U);const{chain:e,network:n}=this;return yield this.bcn.post(`/v1/${e}/${n}/revs`,{ids:t})}))}static getSecretOutput({_url:t,privateKey:e}){return v(this,void 0,void 0,(function*(){const n=t.split("/");const o=n[n.length-1];const r=n.slice(0,-2).join("/");const s=new P(r,e);return{host:r,data:yield s.get(`/v1/store/${o}`)}}))}static setSecretOutput({secretOutput:t,host:e,privateKey:n}){return v(this,void 0,void 0,(function*(){return new P(e,n).post("/v1/store/",t)}))}static deleteSecretOutput({_url:t,privateKey:e}){return v(this,void 0,void 0,(function*(){const n=t.split("/");const o=n[n.length-1];const r=n.slice(0,-2).join("/");const s=new P(r,e);yield s.delete(`/v1/store/${o}`)}))}};j=b([t=>t],j);const{PublicKey:H,crypto:M}=t.Bitcoin;const{Point:k}=M;function L(t){return Buffer.from(t,"hex").toString().replace(/\0/g,"")}function K(t,e,n){if(t.length*Math.log2(e)>53)throw new Error(`Input too large ${t.length} ${Math.log2(e)}`);if(![2,10,16].includes(e)||![2,10,16].includes(n))throw new Error("ToBase or FromBase invalid in covertNumber.");if(2===e&&t.length%8!=0)throw new Error("Binary strings must be byte aligned.");if(16===e&&t.length%2!=0)throw new Error("Hex strings must be of even length.");const o=parseInt(t,e).toString(n);return 2===n?o.padStart(8*Math.ceil(o.length/8),"0"):16===n?o.padStart(2*Math.ceil(o.length/2),"0"):o}function $(t,e){const n=new RegExp(`.{1,${e}}`,"g");return t.match(n)||[]}function q(t){return $(t,2).map((t=>K(t,16,2))).join("")}function F(t){return $(t,8).map((t=>K(t,2,16))).join("")}function G(t){return t.toString(16).padStart(B.ENCODING_NUMBER_LENGTH,"0")}function W(t){return parseInt(t,16)}function J(t){if(62!==t.length)throw new Error("Input to hexToPublicKey must be of length 62");let e=!1;let n=0;let o;for(;!e;){if(n>=256)throw new Error("Something went wrong storing data");const i=n.toString(16).padStart(2,"0")+F((s=n,(r=q(t).padStart(64,"0")).slice(s)+r.slice(0,s)));try{o=k.fromX(!1,i),e=!0}catch(t){n+=1}}var r,s;if(!o)throw new Error("Something went wrong storing data");return new H(o)}function Y(t){const e=t.point.getX().toString("hex").padStart(64,"0");const n=K(e.slice(0,2),16,10);return F((r=parseInt(n,10),(o=q(e.slice(2))).slice(-r)+o.slice(0,-r)));var o,r}const{PublicKey:V,Script:z}=t.Bitcoin;function Z(t){if(t.length>B.MAX_PUBKEYS_PER_SCRIPT)throw new Error("Too many owners");return function(t){const e=new z;return e.add("OP_1"),t.forEach((t=>{e.add(t)})),e.add(`OP_${t.length}`),e.add("OP_CHECKMULTISIG"),e}(t.map((t=>t.toBuffer())))}function X(t){return function(t){return t.chunks.filter((t=>t.buf)).map((t=>t.buf))}(t).map((t=>V.fromBuffer(t)))}function Q(t){return Buffer.from(l.default.SHA256(t).toString(),"hex").toString("hex").substr(0,4)}function tt(t){return`${Q(t)};${t}`}function et(t){const e=t.substr(0,4);const n=t.substr(5);if(!function(t,e){return Q(t)===e}(n,e))throw new Error("Decryption failure");return n}function nt(t){if(void 0!==t._readers){const{_readers:e,_url:n,_owners:o,_amount:r}=t,s=x(t,["_readers","_url","_owners","_amount"]);const i=function(t,e){const n=p.default.randomBytes(32).toString("hex");const o=function(t,e){if(!/^[0-9a-f]{64}$/.test(e))throw new Error("Invalid secret");const n=Buffer.from(e,"hex").toString("binary");const o=tt(t);return l.default.AES.encrypt(o,n).toString()}(t,n);const r=e.map((t=>function(t,e){if(!/^0[2-3][0-9a-f]{64}|04[0-9a-f]{128}$/.test(e))throw new Error("Invalid publicKey");const n=tt(t);return f.encrypt(e,Buffer.from(n,"utf8")).toString("base64")}(n,t)));return{__cypher:o,__secrets:r}}(JSON.stringify(s),e);return void 0!==n&&(i._url=n),void 0!==o&&(i._owners=o),void 0!==r&&(i._amount=r),i}return t}const{Transaction:ot}=t.Bitcoin;const{Output:rt}=ot;const{UnspentOutput:st}=ot;let at=class{constructor(t,e,n){const o=new ot(n);o.feePerKb(B.FEE_PER_KB),this.nodeConfig=t,this.tx=o,this.outData=[],this.privateKey=e}get txId(){return this.tx.id}get chain(){return this.nodeConfig.chain}get network(){return this.nodeConfig.network}get restClient(){return new j(this.nodeConfig,this.privateKey)}get inputs(){return this.tx.inputs.map((t=>`${t.prevTxId.toString("hex")}/${t.outputIndex}`))}get inRevs(){const{enc:t}=this;let[e]=t;return e=Number.isFinite(e)?e:0,this.tx.inputs.slice(0,e).map((({prevTxId:t,outputIndex:e})=>`${t.toString("hex")}/${e}`))}get outRevs(){const{enc:t}=this;let[,e]=t;return e=Number.isFinite(e)?e:0,Array.from(Array(e).keys()).map((t=>`${this.tx.id}/${t}`))}get opReturns(){try{const{outputs:t}=this.tx;return t.filter((({script:t})=>t.isDataOut())).map((({script:t})=>t.getData())).map((t=>t.toString())).join()}catch(t){return""}}get enc(){return $(this.opReturns.slice(0,B.ENCODING_LENGTH*B.ENCODING_NUMBER_LENGTH),B.ENCODING_NUMBER_LENGTH).map(W)}get dataPrefix(){return this.opReturns.slice(9)}getOwnerOutputs(){const{enc:t}=this;const[,e=0]=t;return this.tx.outputs.slice(0,e)}getDataOutputs(){const{enc:t}=this;const[,e,n]=t;return this.tx.outputs.slice(e,n)}getOutData(t){return v(this,void 0,void 0,(function*(){try{const e=this.getDataOutputs().map((t=>t.script)).map((t=>X(t))).flat().map(Y).map(L).join("");const{dataPrefix:n}=this;const o=JSON.parse(n+e);const r=t.toBuffer().toString("hex");const s=this.getOwnerOutputs();if(s.length!==o.length)throw new Error("Inconsistent state");const i=s.map(((t,e)=>Object.assign(Object.assign({},o[e]),{_owners:X(t.script).map((t=>t.toString())),_amount:t.satoshis})));return Promise.all(i.map((e=>v(this,void 0,void 0,(function*(){try{const n=yield function(t){return e=>v(this,void 0,void 0,(function*(){if(function(t){return void 0!==t._url}(e)){const{_url:n}=e,o=x(e,["_url"]);const{host:r,data:s}=yield j.getSecretOutput({_url:n,privateKey:t});return Object.assign(Object.assign(Object.assign({},o),JSON.parse(s)),{_url:r})}return e}))}(t)(e);return function(t,e){if(function(t){return void 0!==t.__cypher&&void 0!==t.__secrets}(t)){const{__cypher:n,__secrets:o}=t,r=x(t,["__cypher","__secrets"]);return Object.assign(Object.assign(Object.assign({},r),JSON.parse(function({__cypher:t,__secrets:e},n){let o="";if(n.forEach((n=>{e.forEach((e=>{try{const r=function(t,e){if(!/^[0-9a-f]{64}$/.test(e))throw new Error("Invalid privateKey");return et(f.decrypt(e,Buffer.from(t,"base64")).toString("utf8"))}(e,n);o=function(t,e){if(!/^[0-9a-f]{64}$/.test(e))throw new Error("Invalid secret");const n=Buffer.from(e,"hex").toString("binary");return et(l.default.AES.decrypt(t,n).toString(l.default.enc.Utf8))}(t,r)}catch(t){const e=["Decryption failure","Unsupported state or unable to authenticate data"];if(t instanceof Error&&!e.includes(t.message))throw t}}))})),o)return o;throw new Error("Decryption failure")}({__cypher:n,__secrets:o},e))),{_readers:[]})}return t}(n,[r])}catch(t){return null}})))))}catch(t){return[]}}))}getOwners(){return this.getOwnerOutputs().map((t=>X(t.script).map((t=>t.toString()))))}getAmounts(){return this.getOwnerOutputs().map((t=>t.satoshis))}spendFromData(e){return v(this,void 0,void 0,(function*(){if(!e.length)return;const n=e.map(D);const o=n.map((t=>t.txId));const r=yield this.restClient.getTransactions(o);for(let e=0;e<n.length;e+=1){const{txId:o,outputIndex:s}=n[e];const{outputs:i}=r[e];const a=i[s];const c=Math.round(a.satoshis);const u=new t.Bitcoin.Script(a.script);const d=new st({txId:o,outputIndex:s,satoshis:c,script:u});const p=X(u).map((t=>t.toString()));this.tx.from([d],p,1)}}))}createOpReturnOut(t){this.tx.addData(JSON.stringify(t))}createDataOuts(e){e.forEach((({_amount:e,_owners:n=[]})=>{if(Array.isArray(n)&&n.length>B.MAX_PUBKEYS_PER_SCRIPT)throw new Error("Too many owners.");const o=n.map((e=>t.Bitcoin.PublicKey.fromString(e)));const r=e||B.MIN_NON_DUST_AMOUNT;const s=Z(o);this.tx.addOutput(new rt({script:s,satoshis:r}))}));const n=e.map((t=>x(t,["_amount","_owners"])));const o=B.MIN_NON_DUST_AMOUNT;const r=JSON.stringify(n);const s=B.OP_RETURN_SIZE-B.ENCODING_LENGTH*B.ENCODING_NUMBER_LENGTH;const i=r.slice(0,s);const a=function(t){var e;return function(t,e){const n=[];for(let o=0;o<t.length;o+=e)n.push(t.slice(o,o+e));return n}($((e=t,Buffer.from(e).toString("hex")),62).map((t=>t.padStart(62,"0"))).map(J),B.MAX_PUBKEYS_PER_SCRIPT).map((t=>Z(t)))}(r.slice(s));const c=G(this.tx.inputs.length)+G(this.tx.outputs.length)+G(this.tx.outputs.length+a.length);a.forEach((t=>{this.tx.addOutput(new rt({script:t,satoshis:o}))})),this.tx.addData(c+i)}static fromTxHex(t,e,n){return v(this,void 0,void 0,(function*(){const o=new this(e,n);o.tx.fromString(t);const r=yield o.getOutData(n);const s=o.getOwners();const i=o.getAmounts();return o.outData=r.map(((t,e)=>Object.assign(Object.assign({},t),{_owners:s[e],_amount:i[e]}))),o}))}static fromTxId(t,e,n){return v(this,void 0,void 0,(function*(){const o=new j(e,n);const r=yield o.getRawTx(t);return this.fromTxHex(r,e,n)}))}};at=b([t=>t],at);const{CHAIN:ct="LTC",NETWORK:ut="regtest",RPC_USER:dt,RPC_PASSWORD:pt,RPC_HOST:lt}=process.env;const ft="LTC"===process.env.CHAIN?19332:8332;var ht=Object.assign(Object.assign({},B),{CHAIN:ct,NETWORK:ut,BCN_URL:"http://127.0.0.1:3000",RPC_PROTOCOL:"http",RPC_USER:dt,RPC_PASSWORD:pt,RPC_HOST:lt,RPC_PORT:ft,TEST_ADDRESSES:"moMoH1vTgCc2dkDfGSKYPnafxy22wSqgrr;mmQEk8VwtSehRryLF8jhVapYg553hJGhNa;miKQVhZbFKSsJcQZ8eXwBQ89xNyetpN34q;mzoGRNh55y9j57TPdwRGi3nt9X4CFwpqUS;n1X6JFDyxibtdhYrc7mrkuft6o168ELFNW;mjLcig6eTZVJkgRgJFMkwrYHpfMnZ1t4kk;mfYkMQAe7afeRSkgLxAtwnMVryjLTfr95Q"});var gt=h.default;var wt=g.default;var xt=w.default;function bt(t){"string"==typeof t&&(t=function(t){var e=xt.parse(t);var n=e.hostname;var o=parseInt(e.port,10);var r=e.protocol;r=r.substring(0,r.length-1);var s=e.auth.split(":");return{host:n,port:o,protocol:r,user:s[0]?decodeURIComponent(s[0]):null,pass:s[1]?decodeURIComponent(s[1]):null}}(t)),t=t||{},this.host=t.host||"127.0.0.1",this.port=t.port||8332,this.user=t.user||"user",this.pass=t.pass||"pass",this.protocol="http"===t.protocol?gt:wt,this.batchedCalls=null,this.disableAgent=t.disableAgent||!1;var e=void 0!==t.rejectUnauthorized;this.rejectUnauthorized=!e||t.rejectUnauthorized,bt.config.log?this.log=bt.config.log:this.log=bt.loggers[bt.config.logger||"normal"]}var vt=console.log.bind(console);var St=function(){};function mt(t,e){var n=this;t=JSON.stringify(t);var o=this.user+":"+this.pass;var r=Buffer.from&&Buffer.from!==Uint8Array.from?Buffer.from(o):new Buffer(o);this.auth=r.toString("base64");var s={host:n.host,path:"/",method:"POST",port:n.port,rejectUnauthorized:n.rejectUnauthorized,agent:!n.disableAgent&&void 0};if(n.httpOptions)for(var i in n.httpOptions)s[i]=n.httpOptions[i];var a=!1;var c="Bitcoin JSON-RPC: ";var u=this.protocol.request(s,(function(t){var o="";t.on("data",(function(t){o+=t})),t.on("end",(function(){if(!a)if(a=!0,401!==t.statusCode)if(403!==t.statusCode){if(500===t.statusCode&&"Work queue depth exceeded"===o.toString("utf8")){var r=new Error("Bitcoin JSON-RPC: "+o.toString("utf8"));return r.code=429,void e(r)}var s;try{s=JSON.parse(o)}catch(r){n.log.err(r.stack),n.log.err(o),n.log.err("HTTP Status code:"+t.statusCode);var i=new Error(c+"Error Parsing JSON: "+r.message);return void e(i)}e(s.error,s)}else e(new Error(c+"Connection Rejected: 403 Forbidden"));else e(new Error(c+"Connection Rejected: 401 Unnauthorized"))}))}));u.on("error",(function(t){var n=new Error(c+"Request Error: "+t.message);a||(a=!0,e(n))})),u.setHeader("Content-Length",t.length),u.setHeader("Content-Type","application/json"),u.setHeader("Authorization","Basic "+n.auth),u.write(t),u.end()}bt.loggers={none:{info:St,warn:St,err:St,debug:St},normal:{info:vt,warn:vt,err:vt,debug:St},debug:{info:vt,warn:vt,err:vt,debug:vt}},bt.config={logger:"normal"},bt.prototype.batch=function(t,e){this.batchedCalls=[],t(),mt.call(this,this.batchedCalls,e),this.batchedCalls=null},bt.callspec={abandonTransaction:"str",abortRescan:"",addMultiSigAddress:"",addNode:"",analyzePSBT:"str",backupWallet:"",bumpFee:"str",clearBanned:"",combinePSBT:"obj",combineRawTransaction:"obj",convertToPSBT:"str",createMultiSig:"",createPSBT:"obj",createRawTransaction:"obj obj",createWallet:"str",decodePSBT:"str",decodeScript:"str",decodeRawTransaction:"",deriveAddresses:"str",disconnectNode:"",dumpPrivKey:"",dumpWallet:"str",encryptWallet:"",enumerateSigners:"",estimateFee:"",estimateSmartFee:"int str",estimatePriority:"int",generate:"int",generateBlock:"str obj",generateToAddress:"int str",generateToDescriptor:"int str",getAccount:"",getAccountAddress:"str",getAddedNodeInfo:"",getAddressMempool:"obj",getAddressUtxos:"obj",getAddressBalance:"obj",getAddressDeltas:"obj",getAddressesByLabel:"str",getAddressInfo:"str",getAddressTxids:"obj",getAddressesByAccount:"",getBalance:"str int",getBalances:"",getBestBlockHash:"",getBlockDeltas:"str",getBlock:"str int",getBlockchainInfo:"",getBlockCount:"",getBlockFilter:"str",getBlockHashes:"int int obj",getBlockHash:"int",getBlockHeader:"str",getBlockNumber:"",getBlockStats:"str",getBlockTemplate:"",getConnectionCount:"",getChainTips:"",getChainTxStats:"",getDescriptorInfo:"str",getDifficulty:"",getGenerate:"",getHashesPerSec:"",getIndexInfo:"",getInfo:"",getMemoryInfo:"",getMemoryPool:"",getMemPoolAncestors:"str",getMemPoolDescendants:"str",getMemPoolEntry:"str",getMemPoolInfo:"",getMiningInfo:"",getNetTotals:"",getNetworkHashPS:"",getNetworkInfo:"",getNewAddress:"str str",getNodeAddresses:"",getPeerInfo:"",getRawChangeAddress:"",getRawMemPool:"bool",getRawTransaction:"str int",getReceivedByAccount:"str int",getReceivedByAddress:"str int",getReceivedByLabel:"str",getRpcInfo:"",getSpentInfo:"obj",getTransaction:"",getTxOut:"str int bool",getTxOutProof:"",getTxOutSetInfo:"",getUnconfirmedBalance:"",getWalletInfo:"",getWork:"",getZmqNotifications:"",finalizePSBT:"str",fundRawTransaction:"str",help:"",importAddress:"str str bool",importDescriptors:"str",importMulti:"obj obj",importPrivKey:"str str bool",importPrunedFunds:"str, str",importPubKey:"str",importWallet:"str",invalidateBlock:"str",joinPSBTs:"obj",keyPoolRefill:"",listAccounts:"int",listAddressGroupings:"",listBanned:"",listDescriptors:"",listLabels:"",listLockUnspent:"bool",listReceivedByAccount:"int bool",listReceivedByAddress:"int bool",listReceivedByLabel:"",listSinceBlock:"str int",listTransactions:"str int int",listUnspent:"int int",listWalletDir:"",listWallets:"",loadWallet:"str",lockUnspent:"",logging:"",move:"str str float int str",ping:"",preciousBlock:"str",prioritiseTransaction:"str float int",pruneBlockChain:"int",psbtBumpFee:"str",removePrunedFunds:"str",reScanBlockChain:"",saveMemPool:"",send:"obj",setHDSeed:"",setLabel:"str str",setWalletFlag:"str",scanTxOutSet:"str",sendFrom:"str str float int str str",sendMany:"str obj int str",sendRawTransaction:"str",sendToAddress:"str float str str",setAccount:"",setBan:"str str",setNetworkActive:"bool",setGenerate:"bool int",setTxFee:"float",signMessage:"",signMessageWithPrivKey:"str str",signRawTransaction:"",signRawTransactionWithKey:"str obj",signRawTransactionWithWallet:"str",stop:"",submitBlock:"str",submitHeader:"str",testMemPoolAccept:"obj",unloadWallet:"",upgradeWallet:"",uptime:"",utxoUpdatePSBT:"str",validateAddress:"",verifyChain:"",verifyMessage:"",verifyTxOutProof:"str",walletCreateFundedPSBT:"",walletDisplayAddress:"str",walletLock:"",walletPassPhrase:"string int",walletPassphraseChange:"",walletProcessPSBT:"str"};var _t=function(t,e,n){return Array.prototype.slice.call(t,e,n)};function Ot(){return parseInt(1e5*Math.random())}!function(t,e,n){function o(t,e){return function(){var o=arguments.length-1;this.batchedCalls&&(o=arguments.length);for(var r=0;r<o;r++)e[r]&&(arguments[r]=e[r](arguments[r]));this.batchedCalls?this.batchedCalls.push({jsonrpc:"2.0",method:t,params:_t(arguments),id:Ot()}):n.call(this,{method:t,params:_t(arguments,0,arguments.length-1),id:Ot()},arguments[arguments.length-1])}}var r={str:function(t){return t.toString()},int:function(t){return parseFloat(t)},float:function(t){return parseFloat(t)},bool:function(t){return!0===t||"1"==t||"true"==t||"true"==t.toString().toLowerCase()},obj:function(t){return"string"==typeof t?JSON.parse(t):t}};for(var s in e){var i=[];if(e[s].length){i=e[s].split(" ");for(var a=0;a<i.length;a++)r[i[a]]?i[a]=r[i[a]]:i[a]=r.str}var c=s.toLowerCase();t.prototype[s]=o(c,i),t.prototype[c]=t.prototype[s]}}(bt,bt.callspec,mt);const yt=["travel upgrade inside soda birth essence junk merit never twenty system opinion","hover harsh text dice wealth pill across trade soccer olive view acquire","damp comfort scan couple absurd enter slogan cheap ketchup print syrup hurdle one document diamond","notable rose silver indicate wreck mean raise together jar fish seat air","lens release coil rain forward lemon cube satisfy inject visa ring segment"];class Bt extends class{constructor(t,e){this.chain=t,this.network=e}}{constructor(t,e,n){super(t,e),this.url=n}}const{PrivateKey:It,Opcode:Tt,Script:Et,Mnemonic:Nt,crypto:Pt,Transaction:Rt,encoding:At}=t.Bitcoin;function Ct(t=0){return function(t=0){return function(t=0){return new Nt(yt[t])}(t).toHDPrivateKey("",ht.NETWORK)}(t).privateKey}function Ut(t=0){return Ct(t).toPublicKey()}function Dt(t=0){return Ut(t).toAddress()}function jt(e=1e5,n=0){const o=Et.buildPublicKeyHashOut(Dt(n));return{address:Dt(n),txid:"a477af6b2667c29670467e4e0728b685ee07b240235771862318e29ddbe58458",outputIndex:n,script:o,vout:0,amount:e/1e8,scriptPubKey:"",inspect:()=>"",toObject:()=>new t.Bitcoin.Transaction.UnspentOutput({})}}new Bt(ht.CHAIN,ht.NETWORK,ht.BCN_URL);const{PrivateKey:Ht,PublicKey:Mt,Script:kt,Transaction:Lt,Address:Kt,crypto:$t}=t.Bitcoin;const{Interpreter:qt}=kt;const{UnspentOutput:Ft,Output:Gt}=Lt;const{Signature:Wt,Point:Jt}=$t;const Yt=new Ht;const Vt=new Bt(ht.CHAIN,ht.NETWORK,ht.BCN_URL);const zt=ht.SIGHASH_ALL;const Zt=Ct(0);const Xt=Ct(1);const Qt=Ut(0);const te=Ut(1);const ee=Ut(2);const ne=[Ut(0).toString()];const oe=[Ut(1).toString()];const re={a:"a"};const se={b:"b"};const ie=ht.MIN_NON_DUST_AMOUNT;describe("DataTransaction",(()=>{describe("constructor",(()=>{const t=new at(Vt,Yt);expect(t).toBeDefined(),expect(t.chain).toBe(ht.CHAIN),expect(t.network).toBe(ht.NETWORK),expect(t.tx).toBeDefined(),expect(Array.isArray(t.tx.inputs)).toBe(!0),expect(Array.isArray(t.tx.outputs)).toBe(!0)})),describe("enc",(()=>{it("should return the encoding",(()=>{const t=new at(Vt,Yt);t.createDataOuts([re]);const{enc:e}=t;expect(e).toEqual([0,1,1])}))})),describe("opReturnString",(()=>{it("should return the opReturn string",(()=>{const t=new at(Vt,Yt);t.tx.addData("0123456789abcedf");const{dataPrefix:e}=t;expect(e).toEqual("9abcedf")}))})),describe("getOutData",(()=>{it("should return the data of a transactions with one output",(()=>v(void 0,void 0,void 0,(function*(){const t=new at(Vt,Yt);const e=[Object.assign({_owners:ne,_amount:ie},re)];t.createDataOuts(e),expect(yield t.getOutData(Zt)).toEqual(e)})))),it("should return the data of a transactions with one large output",(()=>v(void 0,void 0,void 0,(function*(){const t=[{_owners:ne,_amount:ie,a:"a".repeat(100)}];const e=new at(Vt,Yt);e.createDataOuts(t),expect(yield e.getOutData(Zt)).toEqual(t)})))),it("should return the data of a transactions with two outputs",(()=>v(void 0,void 0,void 0,(function*(){const t=new at(Vt,Yt);const e=[Object.assign({_owners:ne,_amount:ie},re),Object.assign({_owners:ne,_amount:ie},se)];t.createDataOuts(e),expect(yield t.getOutData(Zt)).toEqual(e)})))),it.only("should return the data of a transactions if some outputs are encrypted",(()=>v(void 0,void 0,void 0,(function*(){const t=new at(Vt,Yt);const e=[Object.assign({_owners:ne,_readers:ne,_amount:ie},re),Object.assign({_owners:ne,_readers:oe,_amount:ie},se)].map(nt);t.createDataOuts(e);const n=Object.assign({_owners:ne,_readers:[],_amount:ie},re);expect(yield t.getOutData(Zt)).toEqual([n,null])}))))})),describe("getOwners",(()=>{it("should return the owners of a transactions",(()=>{const t=new at(Vt,Yt);t.createDataOuts([Object.assign({_owners:ne,_amount:ie},re),Object.assign({_owners:oe,_amount:ie},re)]),expect(t.getOwners()).toEqual([ne,oe])}))})),describe("getAmounts",(()=>{it("should return the owners of a transactions",(()=>{const t=new at(Vt,Yt);t.createDataOuts([Object.assign({_owners:ne,_amount:1},re),Object.assign({_owners:oe,_amount:2},re)]),expect(t.getAmounts()).toEqual([1,2])}))})),describe("to",(()=>{it("should add a p2pkh output",(()=>{const t=new at(Vt,Yt);t.tx.from([new Lt.UnspentOutput(jt())]),t.tx.to(Dt(),ht.MIN_NON_DUST_AMOUNT),t.tx.sign(Ct(),zt),expect(t.tx.id).toEqual(expect.any(String)),expect(t.inRevs).toEqual([]),expect(t.inputs).toEqual(["a477af6b2667c29670467e4e0728b685ee07b240235771862318e29ddbe58458/0"]),expect(t.tx.outputs[0].script.isPublicKeyHashOut()).toBe(!0),expect(t.tx.verify()).toBe(!0)})),it("should add a p2sh multisig output",(()=>{const t=[Qt,te,ee];const e=Kt.createMultisig(t,2,ht.NETWORK,!1);const n=new at(Vt,Yt);n.tx.from([new Lt.UnspentOutput(jt())]),n.tx.to(e,ht.MIN_NON_DUST_AMOUNT),n.tx.sign(Ct(),zt),expect(n.tx).toBeDefined(),expect(n.tx.outputs.length).toBe(1),expect(n.tx.inputs.length).toBe(1),expect(n.tx.outputs[0].script.isScriptHashOut()).toBe(!0),expect(n.tx.verify()).toBe(!0)})),it("should add a bare multisig output",(()=>{const t=(new kt).add("OP_1").add(Qt.toBuffer()).add(te.toBuffer()).add(ee.toBuffer()).add("OP_3").add("OP_CHECKMULTISIG");const e=new at(Vt,Yt);e.tx.from([new Lt.UnspentOutput(jt())]),e.tx.addOutput(new Gt({script:t,satoshis:ht.MIN_NON_DUST_AMOUNT})),e.tx.sign(Ct(),zt),expect(e.tx).toBeDefined(),expect(e.tx.outputs.length).toBe(1),expect(e.tx.inputs.length).toBe(1),expect(e.tx.outputs[0].script.isMultisigOut()).toBe(!0),expect(e.tx.verify()).toBe(!0)})),it("should create compressed and uncompressed pk",(()=>{const t={bn:"96c132224121b509b7d0a16245e957d9192609c5637c6228311287b1be21627a",compressed:!1,network:"livenet"};const e=Ht.fromObject(t);const n={bn:"96c132224121b509b7d0a16245e957d9192609c5637c6228311287b1be21627a",compressed:!0,network:"livenet"};const o=Ht.fromObject(n);expect(JSON.stringify(e)).toBe(JSON.stringify(t)),expect(JSON.stringify(o)).toBe(JSON.stringify(n)),expect(JSON.stringify(o.publicKey)).not.toBe(JSON.stringify(e.publicKey))})),it("should work with compressed and uncompressed pk - bare multisig output",(()=>{const t=Buffer.from("0412345678901234567890123456789012345678901234567890123456789012341234567890123456789012345678901234567890123456789012345678901234","hex");const e=(new kt).add("OP_1").add(Qt.toBuffer()).add(te.toBuffer()).add(ee.toBuffer()).add(t).add(t).add(t).add(t).add(t).add(t).add(t).add(t).add(t).add(t).add("OP_3").add("OP_CHECKMULTISIG");const n=new at(Vt,Yt);n.tx.from([new Lt.UnspentOutput(jt())]),n.tx.addOutput(new Gt({script:e,satoshis:ht.MIN_NON_DUST_AMOUNT})),n.tx.sign(Ct(),zt),expect(n.tx).toBeDefined(),expect(n.tx.outputs.length).toBe(1),expect(n.tx.inputs.length).toBe(1),expect(n.tx.outputs[0].script.isMultisigOut()).toBe(!0),expect(n.tx.verify()).toBe(!0)}))})),describe("from",(()=>{it("should spend from a p2pkh output",(()=>{const t=new Ht("cSBnVM4xvxarwGQuAfQFwqDg9k5tErHUHzgWsEfD4zdwUasvqRVY");const{publicKey:e}=t;const n=e.toAddress();const o=kt.buildPublicKeyHashOut(n);const r=new Ft({address:n,txId:"a477af6b2667c29670467e4e0728b685ee07b240235771862318e29ddbe58458",outputIndex:0,script:o,satoshis:1e5});const s=(new Lt).from(r).to("mrU9pEmAx26HcbKVrABvgL7AwA5fjNFoDc",1e5).sign(t,1);const i=Wt.fromTxFormat(s.inputs[0].script.chunks[0].buf);expect(s.verifySignature(i,e,0,o)).toBe(!0);const a=s.inputs[0].script;const c=qt.SCRIPT_VERIFY_P2SH|qt.SCRIPT_VERIFY_STRICTENC;const u=(new qt).verify(a,o,s,0,c);expect(u).toEqual(!0)})),it("should spend from a p2sh output",(()=>{const t=kt.buildMultisigOut([Qt,te,ee],2,{});const e=new Ft({txId:"66e64ef8a3b384164b78453fa8c8194de9a473ba14f89485a0e433699daec140",outputIndex:0,script:t,satoshis:1e6});const n=(new Lt).from(e,[Qt.toString(),te.toString(),ee.toString()],2).to(new Kt("33zbk2aSZYdNbRsMPPt6jgy6Kq1kQreqeb"),1e6);const o=n.inputs[0];expect(o.countSignatures()).toBe(0),n.sign(Zt,ht.SIGHASH_ALL),expect(o.countSignatures()).toBe(1),expect(o.countMissingSignatures()).toBe(1),expect(o.isFullySigned()).toBe(!1),n.sign(Xt,ht.SIGHASH_ALL),expect(o.countSignatures()).toBe(2),expect(o.countMissingSignatures()).toBe(0),expect(o.isFullySigned()).toBe(!0);const r=n.inputs[0].script;const s=qt.SCRIPT_VERIFY_P2SH|qt.SCRIPT_VERIFY_STRICTENC;const i=(new qt).verify(r,t,n,0,s);expect(i).toEqual(!0)})),it("should spend from a transaction with a multisig output",(()=>{const t=[Qt,te,ee];const e=Kt.createMultisig(t,1,ht.NETWORK,!1);const n=new at(Vt,Yt);n.tx.from([new Lt.UnspentOutput(jt())]),n.tx.to(e,ht.MIN_NON_DUST_AMOUNT),n.tx.sign(Ct(),zt);const o=n.tx.outputs[0].script;const r=n.tx.outputs[0];const s=Math.round(r.satoshis);const i=new Ft({txId:n.tx.id,outputIndex:0,script:o,satoshis:s});const a=(new Lt).from(i,t.map((t=>t.toString())),1).to(e,1e6);a.sign(Zt,ht.SIGHASH_ALL);const c=a.inputs[0].script;const u=qt.SCRIPT_VERIFY_P2SH|qt.SCRIPT_VERIFY_STRICTENC;const d=(new qt).verify(c,o,a,0,u);expect(d).toEqual(!0)})),it("should spend from a transaction with a bare multisig output",(()=>{const t=(new kt).add("OP_1").add(Qt.toBuffer()).add(te.toBuffer()).add(ee.toBuffer()).add("OP_3").add("OP_CHECKMULTISIG");const e=new at(Vt,Yt);e.tx.from([new Lt.UnspentOutput(jt())]),e.tx.addOutput(new Gt({script:t,satoshis:ht.MIN_NON_DUST_AMOUNT})),e.tx.sign(Ct(),zt);const n=e.tx.outputs[0];const o=n.script;const r=Math.round(n.satoshis);const s=new Ft({txId:e.tx.id,outputIndex:0,script:o,satoshis:r});const{chunks:i}=o;const a=[new Mt(i[1].buf),new Mt(i[2].buf),new Mt(i[3].buf)];const c=(new Lt).from(s,a.map((t=>t.toString())),2).to(Dt(),1e4);c.sign(Zt,ht.SIGHASH_ALL),c.sign(Xt,ht.SIGHASH_ALL);const u=c.inputs[0].script;const d=qt.SCRIPT_VERIFY_P2SH|qt.SCRIPT_VERIFY_STRICTENC;const p=(new qt).verify(u,o,c,0,d);expect(p).toEqual(!0)})),it("should spend from an transaction with a bare multisig output with data",(()=>{const t="1".repeat(32);const e=Jt.fromX(!1,t);const n=new Mt(e);const o=(new kt).add("OP_1").add(Qt.toBuffer()).add(te.toBuffer()).add(ee.toBuffer()).add(n.toBuffer()).add("OP_4").add("OP_CHECKMULTISIG");const r=new at(Vt,Yt);r.tx.from([new Lt.UnspentOutput(jt())]),r.tx.addOutput(new Gt({script:o,satoshis:ht.MIN_NON_DUST_AMOUNT})),r.tx.sign(Ct(),zt);const s=r.tx.outputs[0];const i=s.script;const a=Math.round(s.satoshis);const c=new Ft({txId:r.tx.id,outputIndex:0,script:i,satoshis:a});const{chunks:u}=i;const d=[new Mt(u[1].buf),new Mt(u[2].buf),new Mt(u[3].buf)];const p=(new Lt).from(c,d.map((t=>t.toString())),2).to(Dt(),1e4);p.sign(Zt,ht.SIGHASH_ALL),p.sign(Xt,ht.SIGHASH_ALL);const l=p.inputs[0].script;const f=qt.SCRIPT_VERIFY_P2SH|qt.SCRIPT_VERIFY_STRICTENC;const h=(new qt).verify(l,i,p,0,f);expect(h).toEqual(!0)})),it("should spend from an transaction with a bare multisig output and dummy data",(()=>{const t=Buffer.from("11".repeat(512),"hex");const e=(new kt).add("OP_1").add(Qt.toBuffer()).add(te.toBuffer()).add(ee.toBuffer()).add(t).add("OP_4").add("OP_CHECKMULTISIG");const n=new at(Vt,Yt);n.tx.from([new Lt.UnspentOutput(jt())]),n.tx.addOutput(new Gt({script:e,satoshis:ht.MIN_NON_DUST_AMOUNT})),n.tx.sign(Ct(),zt);const o=n.tx.outputs[0];const r=o.script;const s=Math.round(o.satoshis);const i=new Ft({txId:n.tx.id,outputIndex:0,script:r,satoshis:s});const{chunks:a}=r;const c=[new Mt(a[1].buf),new Mt(a[2].buf),new Mt(a[3].buf)];const u=(new Lt).from(i,c.map((t=>t.toString())),2).to(Dt(),1e4);u.sign(Zt,ht.SIGHASH_ALL),u.sign(Xt,ht.SIGHASH_ALL);const d=u.inputs[0].script;const p=qt.SCRIPT_VERIFY_P2SH;const l=(new qt).verify(d,r,u,0,p);expect(l).toEqual(!0)})),it("should spend from an transaction with a bare multisig output and dummy data",(()=>{const t=Buffer.from("11".repeat(512),"hex");const e=(new kt).add("OP_1").add(Qt.toBuffer()).add(te.toBuffer()).add(ee.toBuffer()).add(t).add("OP_4").add("OP_CHECKMULTISIG");const n=new at(Vt,Yt);n.tx.from([new Lt.UnspentOutput(jt())]),n.tx.addOutput(new Gt({script:e,satoshis:ht.MIN_NON_DUST_AMOUNT})),n.tx.sign(Ct(),zt);const o=n.tx.outputs[0];const r=o.script;const s=Math.round(o.satoshis);const i=new Ft({txId:n.tx.id,outputIndex:0,script:r,satoshis:s});const{chunks:a}=r;const c=[new Mt(a[1].buf),new Mt(a[2].buf),new Mt(a[3].buf)];const u=(new Lt).from(i,c.map((t=>t.toString())),2).to(Dt(),1e4);u.sign(Zt,ht.SIGHASH_ALL),u.sign(Xt,ht.SIGHASH_ALL);const d=u.inputs[0].script;const p=qt.SCRIPT_VERIFY_P2SH;const l=(new qt).verify(d,r,u,0,p);expect(l).toEqual(!0)}))})),describe("createDataOuts",(()=>{it("should add a data output",(()=>{const t=new at(Vt,Yt);const e=[Ut()];const n=e.map((t=>t.toString()));const o={a:1};t.createDataOuts([Object.assign({_owners:n,_amount:ie},o)]),expect(t).toBeDefined(),expect(t.tx).toBeDefined(),expect(t.tx.outputs).toBeDefined(),expect(t.tx.outputs.length).toBe(2),expect(t.tx.outputs[0].script.toASM()).toEqual(Z(e).toASM()),expect(JSON.parse(t.dataPrefix)).toEqual([o])})),it("should add a large data output",(()=>v(void 0,void 0,void 0,(function*(){const t=new at(Vt,Yt);const e=[Ut()];const n=[{a:"1".repeat(100),_owners:e.map((t=>t.toString())),_amount:ie}];t.createDataOuts(n),expect(t).toBeDefined(),expect(t.tx).toBeDefined(),expect(t.tx.outputs).toBeDefined(),expect(t.tx.outputs.length).toBe(3),expect(t.tx.outputs[0].script.toASM()).toEqual(Z(e).toASM()),expect(yield t.getOutData(Yt)).toEqual(n)}))))})),describe("createOpReturnOut",(()=>{it("should add an op-return output",(()=>{const t=new at(Vt,Yt);t.tx.from([new Lt.UnspentOutput(jt())]),t.createOpReturnOut({enc:[0,1,2]}),t.tx.sign(Ct(),ht.SIGHASH_ALL);const{outData:e}=t;expect(e.length).toBe(0),((t,e,n)=>{t&&t.tx&&t.tx.inputs&&1===t.tx.inputs.length&&t.tx.outputs&&1===t.tx.outputs.length&&t.outData.length})(t),expect(t.tx.outputs[0].satoshis).toBe(0),expect(t.tx.id).toBe("a2053075dffec12162cc800017956fbbaf5a22714a1f6229fac78007b1e438ec"),expect(t.inRevs).toEqual([]),expect(t.inputs).toEqual(["a477af6b2667c29670467e4e0728b685ee07b240235771862318e29ddbe58458/0"])})),it("should throw an error if __vins is not set correctly",(()=>{const t=new at(Vt,Yt);t.tx.from([new Lt.UnspentOutput(jt())]),t.createOpReturnOut({enc:[0,1,2]}),t.tx.sign(Ct(),ht.SIGHASH_ALL),expect(t.inputs).toEqual(["a477af6b2667c29670467e4e0728b685ee07b240235771862318e29ddbe58458/0"]),expect(t.inRevs).toEqual([])}))}))}));
