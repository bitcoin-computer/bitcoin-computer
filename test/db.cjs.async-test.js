"use strict";var t=require("crypto");var e=require("bitcoin-computer-bitcore");var n=require("axios");var o=require("crypto-js");var s=require("eciesjs");var r=require("http");var i=require("https");var c=require("url");var a=require("util");function u(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}function l(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(n){if("default"!==n){var o=Object.getOwnPropertyDescriptor(t,n);Object.defineProperty(e,n,o.get?o:{enumerable:!0,get:function(){return t[n]}})}})),e.default=t,Object.freeze(e)}require("ses");var d=u(t);var p=u(n);var h=u(o);var g=l(s);var f=u(r);var y=u(i);var x=u(c);var v=u(a);function _(t,e){var n={};for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&e.indexOf(o)<0&&(n[o]=t[o]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var s=0;for(o=Object.getOwnPropertySymbols(t);s<o.length;s++)e.indexOf(o[s])<0&&Object.prototype.propertyIsEnumerable.call(t,o[s])&&(n[o[s]]=t[o[s]])}return n}function m(t,e,n,o){var s,r=arguments.length,i=r<3?e:null===o?o=Object.getOwnPropertyDescriptor(e,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(t,e,n,o);else for(var c=t.length-1;c>=0;c--)(s=t[c])&&(i=(r<3?s(i):r>3?s(e,n,i):s(e,n))||i);return r>3&&i&&Object.defineProperty(e,n,i),i}function w(t,e,n,o){return new(n||(n=Promise))((function(s,r){function i(t){try{a(o.next(t))}catch(t){r(t)}}function c(t){try{a(o.throw(t))}catch(t){r(t)}}function a(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(i,c)}a((o=o.apply(t,e||[])).next())}))}const b=parseInt(process.env.BC_DUST_LIMIT||"",10)||1546;const S=parseInt(process.env.BC_DEFAULT_FEE||"",10)||2500;var B={MIN_NON_DUST_AMOUNT:b,SCRIPT_CHUNK_SIZE:parseInt(process.env.BC_SCRIPT_CHUNK_SIZE||"",10)||479,DEFAULT_FEE:S,SIGHASH_ALL:1,FEE_PER_KB:2e4,PUBLIC_KEY_SIZE:65,ANYONE_CAN_SPEND_SEED:"replace this seed",PASSPHRASE:"",ENCODING_LENGTH:3,ENCODING_NUMBER_LENGTH:3,MAX_PUBKEYS_PER_SCRIPT:3,OP_RETURN_SIZE:80};const{PublicKey:E,crypto:T}=e.Bitcoin;const{Point:O}=T;function P(t){return Buffer.from(t,"hex").toString().replace(/\0/g,"")}function I(t,e){return t.slice(e)+t.slice(0,e)}function K(t,e,n){if(t.length*Math.log2(e)>53)throw new Error(`Input too large ${t.length} ${Math.log2(e)}`);if(![2,10,16].includes(e)||![2,10,16].includes(n))throw new Error("ToBase or FromBase invalid in covertNumber.");if(2===e&&t.length%8!=0)throw new Error("Binary strings must be byte aligned.");if(16===e&&t.length%2!=0)throw new Error("Hex strings must be of even length.");const o=parseInt(t,e).toString(n);return 2===n?o.padStart(8*Math.ceil(o.length/8),"0"):16===n?o.padStart(2*Math.ceil(o.length/2),"0"):o}function R(t,e){const n=new RegExp(`.{1,${e}}`,"g");return t.match(n)||[]}function N(t){return R(t,2).map((t=>K(t,16,2))).join("")}function C(t){return R(t,8).map((t=>K(t,2,16))).join("")}function j(t){return t.toString(16).padStart(B.ENCODING_NUMBER_LENGTH,"0")}function A(t){return parseInt(t,16)}function D(t){if(62!==t.length)throw new Error("Input to hexToPublicKey must be of length 62");let e=!1;let n=0;let o;for(;!e;){if(n>=256)throw new Error("Something went wrong storing data");const s=n.toString(16).padStart(2,"0")+C(I(N(t).padStart(64,"0"),n));try{o=O.fromX(!1,s),e=!0}catch(t){n+=1}}if(!o)throw new Error("Something went wrong storing data");return new E(o)}function q(t){const e=t.point.getX().toString("hex").padStart(64,"0");const n=K(e.slice(0,2),16,10);return C((s=parseInt(n,10),(o=N(e.slice(2))).slice(-s)+o.slice(0,-s)));var o,s}function k(t){return new Promise((e=>{setTimeout(e,t)}))}function $(t,e){return`m/44'/${function(t,e){if("testnet"===e||"regtest"===e)return"1";if("BTC"===t)return"0";if("LTC"===t)return"2";if("DOGE"===t)return"3";if("BCH"===t)return"145";if("BSV"===t)return"236";throw new Error(`Unsupported chain ${t}`)}(t,e)}'/0'/0/0`}const{PublicKey:U,Script:M}=e.Bitcoin;function H(t){if(t.length>B.MAX_PUBKEYS_PER_SCRIPT)throw new Error("Too many owners");return function(t){const e=new M;return e.add("OP_1"),t.forEach((t=>{e.add(t)})),e.add(`OP_${t.length}`),e.add("OP_CHECKMULTISIG"),e}(t.map((t=>t.toBuffer())))}function L(t){return function(t){return t.chunks.filter((t=>t.buf)).map((t=>t.buf))}(t).map((t=>U.fromBuffer(t)))}function G(t){return t.map((t=>L(t))).flat().map(q).map(P).join("")}const{crypto:F}=e.Bitcoin;const J=(t,e)=>{const n=Date.now();const o=F.Hash.sha256(Buffer.from(e+n));const s=[F.ECDSA.sign(o,t,"big").toString("hex"),t.publicKey.toString(),n];return`Bearer ${Buffer.from(s.join(":")).toString("base64")}`};const{Transaction:W}=e.Bitcoin;function z(t){return w(this,void 0,void 0,(function*(){if(!function(t){return void 0!==t.config}(t))throw new Error("Unknown error");const{message:e,config:n,response:o}=t;const s=function(t){try{const e=JSON.parse(t);if("object"!=typeof e)throw new Error("Invalid object");if("string"!=typeof e.txhex)throw new Error("Invalid object");return new W(e.txhex)}catch(t){return null}}(null==n?void 0:n.data);const r=`message\t${e}`;const i=`request\t${null==n?void 0:n.method} ${null==n?void 0:n.url}`;const c=s?`transaction\t ${JSON.stringify(s.toJSON(),null,2)}`:"";const a="post"===(null==n?void 0:n.method)?`data\t${null==n?void 0:n.data}`:"";const u=o?`response\t${JSON.stringify(o.data)}`:"";const l=s?c:a;throw t.message=`\n    Communication Error\n    ${r}\n    ${i}\n    ${l}\n    ${u}`,t}))}class Y{constructor(t,e,n={}){this.baseUrl=t,this.headers=n,this.privateKey=e}get(t){return w(this,void 0,void 0,(function*(){const e=`${this.baseUrl}${t}`;try{let t={};return this.privateKey&&(t={Authentication:J(this.privateKey,this.baseUrl)}),(yield p.default.get(e,{headers:Object.assign(Object.assign({},this.headers),t)})).data}catch(t){return z(t)}}))}post(t,e){return w(this,void 0,void 0,(function*(){const n=`${this.baseUrl}${t}`;try{let t={};return this.privateKey&&(t={Authentication:J(this.privateKey,this.baseUrl)}),(yield p.default.post(n,e,{headers:Object.assign(Object.assign({},this.headers),t)})).data}catch(t){return z(t)}}))}delete(t){return w(this,void 0,void 0,(function*(){const e=`${this.baseUrl}${t}`;try{let t={};return this.privateKey&&(t={Authentication:J(this.privateKey,this.baseUrl)}),(yield p.default.delete(e,{headers:Object.assign(Object.assign({},this.headers),t)})).data}catch(t){return z(t)}}))}}const{PrivateKey:Z,Transaction:X}=e.Bitcoin;const{UnspentOutput:Q}=X;function V(t){if(!/^[0-9A-Fa-f]{64}$/.test(t))throw new Error(`Invalid txId: ${t}`)}function tt(t){if(!/^[0-9A-Fa-f]{64}\/\d+$/.test(t))throw new Error(`Invalid outId: ${t}`)}function et(t){tt(t);const[e,n]=t.split("/");return{txId:e,outputIndex:parseInt(n,10)}}let nt=class{constructor(t,e=new Z){this.nodeConfig=t,this.bcn=new Y(t.url,e)}get chain(){return this.nodeConfig.chain}get network(){return this.nodeConfig.network}getBalance(t){return w(this,void 0,void 0,(function*(){const{chain:e,network:n}=this;return yield this.bcn.get(`/v1/${e}/${n}/address/${t}/balance`)}))}getTransaction(t){return w(this,void 0,void 0,(function*(){return new X(yield this.getRawTx(t))}))}getRawTx(t){return w(this,void 0,void 0,(function*(){V(t);const{chain:e,network:n}=this;return this.bcn.get(`/v1/${e}/${n}/tx/${t}`)}))}getTransactions(t){return w(this,void 0,void 0,(function*(){return(yield this.getRawTxs(t)).map((t=>new X(t)))}))}getRawTxs(t){return w(this,void 0,void 0,(function*(){t.map(V);const{chain:e,network:n}=this;return this.bcn.post(`/v1/${e}/${n}/tx/bulk/`,{txIds:t})}))}sendTransaction(t){return w(this,void 0,void 0,(function*(){return this.bcn.post(`/v1/${this.chain}/${this.network}/tx/send`,{rawTx:t})}))}getUtxosFromAddress(t){return w(this,void 0,void 0,(function*(){const{chain:e,network:n}=this;return(yield this.bcn.get(`/v1/${e}/${n}/wallet/${t.toString()}/utxos`)).map((({rev:t,scriptPubKey:e,satoshis:n})=>{const[o,s]=t.split("/");return new Q({txId:o,outputIndex:parseInt(s,10),satoshis:n,script:e})}))}))}getOwnedRevs(t){return w(this,void 0,void 0,(function*(){const{chain:e,network:n}=this;return this.bcn.get(`/v1/${e}/${n}/wallet/${t.toString()}/non-standard-utxos`)}))}queryRevs(t){return w(this,void 0,void 0,(function*(){const{publicKey:e,contractName:n,contractHash:o}=t;if(void 0===e&&void 0===n&&void 0===o)throw new Error("Filter parameter for queryRevs endpoint cannot be empty.");let s="";e&&(s+=`?publicKey=${e}`),n&&(s+=0===s.length?"?":"&",s+=`contractName=${n}`),o&&(s+=0===s.length?"?":"&",s+=`contractHash=${o}`);const{chain:r,network:i}=this;return this.bcn.get(`/v1/${r}/${i}/non-standard-utxos${s}`)}))}getLatestRev(t){return w(this,void 0,void 0,(function*(){tt(t);const{chain:e,network:n}=this;const[{rev:o}]=yield this.bcn.get(`/v1/${e}/${n}/rev/${t}`);return o}))}getLatestRevs(t){return w(this,void 0,void 0,(function*(){t.map(tt),t.map(tt);const{chain:e,network:n}=this;return yield this.bcn.post(`/v1/${e}/${n}/revs`,{ids:t})}))}static getSecretOutput({_url:t,privateKey:e}){return w(this,void 0,void 0,(function*(){const n=t.split("/");const o=n[n.length-1];const s=n.slice(0,-2).join("/");const r=new Y(s,e);return{host:s,data:yield r.get(`/v1/store/${o}`)}}))}static setSecretOutput({secretOutput:t,host:e,privateKey:n}){return w(this,void 0,void 0,(function*(){return new Y(e,n).post("/v1/store/",t)}))}static deleteSecretOutput({_url:t,privateKey:e}){return w(this,void 0,void 0,(function*(){const n=t.split("/");const o=n[n.length-1];const s=n.slice(0,-2).join("/");const r=new Y(s,e);yield r.delete(`/v1/store/${o}`)}))}};function ot(t){return Buffer.from(h.default.SHA256(t).toString(),"hex").toString("hex").substr(0,4)}function st(t){return`${ot(t)};${t}`}function rt(t){const e=t.substr(0,4);const n=t.substr(5);if(!function(t,e){return ot(t)===e}(n,e))throw new Error("Decryption failure");return n}function ct(t){if(void 0!==t._readers){const{_readers:e,_url:n,_owners:o,_amount:s}=t,r=_(t,["_readers","_url","_owners","_amount"]);const i=function(t,e){const n=d.default.randomBytes(32).toString("hex");const o=function(t,e){if(!/^[0-9a-f]{64}$/.test(e))throw new Error("Invalid secret");const n=Buffer.from(e,"hex").toString("binary");const o=st(t);return h.default.AES.encrypt(o,n).toString()}(t,n);const s=e.map((t=>function(t,e){if(!/^0[2-3][0-9a-f]{64}|04[0-9a-f]{128}$/.test(e))throw new Error("Invalid publicKey");const n=st(t);return g.encrypt(e,Buffer.from(n,"utf8")).toString("base64")}(n,t)));return{__cypher:o,__secrets:s}}(JSON.stringify(r),e);return void 0!==n&&(i._url=n),void 0!==o&&(i._owners=o),void 0!==s&&(i._amount=s),i}return t}nt=m([t=>t],nt);const{Transaction:at}=e.Bitcoin;const{Output:ut}=at;const{UnspentOutput:lt}=at;let dt=class{constructor(t,e,n){const o=new at(n);o.feePerKb(B.FEE_PER_KB),this.nodeConfig=t,this.tx=o,this.outData=[],this.privateKey=e}get txId(){return this.tx.id}get chain(){return this.nodeConfig.chain}get network(){return this.nodeConfig.network}get restClient(){return new nt(this.nodeConfig,this.privateKey)}get inputs(){return this.tx.inputs.map((t=>`${t.prevTxId.toString("hex")}/${t.outputIndex}`))}get inRevs(){const{enc:t}=this;let[e]=t;return e=Number.isFinite(e)?e:0,this.tx.inputs.slice(0,e).map((({prevTxId:t,outputIndex:e})=>`${t.toString("hex")}/${e}`))}get outRevs(){const{enc:t}=this;let[,e]=t;return e=Number.isFinite(e)?e:0,Array.from(Array(e).keys()).map((t=>`${this.tx.id}/${t}`))}get opReturns(){try{const{outputs:t}=this.tx;return t.filter((({script:t})=>t.isDataOut())).map((({script:t})=>t.getData())).map((t=>t.toString())).join()}catch(t){return""}}get enc(){return R(this.opReturns.slice(0,B.ENCODING_LENGTH*B.ENCODING_NUMBER_LENGTH),B.ENCODING_NUMBER_LENGTH).map(A)}get dataPrefix(){return this.opReturns.slice(9)}getOwnerOutputs(){const{enc:t}=this;const[,e=0]=t;return this.tx.outputs.slice(0,e)}getDataOutputs(){const{enc:t}=this;const[,e,n]=t;return this.tx.outputs.slice(e,n)}getOutData(t){return w(this,void 0,void 0,(function*(){try{const e=G(this.getDataOutputs().map((t=>t.script)));const{dataPrefix:n}=this;const o=JSON.parse(n+e);const s=t.toBuffer().toString("hex");const r=this.getOwnerOutputs();if(r.length!==o.length)throw new Error("Inconsistent state");const i=r.map(((t,e)=>Object.assign(Object.assign({},o[e]),{_owners:L(t.script).map((t=>t.toString())),_amount:t.satoshis})));return Promise.all(i.map((e=>w(this,void 0,void 0,(function*(){try{const n=yield function(t){return e=>w(this,void 0,void 0,(function*(){if(function(t){return void 0!==t._url}(e)){const{_url:n}=e,o=_(e,["_url"]);const{host:s,data:r}=yield nt.getSecretOutput({_url:n,privateKey:t});return Object.assign(Object.assign(Object.assign({},o),JSON.parse(r)),{_url:s})}return e}))}(t)(e);return function(t,e){if(function(t){return void 0!==t.__cypher&&void 0!==t.__secrets}(t)){const{__cypher:n,__secrets:o}=t,s=_(t,["__cypher","__secrets"]);return Object.assign(Object.assign(Object.assign({},s),JSON.parse(function({__cypher:t,__secrets:e},n){let o="";if(n.forEach((n=>{e.forEach((e=>{try{const s=function(t,e){if(!/^[0-9a-f]{64}$/.test(e))throw new Error("Invalid privateKey");return rt(g.decrypt(e,Buffer.from(t,"base64")).toString("utf8"))}(e,n);o=function(t,e){if(!/^[0-9a-f]{64}$/.test(e))throw new Error("Invalid secret");const n=Buffer.from(e,"hex").toString("binary");return rt(h.default.AES.decrypt(t,n).toString(h.default.enc.Utf8))}(t,s)}catch(t){const e=["Decryption failure","Unsupported state or unable to authenticate data"];if(t instanceof Error&&!e.includes(t.message))throw t}}))})),o)return o;throw new Error("Decryption failure")}({__cypher:n,__secrets:o},e))),{_readers:[]})}return t}(n,[s])}catch(t){return null}})))))}catch(t){return[]}}))}getOwners(){return this.getOwnerOutputs().map((t=>L(t.script).map((t=>t.toString()))))}getAmounts(){return this.getOwnerOutputs().map((t=>t.satoshis))}spendFromData(t){return w(this,void 0,void 0,(function*(){if(!t.length)return;const n=t.map(et);const o=n.map((t=>t.txId));const s=yield this.restClient.getTransactions(o);for(let t=0;t<n.length;t+=1){const{txId:o,outputIndex:r}=n[t];const{outputs:i}=s[t];const c=i[r];const a=Math.round(c.satoshis);const u=new e.Bitcoin.Script(c.script);const l=new lt({txId:o,outputIndex:r,satoshis:a,script:u});const d=L(u).map((t=>t.toString()));this.tx.from([l],d,1)}}))}createOpReturnOut(t){this.tx.addData(JSON.stringify(t))}createDataOuts(t){t.forEach((({_amount:t,_owners:n=[]})=>{if(Array.isArray(n)&&n.length>B.MAX_PUBKEYS_PER_SCRIPT)throw new Error("Too many owners.");const o=n.map((t=>e.Bitcoin.PublicKey.fromString(t)));const s=t||B.MIN_NON_DUST_AMOUNT;const r=H(o);this.tx.addOutput(new ut({script:r,satoshis:s}))}));const n=t.map((t=>_(t,["_amount","_owners"])));const o=B.MIN_NON_DUST_AMOUNT;const s=JSON.stringify(n);const r=B.OP_RETURN_SIZE-B.ENCODING_LENGTH*B.ENCODING_NUMBER_LENGTH;const i=s.slice(0,r);const c=function(t){var e;return function(t,e){const n=[];for(let o=0;o<t.length;o+=e)n.push(t.slice(o,o+e));return n}(R((e=t,Buffer.from(e).toString("hex")),62).map((t=>t.padStart(62,"0"))).map(D),B.MAX_PUBKEYS_PER_SCRIPT).map((t=>H(t)))}(s.slice(r));const a=j(this.tx.inputs.length)+j(this.tx.outputs.length)+j(this.tx.outputs.length+c.length);c.forEach((t=>{this.tx.addOutput(new ut({script:t,satoshis:o}))})),this.tx.addData(a+i)}static fromTxHex(t,e,n){return w(this,void 0,void 0,(function*(){const o=new this(e,n);o.tx.fromString(t);let s=[];let r=[];let i=[];try{s=yield o.getOutData(n)}catch(t){}try{r=o.getOwners()}catch(t){}try{i=o.getAmounts()}catch(t){}return o.outData=s.map(((t,e)=>Object.assign(Object.assign({},t),{_owners:r[e],_amount:i[e]}))),o}))}static fromTxId(t,e,n){return w(this,void 0,void 0,(function*(){const o=new nt(e,n);const s=yield o.getRawTx(t);return this.fromTxHex(s,e,n)}))}};dt=m([t=>t],dt);class pt{constructor(t){this.wallet=t}get chain(){return this.wallet.chain}get network(){return this.wallet.network}get nodeConfig(){return this.wallet.nodeConfig}fromTxHex(t){return w(this,void 0,void 0,(function*(){const{wallet:e,nodeConfig:n}=this;const o=e.getPrivateKey();return dt.fromTxHex(t,n,o)}))}fromTxId(t){return w(this,void 0,void 0,(function*(){const{wallet:e,nodeConfig:n}=this;const o=new nt(n,e.getPrivateKey());const s=yield o.getRawTx(t);return this.fromTxHex(s)}))}get(t){return w(this,void 0,void 0,(function*(){const e=t.map(et);return Promise.all(e.map((({txId:t,outputIndex:e})=>w(this,void 0,void 0,(function*(){const{outData:n}=yield this.fromTxId(t);if(e>n.length)throw new Error("Index out of bounds");return n[e]})))))}))}put(t){return this.update([],t)}createTx(t,e){return w(this,void 0,void 0,(function*(){const{wallet:n,nodeConfig:o}=this;const s=n.getPrivateKey();const r=new dt(o,s);const i=e.map((t=>{var{_owners:e}=t,n=_(t,["_owners"]);return Object.assign({_owners:e||[this.wallet.getPublicKey().toString()]},n)})).map(ct);const c=yield Promise.all(i.map(function(t){return e=>w(this,void 0,void 0,(function*(){if(void 0!==e._url){const{_url:n,_owners:o,_amount:s}=e,r=_(e,["_url","_owners","_amount"]);const i=yield nt.setSecretOutput({host:n,secretOutput:{data:JSON.stringify(r)},privateKey:t});return void 0!==o&&(i._owners=o),void 0!==s&&(i._amount=s),i}return e}))}(s)));return yield r.spendFromData(t),yield r.createDataOuts(c),r}))}update(t,e){return w(this,void 0,void 0,(function*(){const n=yield this.createTx(t,e);return yield this.wallet.fundAndSendTransaction(n),n.outRevs}))}}class ht{constructor(t,e,n={}){const{chain:o,network:s}=e;const{path:r=$(o,s),passphrase:i=""}=n;let c=t.toHDPrivateKey(i,s);r&&(c=c.derive(r));const a=c.publicKey.toAddress(s);this.mnemonic=t,this.restClient=e,this.path=r,this.passphrase=i,this.hdPrivateKey=c,this.address=a}get chain(){return this.restClient.chain}get network(){return this.restClient.network}get nodeConfig(){return this.restClient.nodeConfig}getMnemonic(){return this.mnemonic}derive(t="0"){const e=`${this.path}${this.path.length>0?"/":""}${t}`;return new ht(this.mnemonic,this.restClient,{path:e})}getPrivateKey(){return this.hdPrivateKey.privateKey}getPublicKey(){return this.hdPrivateKey.publicKey}getAddress(){return this.address}getBalance(){return w(this,void 0,void 0,(function*(){return this.restClient.getBalance(this.getAddress())}))}getUtxos(t=this.getAddress()){return w(this,void 0,void 0,(function*(){return this.restClient.getUtxosFromAddress(t)}))}selectUtxos(t,e){let n=0;const o=[];!function(t){const e=t;for(let t=e.length-1;t>0;t-=1){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}}(t);for(let s=0;s<t.length;s+=1){const r=t[s];if(n+=r.satoshis,o.push(r),n>=e)return o}const{network:s,chain:r}=this.restClient.nodeConfig;throw new Error(`Insufficient balance in address ${this.getAddress().toString()} on ${s} ${r}. Found ${n}, required ${e}.`)}fundAndSendTransaction(t){return w(this,void 0,void 0,(function*(){t.tx.feePerKb(B.FEE_PER_KB);const{chain:n,network:o}=this.nodeConfig;const{enc:s}=t;const[,r=0]=s;const i=r*function(t){if("LTC"===t)return 8e3;if("BTC"===t)return 22;if("DOGE"===t)return 7e6;if("BCH"===t)return 2700;throw new Error(`Unsupported chain ${t}`)}(n);const c=.001*t.tx._getOutputAmount();const a=Math.max(B.MIN_NON_DUST_AMOUNT,i+c);t.tx.to(function(t,e){const n={"any-testnet":"gLjNGbKQzxqKA9bv2nhn1Ewf7rxYVXgrtR","BTC-mainnet":"84ZHRqRPTcUv6AFGMVC1KmSUeC9Y8SNfMm","LTC-mainnet":"mov5ivrsqWut5ffZhiz18uAkwy2D4y98iz","DOGE-mainnet":"1MVukPYmWdbEoxy3Sqq1ES4nYqDfpB5e68","BCH-mainnet":"P9CmJszhvARfQc8YjUW1K2oBnus1ZQWEqk","BSV-mainnet":"G2wxQ74zX48WMo7sfiX1faGGNQB8ebVth"};return I("testnet"===e||"regtest"===e?n["any-testnet"]:n[`${t}-${e}`],19)}(n,o),Math.round(a));let u=t.tx._getInputAmount();const l=t.tx._getOutputAmount();const d=t.tx._estimateFee();let p=l-u+Math.round(d);if(p>0){const n=yield this.getUtxos();this.selectUtxos(n,p).forEach((n=>{t.tx.from([new e.Bitcoin.Transaction.UnspentOutput(n)])})),u=t.tx._getInputAmount(),p=l-u+Math.round(t.tx._estimateFee())}return t.tx.change(this.getAddress()),t.tx.sign(this.getPrivateKey(),B.SIGHASH_ALL),yield this.restClient.sendTransaction(t.tx.toString())}))}send(t,e){return w(this,void 0,void 0,(function*(){const n=new dt(this.restClient.nodeConfig,this.getPrivateKey());return n.tx.to(e,t),this.fundAndSendTransaction(n)}))}}var gt={CHAIN:process.env.CHAIN||"LTC",NETWORK:process.env.NETWORK||"testnet",BCN_URL:process.env.BCN_URL||"https://node.bitcoincomputer.io"};const{CHAIN:ft="LTC",NETWORK:yt="regtest",RPC_USER:xt,RPC_PASSWORD:vt,RPC_HOST:_t}=process.env;const mt="LTC"===process.env.CHAIN?19332:8332;var wt=Object.assign(Object.assign({},gt),{CHAIN:ft,NETWORK:yt,BCN_URL:"http://127.0.0.1:3000",RPC_PROTOCOL:"http",RPC_USER:xt,RPC_PASSWORD:vt,RPC_HOST:_t,RPC_PORT:mt,TEST_ADDRESSES:"mwADSUHvPCGrrX4ozP8Kcd5JCWK93rnc8h;moMoH1vTgCc2dkDfGSKYPnafxy22wSqgrr;mmQEk8VwtSehRryLF8jhVapYg553hJGhNa;miKQVhZbFKSsJcQZ8eXwBQ89xNyetpN34q;mzoGRNh55y9j57TPdwRGi3nt9X4CFwpqUS;n1X6JFDyxibtdhYrc7mrkuft6o168ELFNW;mjLcig6eTZVJkgRgJFMkwrYHpfMnZ1t4kk;mfYkMQAe7afeRSkgLxAtwnMVryjLTfr95Q"});var bt=f.default;var St=y.default;var Bt=x.default;function Et(t){"string"==typeof t&&(t=function(t){var e=Bt.parse(t);var n=e.hostname;var o=parseInt(e.port,10);var s=e.protocol;s=s.substring(0,s.length-1);var r=e.auth.split(":");return{host:n,port:o,protocol:s,user:r[0]?decodeURIComponent(r[0]):null,pass:r[1]?decodeURIComponent(r[1]):null}}(t)),t=t||{},this.host=t.host||"127.0.0.1",this.port=t.port||8332,this.user=t.user||"user",this.pass=t.pass||"pass",this.protocol="http"===t.protocol?bt:St,this.batchedCalls=null,this.disableAgent=t.disableAgent||!1;var e=void 0!==t.rejectUnauthorized;this.rejectUnauthorized=!e||t.rejectUnauthorized,Et.config.log?this.log=Et.config.log:this.log=Et.loggers[Et.config.logger||"normal"]}var Tt=console.log.bind(console);var Ot=function(){};function Pt(t,e){var n=this;t=JSON.stringify(t);var o=this.user+":"+this.pass;var s=Buffer.from&&Buffer.from!==Uint8Array.from?Buffer.from(o):new Buffer(o);this.auth=s.toString("base64");var r={host:n.host,path:"/",method:"POST",port:n.port,rejectUnauthorized:n.rejectUnauthorized,agent:!n.disableAgent&&void 0};if(n.httpOptions)for(var i in n.httpOptions)r[i]=n.httpOptions[i];var c=!1;var a="Bitcoin JSON-RPC: ";var u=this.protocol.request(r,(function(t){var o="";t.on("data",(function(t){o+=t})),t.on("end",(function(){if(!c)if(c=!0,401!==t.statusCode)if(403!==t.statusCode){if(500===t.statusCode&&"Work queue depth exceeded"===o.toString("utf8")){var s=new Error("Bitcoin JSON-RPC: "+o.toString("utf8"));return s.code=429,void e(s)}var r;try{r=JSON.parse(o)}catch(s){n.log.err(s.stack),n.log.err(o),n.log.err("HTTP Status code:"+t.statusCode);var i=new Error(a+"Error Parsing JSON: "+s.message);return void e(i)}e(r.error,r)}else e(new Error(a+"Connection Rejected: 403 Forbidden"));else e(new Error(a+"Connection Rejected: 401 Unnauthorized"))}))}));u.on("error",(function(t){var n=new Error(a+"Request Error: "+t.message);c||(c=!0,e(n))})),u.setHeader("Content-Length",t.length),u.setHeader("Content-Type","application/json"),u.setHeader("Authorization","Basic "+n.auth),u.write(t),u.end()}Et.loggers={none:{info:Ot,warn:Ot,err:Ot,debug:Ot},normal:{info:Tt,warn:Tt,err:Tt,debug:Ot},debug:{info:Tt,warn:Tt,err:Tt,debug:Tt}},Et.config={logger:"normal"},Et.prototype.batch=function(t,e){this.batchedCalls=[],t(),Pt.call(this,this.batchedCalls,e),this.batchedCalls=null},Et.callspec={abandonTransaction:"str",abortRescan:"",addMultiSigAddress:"",addNode:"",analyzePSBT:"str",backupWallet:"",bumpFee:"str",clearBanned:"",combinePSBT:"obj",combineRawTransaction:"obj",convertToPSBT:"str",createMultiSig:"",createPSBT:"obj",createRawTransaction:"obj obj",createWallet:"str",decodePSBT:"str",decodeScript:"str",decodeRawTransaction:"",deriveAddresses:"str",disconnectNode:"",dumpPrivKey:"",dumpWallet:"str",encryptWallet:"",enumerateSigners:"",estimateFee:"",estimateSmartFee:"int str",estimatePriority:"int",generate:"int",generateBlock:"str obj",generateToAddress:"int str",generateToDescriptor:"int str",getAccount:"",getAccountAddress:"str",getAddedNodeInfo:"",getAddressMempool:"obj",getAddressUtxos:"obj",getAddressBalance:"obj",getAddressDeltas:"obj",getAddressesByLabel:"str",getAddressInfo:"str",getAddressTxids:"obj",getAddressesByAccount:"",getBalance:"str int",getBalances:"",getBestBlockHash:"",getBlockDeltas:"str",getBlock:"str int",getBlockchainInfo:"",getBlockCount:"",getBlockFilter:"str",getBlockHashes:"int int obj",getBlockHash:"int",getBlockHeader:"str",getBlockNumber:"",getBlockStats:"str",getBlockTemplate:"",getConnectionCount:"",getChainTips:"",getChainTxStats:"",getDescriptorInfo:"str",getDifficulty:"",getGenerate:"",getHashesPerSec:"",getIndexInfo:"",getInfo:"",getMemoryInfo:"",getMemoryPool:"",getMemPoolAncestors:"str",getMemPoolDescendants:"str",getMemPoolEntry:"str",getMemPoolInfo:"",getMiningInfo:"",getNetTotals:"",getNetworkHashPS:"",getNetworkInfo:"",getNewAddress:"str str",getNodeAddresses:"",getPeerInfo:"",getRawChangeAddress:"",getRawMemPool:"bool",getRawTransaction:"str int",getReceivedByAccount:"str int",getReceivedByAddress:"str int",getReceivedByLabel:"str",getRpcInfo:"",getSpentInfo:"obj",getTransaction:"",getTxOut:"str int bool",getTxOutProof:"",getTxOutSetInfo:"",getUnconfirmedBalance:"",getWalletInfo:"",getWork:"",getZmqNotifications:"",finalizePSBT:"str",fundRawTransaction:"str",help:"",importAddress:"str str bool",importDescriptors:"str",importMulti:"obj obj",importPrivKey:"str str bool",importPrunedFunds:"str, str",importPubKey:"str",importWallet:"str",invalidateBlock:"str",joinPSBTs:"obj",keyPoolRefill:"",listAccounts:"int",listAddressGroupings:"",listBanned:"",listDescriptors:"",listLabels:"",listLockUnspent:"bool",listReceivedByAccount:"int bool",listReceivedByAddress:"int bool",listReceivedByLabel:"",listSinceBlock:"str int",listTransactions:"str int int",listUnspent:"int int",listWalletDir:"",listWallets:"",loadWallet:"str",lockUnspent:"",logging:"",move:"str str float int str",ping:"",preciousBlock:"str",prioritiseTransaction:"str float int",pruneBlockChain:"int",psbtBumpFee:"str",removePrunedFunds:"str",reScanBlockChain:"",saveMemPool:"",send:"obj",setHDSeed:"",setLabel:"str str",setWalletFlag:"str",scanTxOutSet:"str",sendFrom:"str str float int str str",sendMany:"str obj int str",sendRawTransaction:"str",sendToAddress:"str float str str",setAccount:"",setBan:"str str",setNetworkActive:"bool",setGenerate:"bool int",setTxFee:"float",signMessage:"",signMessageWithPrivKey:"str str",signRawTransaction:"",signRawTransactionWithKey:"str obj",signRawTransactionWithWallet:"str",stop:"",submitBlock:"str",submitHeader:"str",testMemPoolAccept:"obj",unloadWallet:"",upgradeWallet:"",uptime:"",utxoUpdatePSBT:"str",validateAddress:"",verifyChain:"",verifyMessage:"",verifyTxOutProof:"str",walletCreateFundedPSBT:"",walletDisplayAddress:"str",walletLock:"",walletPassPhrase:"string int",walletPassphraseChange:"",walletProcessPSBT:"str"};var It=function(t,e,n){return Array.prototype.slice.call(t,e,n)};function Kt(){return parseInt(1e5*Math.random())}!function(t,e,n){function o(t,e){return function(){var o=arguments.length-1;this.batchedCalls&&(o=arguments.length);for(var s=0;s<o;s++)e[s]&&(arguments[s]=e[s](arguments[s]));this.batchedCalls?this.batchedCalls.push({jsonrpc:"2.0",method:t,params:It(arguments),id:Kt()}):n.call(this,{method:t,params:It(arguments,0,arguments.length-1),id:Kt()},arguments[arguments.length-1])}}var s={str:function(t){return t.toString()},int:function(t){return parseFloat(t)},float:function(t){return parseFloat(t)},bool:function(t){return!0===t||"1"==t||"true"==t||"true"==t.toString().toLowerCase()},obj:function(t){return"string"==typeof t?JSON.parse(t):t}};for(var r in e){var i=[];if(e[r].length){i=e[r].split(" ");for(var c=0;c<i.length;c++)s[i[c]]?i[c]=s[i[c]]:i[c]=s.str}var a=r.toLowerCase();t.prototype[r]=o(a,i),t.prototype[a]=t.prototype[r]}}(Et,Et.callspec,Pt);var Rt=Et;const Nt=["travel upgrade inside soda birth essence junk merit never twenty system opinion","hover harsh text dice wealth pill across trade soccer olive view acquire","damp comfort scan couple absurd enter slogan cheap ketchup print syrup hurdle one document diamond","notable rose silver indicate wreck mean raise together jar fish seat air","lens release coil rain forward lemon cube satisfy inject visa ring segment"];class Ct extends class{constructor(t,e){this.chain=t,this.network=e}}{constructor(t,e,n){super(t,e),this.url=n}}const{PrivateKey:jt,Opcode:At,Script:Dt,Mnemonic:qt,crypto:kt,Transaction:$t,encoding:Ut}=e.Bitcoin;const{CHAIN:Mt,NETWORK:Ht,BCN_URL:Lt}=wt;function Gt(t=0){return new qt(Nt[t])}function Ft(t=0){return function(t=0){return function(t=0){return Gt(t).toHDPrivateKey("",Ht).derive($(Mt,Ht))}(t).privateKey}(t).toPublicKey()}function Jt(t=0){return Ft(t).toAddress()}new Ct(Mt,Ht,Lt);const Wt=()=>w(void 0,void 0,void 0,(function*(){const t=(()=>{const t=wt.RPC_PROTOCOL;const e=wt.RPC_USER;const n=wt.RPC_PASSWORD;const o=wt.RPC_HOST;const s=wt.RPC_PORT;return new Rt({protocol:t,user:e,pass:n,host:o,port:s})})();const e=v.default.promisify(Rt.prototype.generateToAddress.bind(t));yield e(1,Jt(0)),yield e(1,Jt(1)),yield e(1,Jt(2)),yield e(1,Jt(3)),yield e(1,Jt(4)),yield e(100,(new qt).toHDPrivateKey("",Ht).derive($(Mt,Ht)).privateKey.toPublicKey().toAddress())}));const{CHAIN:zt,NETWORK:Yt,BCN_URL:Zt}=wt;const{MIN_NON_DUST_AMOUNT:Xt}=B;const Qt=new Ct(zt,Yt,Zt);const Vt=Gt(0);const te=Gt(1);const ee=new nt(Qt,((t,e,n={})=>{const{path:o,passphrase:s}=n;let r=t.toHDPrivateKey(s,e);return o&&(r=r.derive(o)),r.privateKey})(Vt,Qt.network));describe("Db",(()=>{describe("fromTxHex",(()=>{it("should work for a transaction with a data output",(()=>w(void 0,void 0,void 0,(function*(){yield Wt();const t=new ht(Vt,ee);const e=new pt(t);const n=t.getPrivateKey();const[o]=yield t.getUtxos();const s={a:1,_owners:[t.getPublicKey().toString()],_amount:Xt};const r=new dt(Qt,n);r.createDataOuts([s]),r.tx.from(o),r.tx.sign(n,B.SIGHASH_ALL),yield t.fundAndSendTransaction(r);const i=r.tx.toString();yield k(2e3);const c=yield e.fromTxHex(i);expect(c.inRevs).toEqual([]),expect(c.outRevs).toEqual(expect.any(Array)),expect(c.inputs).toEqual([expect.any(String)]),expect(c.outData).toEqual([s]),expect(c.opReturns).toEqual('000001001[{"a":1}]'),expect(c.txId).toEqual(expect.any(String))}))),2e4),it("should work for a transaction with an encrypted output",(()=>w(void 0,void 0,void 0,(function*(){yield Wt();const t=new ht(Vt,ee);const e=new pt(t);const n=t.getPrivateKey();const[o]=yield t.getUtxos();const s=t.getPublicKey();const r={a:1,_owners:[s.toString()],_readers:[s.toString()],_amount:Xt};const i=new dt(Qt,n);i.createDataOuts([r]),i.tx.from(o),i.tx.sign(n,B.SIGHASH_ALL),yield t.fundAndSendTransaction(i),yield k(2e3);const c=i.tx.toString();const a=yield e.fromTxHex(c);expect(a.inRevs).toEqual([]),expect(a.outRevs).toEqual(expect.any(Array)),expect(a.inputs[0]).toEqual(expect.any(String)),expect(a.inputs.length).toBeGreaterThan(0),expect(a.outData).toEqual([r]),expect(a.opReturns).toEqual('000001002[{"a":1,"_readers":["0325b72ed21cbed59ea3f8927a414eeda417e2c3984c169431'),expect(a.txId).toEqual(expect.any(String))}))),2e4)})),describe("get",(()=>{it("should retrieve an small object from the blockchain",(()=>w(void 0,void 0,void 0,(function*(){yield Wt();const t=new ht(Vt,ee);const e=new pt(t);const n=yield e.put([{a:"a",b:"b"}]);yield k(2e3),expect(n.length).toBe(1);const o=yield e.get(n);expect(o).toEqual([{a:"a",b:"b",_owners:[t.getPublicKey().toString()],_amount:Xt}])}))),2e4),it("should set default amount",(()=>w(void 0,void 0,void 0,(function*(){yield Wt();const t=new ht(Vt,ee);const e=new pt(t);const n=yield e.put([{a:"a",b:"b"}]);yield k(2e3);const o=yield e.get(n);expect(o).toEqual([{a:"a",b:"b",_amount:Xt,_owners:[t.getPublicKey().toString()]}])}))),2e4),it("should retrieve an encrypted object from the blockchain",(()=>w(void 0,void 0,void 0,(function*(){yield Wt();const t=new ht(Vt,ee);const e=[{a:"a",b:"b",_readers:[t.getPublicKey().toString()]}];const n=new pt(t);const o=yield n.put(e);yield k(2e3);const s=yield n.get(o);expect(s).toEqual([{a:"a",b:"b",_readers:[],_amount:expect.any(Number),_owners:[t.getPublicKey().toString()]}])}))),2e4),it("should retrieve an off-chain object from the blockchain",(()=>w(void 0,void 0,void 0,(function*(){yield Wt();const t=new ht(Vt,ee);const e={a:"a",b:"b",A:class{constructor(){this._url="http://127.0.0.1:3000"}}.toString(),_url:"http://127.0.0.1:3000"};const n=new pt(t);const o=yield n.put([e]);yield k(2e3);const s=yield n.get(o);expect(s).toEqual([Object.assign(Object.assign({},e),{_owners:[t.getPublicKey().toString()],_amount:Xt})])}))),2e4),it("should retrieve multiple small objects from the blockchain",(()=>w(void 0,void 0,void 0,(function*(){yield Wt();const t=new ht(Vt,ee);const e=t.derive("0").getPublicKey().toString();const n=t.derive("1").getPublicKey().toString();const o=t.derive("2").getPublicKey().toString();const s={a:"a",_owners:[e],__cls:`class ${d.default.randomBytes(32).toString("hex")} {\n            constructor(n) {\n                this.n = n;\n            }\n            inc(n) {\n                this.n += n;\n                return this.n;\n            }\n        }`};const r={b:"b",_owners:[n],__cls:`class ${d.default.randomBytes(32).toString("hex")} {\n            constructor(n) {\n                this.n = n;\n            }\n            inc(n) {\n                this.n += n;\n                return this.n;\n            }\n        }`};const i={c:"c",_owners:[o],__cls:`class ${d.default.randomBytes(32).toString("hex")} {\n            constructor(n) {\n                this.n = n;\n            }\n            inc(n) {\n                this.n += n;\n                return this.n;\n            }\n        }`};const c=[s,r,i];const a=[s,r];const u=new pt(t);const l=yield yield u.put(c);yield k(3e3);const p=yield u.put(a);yield k(3e3);const h=l.concat(p);const g=yield u.get(h);expect(g).toEqual([{a:"a",_owners:[e],_amount:Xt,__cls:s.__cls},{b:"b",_owners:[n],_amount:Xt,__cls:r.__cls},{c:"c",_owners:[o],_amount:Xt,__cls:i.__cls},{a:"a",_owners:[e],_amount:Xt,__cls:s.__cls},{b:"b",_owners:[n],_amount:Xt,__cls:r.__cls}])}))),2e6),it("should retrieve a large object from the blockchain",(()=>w(void 0,void 0,void 0,(function*(){yield Wt();const t=new ht(Vt,ee);const e=t.getPublicKey().toString();const n="a".repeat(Math.min(B.SCRIPT_CHUNK_SIZE,500));const o=[{a:n,_owners:[e]}];const s=new pt(t);const r=yield s.put(o);yield k(2e3);const[i]=yield s.get(r);expect(i).toStrictEqual({a:n,_owners:[e],_amount:Xt}),expect(i._owners&&i._owners[0].toString()).toBe(e.toString())}))),2e4),it("should retrieve multiple large objects from the blockchain",(()=>w(void 0,void 0,void 0,(function*(){yield Wt();const t=new ht(Vt,ee);const e=d.default.randomBytes(32).toString("hex");const n=d.default.randomBytes(32).toString("hex");const o=d.default.randomBytes(32).toString("hex");const s={a:"a".repeat(1e3),_owners:[t.derive("0").getPublicKey().toString()],__cls:`class ${e} {\n            constructor(n) {\n                this.n = n;\n            }\n            inc(n) {\n                this.n += n;\n                return this.n;\n            }\n        }`};const r={b:"b".repeat(471),_owners:[t.derive("1").getPublicKey().toString()],__cls:`class ${n} {\n            constructor(n) {\n                this.n = n;\n            }\n            inc(n) {\n                this.n += n;\n                return this.n;\n            }\n        }`};const i=[s,r,{c:"c".repeat(1e3),_owners:[t.derive("2").getPublicKey().toString()],__cls:`class ${o} {\n            constructor(n) {\n                this.n = n;\n            }\n            inc(n) {\n                this.n += n;\n                return this.n;\n            }\n        }`}];const c=[s,r];const a=i.concat(c);const u=new pt(t);const l=yield u.put(i);expect(l.length).toBe(3),yield k(2e3);const p=yield u.put(c);expect(p.length).toBe(2),yield k(2e3);const h=l.concat(p);expect(h.length).toBe(5);const g=yield u.get(h);expect(g.length).toBe(5),g.forEach(((t,e)=>{expect(t.toString()).toEqual(a[e].toString())}))}))),2e5),it("should set __vins and __vouts correctly",(()=>w(void 0,void 0,void 0,(function*(){yield Wt();const t=new ht(Vt,ee);const e=new pt(t);const n=t.getPublicKey().toString();const o={a:"a".repeat(500),_owners:[n],_amount:Xt};const[s,r]=yield e.put([o,o]);expect(s).toBeDefined(),expect(r).toBeDefined();const i=s.split("/")[0];yield k(2e3);const c=yield dt.fromTxId(i,Qt,t.getPrivateKey());expect(c.tx.inputs.length).toBeGreaterThanOrEqual(1),expect(c.tx.outputs.length).toBeGreaterThanOrEqual(4);const a=yield e.fromTxId(i);expect(a.txId).toEqual(i),expect(a.inputs).toEqual(expect.any(Array)),expect(a.inRevs).toEqual([]),expect(a.outRevs).toEqual([s,r]),expect(a.outData).toEqual([o,o]),expect(a.opReturns).toBe('00000200d[{"a":"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa');const[u,l]=yield e.update([s,r],[o,o]);const[d,p]=u.split("/");const[h,g]=l.split("/");expect(d).toBe(h),expect(p).toBe("0"),expect(g).toBe("1"),yield k(2e3);const f=yield dt.fromTxId(d,Qt,t.getPrivateKey());expect(f.tx.inputs.length).toBeGreaterThanOrEqual(2),expect(f.tx.outputs.length).toBeGreaterThanOrEqual(5);const y=yield e.fromTxId(d);expect(y.txId).toEqual(d),expect(y.inputs).toEqual(expect.any(Array)),expect(y.inRevs).toEqual([s,r]),expect(y.outRevs).toEqual([u,l]),expect(y.outData).toEqual([o,o]),expect(y.opReturns).toBe('00200200d[{"a":"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa'),yield k(3e3);const x=yield ee.getLatestRev(s);expect(x).toBeDefined();const v=yield ee.getLatestRev(r);expect(v).toBeDefined()}))),24e4)})),describe("createTx",(()=>{it("should work with a small object",(()=>w(void 0,void 0,void 0,(function*(){yield Wt();const t=new ht(Vt,ee);const e=new pt(t);const n=yield e.createTx([],[{a:"a"}]);expect(n).toBeDefined(),expect(n.tx).toBeDefined(),expect(n.tx.outputs).toBeDefined(),expect(n.tx.inputs).toBeDefined(),expect(n.tx.outputs.length).toBe(2),expect(yield n.getOutData(t.getPrivateKey())).toEqual([{a:"a",_amount:B.MIN_NON_DUST_AMOUNT,_owners:[t.getPublicKey().toString()]}])}))),2e4)})),describe("put",(()=>{it("should store a json object",(()=>w(void 0,void 0,void 0,(function*(){yield Wt();const t=new ht(Vt,ee);const e={a:"a",b:"b"};const n=new pt(t);const o=yield n.put([e]);expect(o).toEqual([expect.any(String)]);const[s,r]=o[0].split("/");expect(s.length).toBe(64),expect(r).toBe("0"),yield k(2e3);const i=yield dt.fromTxId(s,Qt,t.getPrivateKey());expect(i.tx.inputs).toBeDefined(),expect(i.tx.inputs.length).toBeGreaterThanOrEqual(1),expect(i.tx.outputs).toBeDefined(),expect(i.tx.outputs.length).toBe(4);const{outData:c}=i;expect(c).toEqual([Object.assign({_owners:[n.wallet.getPublicKey().toString()],_amount:Xt},e)]);const a=yield dt.fromTxId(s,Qt,t.getPrivateKey());const{opReturns:u,enc:l}=a;const[,d,p]=l;const h=(u+G(a.tx.outputs.slice(d,p).map((t=>t.script)))).substring(9);const g=JSON.parse(h);expect(g).toEqual([e]);const f=Object.keys(g[0]);expect(f.includes("_owners")).toBe(!1),expect(f.includes("_amount")).toBe(!1),expect(f.includes("_readers")).toBe(!1)}))),6e4),it("should store a json object with an amount set",(()=>w(void 0,void 0,void 0,(function*(){yield Wt();const t=new ht(Vt,ee);const e={_amount:Xt+1,a:"a",b:"b"};const n=new pt(t);const o=yield n.put([e]);expect(o).toEqual([expect.any(String)]);const[s,r]=o[0].split("/");expect(s.length).toBe(64),expect(r).toBe("0"),yield k(2e3);const i=yield dt.fromTxId(s,Qt,t.getPrivateKey());expect(i.tx.inputs).toBeDefined(),expect(i.tx.inputs.length).toBeGreaterThanOrEqual(1),expect(i.tx.outputs).toBeDefined(),expect(i.tx.outputs.length).toBe(4);const{outData:c}=i;const a=_(e,["_amount"]);expect(c).toEqual([Object.assign({_owners:[expect.any(String)],_amount:Xt+1},a)]);const u=yield dt.fromTxId(s,Qt,t.getPrivateKey());const{opReturns:l,enc:d}=u;const[,p,h]=d;const g=(l+G(u.tx.outputs.slice(p,h).map((t=>t.script)))).substring(9);const f=JSON.parse(g);expect(f).toEqual([a]);const y=Object.keys(f[0]);expect(y.includes("_owners")).toBe(!1),expect(y.includes("_amount")).toBe(!1),expect(y.includes("_readers")).toBe(!1)}))),6e4),it("should store a json object with an owner set",(()=>w(void 0,void 0,void 0,(function*(){yield Wt();const t=new ht(Vt,ee);const e={_owners:[t.getPublicKey().toString()],a:"a",b:"b"};const n=new pt(t);const o=yield n.put([e]);expect(o).toEqual([expect.any(String)]);const[s,r]=o[0].split("/");expect(s.length).toBe(64),expect(r).toBe("0"),yield k(2e3);const i=yield dt.fromTxId(s,Qt,t.getPrivateKey());expect(i.tx.inputs).toBeDefined(),expect(i.tx.inputs.length).toBeGreaterThanOrEqual(1),expect(i.tx.outputs).toBeDefined(),expect(i.tx.outputs.length).toBe(4);const{outData:c}=i;expect(c).toEqual([Object.assign({_amount:Xt},e)]);const a=_(e,["_owners"]);const u=yield dt.fromTxId(s,Qt,t.getPrivateKey());const{opReturns:l,enc:d}=u;const[,p,h]=d;const g=(l+G(u.tx.outputs.slice(p,h).map((t=>t.script)))).substring(9);const f=JSON.parse(g);expect(f).toEqual([a]);const y=Object.keys(f[0]);expect(y.includes("_owners")).toBe(!1),expect(y.includes("_amount")).toBe(!1),expect(y.includes("_readers")).toBe(!1)}))),6e4),it("should store a json object with more than one owner",(()=>w(void 0,void 0,void 0,(function*(){yield Wt();const t=new ht(Vt,ee);const e=t.getPublicKey().toString();const n=new ht(te,ee);const o={_owners:[e,n.getPublicKey().toString()],a:"a",b:"b"};const s=new pt(t);const r=yield s.put([o]);expect(r).toEqual([expect.any(String)]);const[i,c]=r[0].split("/");expect(i.length).toBe(64),expect(c).toBe("0"),yield k(2e3);const a=yield dt.fromTxId(i,Qt,n.getPrivateKey());expect(a.tx.inputs).toBeDefined(),expect(a.tx.inputs.length).toBeGreaterThanOrEqual(1),expect(a.tx.outputs).toBeDefined(),expect(a.tx.outputs.length).toBe(4);const{outData:u}=a;expect(u).toEqual([Object.assign({_amount:Xt},o)]);const l=_(o,["_owners"]);const d=yield dt.fromTxId(i,Qt,t.getPrivateKey());const{opReturns:p,enc:h}=d;const[,g,f]=h;const y=(p+G(d.tx.outputs.slice(g,f).map((t=>t.script)))).substring(9);const x=JSON.parse(y);expect(x).toEqual([l]);const v=Object.keys(x[0]);expect(v.includes("_owners")).toBe(!1),expect(v.includes("_amount")).toBe(!1),expect(v.includes("_readers")).toBe(!1)}))),6e4),it("should store an object encrypted",(()=>w(void 0,void 0,void 0,(function*(){yield Wt();const t=new ht(Vt,ee);const e={a:"a",_readers:[t.getPublicKey().toString()],__cls:"class A { ... }"};const n=new pt(t);const[o]=yield n.put([e]);const s=o.split("/")[0];yield k(2e3);const r=yield dt.fromTxId(s,Qt,t.getPrivateKey());const{outData:i}=r;expect(i[0]).toEqual({a:"a",_readers:[],_owners:[expect.any(String)],_amount:expect.any(Number),__cls:"class A { ... }"});const c=yield dt.fromTxId(s,Qt,t.getPrivateKey());const{opReturns:a,enc:u}=c;const[,l,d]=u;const p=(a+G(c.tx.outputs.slice(l,d).map((t=>t.script)))).substring(9);const h=JSON.parse(p);expect(h).toEqual([{__cypher:expect.any(String),__secrets:[expect.any(String)]}]);const g=Object.keys(h[0]);expect(g.includes("_owners")).toBe(!1),expect(g.includes("_amount")).toBe(!1),expect(g.includes("_readers")).toBe(!1)}))),6e4),it("should store an object off-chain",(()=>w(void 0,void 0,void 0,(function*(){yield Wt();const t=new ht(Vt,ee);const e="http://127.0.0.1:3000";const n=[{a:"a",b:"b",_url:e}];const o=new pt(t);const s=yield o.put(n);const[r]=s[0].split("/");yield k(2e3);const i=yield dt.fromTxId(r,Qt,t.getPrivateKey());const{outData:c}=i;const a=_(c[0],["_url","_amount","_owners"]);expect(c[0]).toEqual(Object.assign({_url:expect.any(String),_amount:Xt,_owners:[expect.any(String)]},a)),expect(c[0]._url.split("/").join("/")).toEqual(e);const u=yield dt.fromTxId(r,Qt,t.getPrivateKey());const{opReturns:l,enc:d}=u;const[,p,h]=d;const g=G(u.tx.outputs.slice(p,h).map((t=>t.script)));expect(l+g).toBe('000001002[{"_url":"http://127.0.0.1:3000/store/5b6fc73120d59ff048925bd03a11d53e1b1837a0f637569716a97a1ca96891b3"}]');const f=(l+g).substring(9);const y=JSON.parse(f);expect(y).toEqual([{_url:expect.any(String)}]);const x=Object.keys(y[0]);expect(x.includes("_owners")).toBe(!1),expect(x.includes("_amount")).toBe(!1),expect(x.includes("_readers")).toBe(!1)}))),6e4),it("should maintain the order of inputs and outputs",(()=>w(void 0,void 0,void 0,(function*(){yield Wt();const t=new ht(Vt,ee);const e=new pt(t);const n=[t.getPublicKey().toString()];const o=[];for(let t=0;t<7;t+=1){const e=`class ${d.default.randomBytes(32).toString("hex")} {\n            constructor(n) {\n                this.n = n;\n            }\n            inc(n) {\n                this.n += n;\n                return this.n;\n            }\n        }`;o.push({i:t,_owners:n,__cls:e})}const s=yield e.put(o);expect(s).toBeDefined(),expect(s.length).toBe(o.length);const[r]=s;const[i]=r.split("/");yield k(2e3),(yield dt.fromTxId(i,Qt,t.getPrivateKey())).outData.forEach(((t,e)=>{expect(t.toString()).toEqual(o[e].toString())}));const c=yield dt.fromTxId(i,Qt,t.getPrivateKey());const{opReturns:a,enc:u}=c;const[,l,p]=u;const h=(a+G(c.tx.outputs.slice(l,p).map((t=>t.script)))).substring(9);const g=JSON.parse(h);expect(g[0]).toEqual({__cls:expect.any(String),i:0});const f=Object.keys(g[0]);expect(f.includes("_owners")).toBe(!1),expect(f.includes("_amount")).toBe(!1),expect(f.includes("_readers")).toBe(!1)}))),6e4),it("should store large objects on the blockchain",(()=>w(void 0,void 0,void 0,(function*(){yield Wt();const t=new ht(Vt,ee);const e="a".repeat(150);const n={a:e,_owners:[t.getPublicKey().toString()]};const o=new pt(t);const s=yield o.put([n]);expect(s.length).toBe(1);const[r]=s;const[i,c]=r.split("/");expect(i).toBeDefined(),expect(c).toBe("0"),yield k(2e3);const a=yield dt.fromTxId(i,Qt,t.getPrivateKey());const u=a.tx.toJSON();expect(u).toStrictEqual({hash:expect.any(String),version:1,inputs:expect.arrayContaining([{prevTxId:expect.any(String),outputIndex:expect.any(Number),sequenceNumber:expect.any(Number),script:expect.any(String),scriptString:expect.any(String)}]),outputs:[{satoshis:expect.any(Number),script:expect.any(String)},{satoshis:expect.any(Number),script:expect.any(String)},{satoshis:expect.any(Number),script:expect.any(String)},{satoshis:expect.any(Number),script:expect.any(String)},{satoshis:expect.any(Number),script:expect.any(String)}],nLockTime:0}),expect(u.outputs[0].script.length).toBe(74),expect(u.outputs[1].script.length).toBe(210);const{opReturns:l,enc:d}=a;const[,p,h]=d;const g=(l+G(a.tx.outputs.slice(p,h).map((t=>t.script)))).substring(9);const f=JSON.parse(g);expect(f).toEqual([{a:e}]);const y=Object.keys(f[0]);expect(y.includes("_owners")).toBe(!1),expect(y.includes("_amount")).toBe(!1),expect(y.includes("_readers")).toBe(!1)}))),6e4),it("should store a very large object on the blockchain",(()=>w(void 0,void 0,void 0,(function*(){yield Wt();const t=new ht(Vt,ee);const e=3*Math.min(B.SCRIPT_CHUNK_SIZE,500);const n=d.default.randomBytes(32).toString("hex");const o="a".repeat(e);const s={a:o,_owners:[t.getPublicKey().toString()],__cls:`class ${n} {\n            constructor(n) {\n                this.n = n;\n            }\n            inc(n) {\n                this.n += n;\n                return this.n;\n            }\n        }`};const r=new pt(t);const i=yield r.put([s,s]);expect(i.length).toBe(2);const[c,a]=i;expect(c).toBeDefined(),expect(a).toBeDefined(),expect(c.split("/")[0]).toBe(a.split("/")[0]);const[u]=c.split("/");yield k(2e3);const l=yield dt.fromTxId(u,Qt,t.getPrivateKey());expect(l.outData.length).toBe(2),expect(l.tx.outputs.length).toBeGreaterThanOrEqual(6);const{opReturns:p,enc:h}=l;const[,g,f]=h;const y=(p+G(l.tx.outputs.slice(g,f).map((t=>t.script)))).substring(9);const x=JSON.parse(y);expect(x[0]).toEqual({a:o,__cls:expect.any(String)});const v=Object.keys(x[0]);expect(v.includes("_owners")).toBe(!1),expect(v.includes("_amount")).toBe(!1),expect(v.includes("_readers")).toBe(!1)}))),6e5),it("should store multiple objects on the blockchain",(()=>w(void 0,void 0,void 0,(function*(){yield Wt();const t=new ht(Vt,ee);const e=d.default.randomBytes(32).toString("hex");const n=d.default.randomBytes(32).toString("hex");const o=d.default.randomBytes(32).toString("hex");const s={a:"a",_owners:[Ft(0).toString()],__cls:`class ${e} {\n            constructor(n) {\n                this.n = n;\n            }\n            inc(n) {\n                this.n += n;\n                return this.n;\n            }\n        }`};const r={b:"b",_owners:[Ft(1).toString()],__cls:`class ${n} {\n            constructor(n) {\n                this.n = n;\n            }\n            inc(n) {\n                this.n += n;\n                return this.n;\n            }\n        }`};const i={c:"c",_owners:[Ft(2).toString()],__cls:`class ${o} {\n            constructor(n) {\n                this.n = n;\n            }\n            inc(n) {\n                this.n += n;\n                return this.n;\n            }\n        }`};const c=new pt(t);const a=yield c.put([s,r,i]);expect(a.length).toBeGreaterThanOrEqual(3),expect(a.length).toBeLessThanOrEqual(4);const[u,l,p]=a;expect(u).toBeDefined(),expect(l).toBeDefined(),expect(p).toBeDefined(),yield k(2e3);const h=yield dt.fromTxId(u.split("/")[0],Qt,t.getPrivateKey());expect(h.tx.inputs).toBeDefined(),expect(h.tx.inputs.length).toBeGreaterThanOrEqual(1),expect(h.tx.outputs).toBeDefined(),expect(h.tx.outputs.length).toBeGreaterThanOrEqual(4),expect(h.tx.outputs.length).toBe(15);const[g]=u.split("/");const f=yield dt.fromTxId(g,Qt,t.getPrivateKey());const{opReturns:y,enc:x}=f;const[,v,_]=x;const m=(y+G(f.tx.outputs.slice(v,_).map((t=>t.script)))).substring(9);const w=JSON.parse(m);expect(w[0]).toEqual({a:"a",__cls:expect.any(String)});const b=Object.keys(w[0]);expect(b.includes("_owners")).toBe(!1),expect(b.includes("_amount")).toBe(!1),expect(b.includes("_readers")).toBe(!1)}))),6e5)})),describe("update",(()=>{it("should spend from an output created by db.put",(()=>w(void 0,void 0,void 0,(function*(){yield Wt();const t=new ht(Vt,ee);const e=new pt(t);const n=[{c:"a",_owners:[t.getPublicKey().toString()]}];const o=yield e.put(n);yield k(2e3);const[s]=yield e.update(o,n);yield k(2e3);const r=yield dt.fromTxId(s.split("/")[0],Qt,t.getPrivateKey());expect(r.tx.inputs).toBeDefined(),expect(r.tx.inputs.length).toBeGreaterThanOrEqual(2);const i=r.tx.inputs[0].prevTxId.toString("hex");const c=r.tx.inputs[0].outputIndex;expect(i).toEqual(o[0].split("/")[0]),expect(c).toEqual(0);const a=(yield ee.getOwnedRevs(t.getPublicKey())).filter((({rev:t})=>t===o[0]));expect(a).toEqual([])}))),24e4),it("should spend from an encrypted output",(()=>w(void 0,void 0,void 0,(function*(){yield Wt();const t=new ht(Vt,ee);const e=new pt(t);const n=t.getPublicKey().toString();const o=[{c:"a ",_owners:[n],_readers:[n]}];const s=yield e.put(o);yield k(2e3);const[r]=yield e.update(s,[{}]);yield k(2e3);const i=yield dt.fromTxId(r.split("/")[0],Qt,t.getPrivateKey());expect(i.tx.inputs).toBeDefined(),expect(i.tx.inputs.length).toBeGreaterThanOrEqual(2);const c=i.tx.inputs[0].prevTxId.toString("hex");const a=i.tx.inputs[0].outputIndex.toString();expect(c).toEqual(s[0].split("/")[0]),expect(a).toEqual(s[0].split("/")[1]);const u=(yield ee.getOwnedRevs(t.getPublicKey())).filter((({rev:t})=>t===s[0]));expect(u).toEqual([])}))),24e4),it("should set default amount if not set",(()=>w(void 0,void 0,void 0,(function*(){yield Wt();const t=new ht(Vt,ee);const e=new pt(t);const n={c:"a"};const o=yield e.put([n]);yield k(2e3);const[s]=yield e.update(o,[n]);yield k(2e3);const r=yield e.get([s]);expect(r).toEqual([Object.assign(Object.assign({},n),{_owners:[t.getPublicKey().toString()],_amount:Xt})]),yield k(2e3);const i=yield dt.fromTxId(s.split("/")[0],Qt,t.getPrivateKey());expect(i.tx.inputs).toBeDefined(),expect(i.tx.inputs.length).toBeGreaterThanOrEqual(2);const c=i.tx.inputs[0].prevTxId.toString("hex");const a=i.tx.inputs[0].outputIndex;expect(c).toEqual(o[0].split("/")[0]),expect(a).toEqual(0)}))),24e4),it("should spend from an output with lots of data",(()=>w(void 0,void 0,void 0,(function*(){yield Wt();const t=new ht(Vt,ee);const e=new pt(t);const n=5*Math.min(B.SCRIPT_CHUNK_SIZE,500)+1;const o=[t.getPublicKey().toString()];const s={a:"a".repeat(n),_owners:o};const r=new Array(2);r.fill(s);const i=yield e.put(r);expect(i.length).toBe(2),yield k(2e3);const[c]=yield e.update(i,[s,s]);const a=c.split("/")[0];yield k(2e3);const u=yield dt.fromTxId(a,Qt,t.getPrivateKey());expect(u.tx.inputs).toBeDefined(),expect(u.tx.inputs.length).toBeGreaterThan(2);const l=u.tx.inputs[0].prevTxId.toString("hex");expect(l).toBeDefined()}))),27e4),it("should maintain the order of inputs and outputs",(()=>w(void 0,void 0,void 0,(function*(){yield Wt();const t=new ht(Vt,ee);const e=new pt(t);const n=[t.getPublicKey().toString()];const o=Math.round(20*Math.random())+1;const s=Math.round(20*Math.random())+1;const r=[];for(let t=0;t<o;t+=1){const e=`class ${d.default.randomBytes(32).toString("hex")} {\n            constructor(n) {\n                this.n = n;\n            }\n            inc(n) {\n                this.n += n;\n                return this.n;\n            }\n        }`;r.push({i:t,_owners:n,__cls:e})}const i=yield e.put(r);const c=[];for(let t=s;t>=0;t-=1)c.push({i:t,_owners:n});yield k(2e3);const a=yield e.update(i,c);expect(a).toBeDefined(),expect(a.length).toBeDefined(),expect(a.length).toBeGreaterThan(s),a.map(((t,e)=>{const[n,o]=t.split("/");return expect(n).toBe(a[0].split("/")[0]),expect(parseInt(o,10)).toEqual(e),!0})),yield k(2e3);const u=yield dt.fromTxId(a[0].split("/")[0],Qt,t.getPrivateKey());u.tx.inputs.map(((t,e)=>(e<o&&expect(t.outputIndex).toBe(parseInt(i[e].split("/")[1],10)),!0)));const{outData:l}=u;l.forEach(((t,e)=>{expect(t.i).toBe(s-e)}))}))),22e4),it("should work together with get",(()=>w(void 0,void 0,void 0,(function*(){yield Wt();const t=new ht(Vt,ee);const e=t.getPublicKey().toString();const n={a:"a",b:"b",_owners:[e]};const o=new pt(t);const s=yield o.put([n]);const r={c:"c",_owners:[e]};yield k(2e3);const i=yield o.update(s,[r]);yield k(2e3);const[c]=yield o.get(i);expect(c._amount).toBe(Xt),expect(c._owners.length).toBe(1),expect(c._owners[0]).toEqual(e),expect(c.c).toBe("c")}))),24e4)}))}));
