"use strict";var t=require("crypto");var e=require("bitcoin-computer-bitcore");var n=require("axios");var r=require("crypto-js");var o=require("eciesjs");var s=require("http");var i=require("https");var a=require("url");var c=require("util");function u(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}function d(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(n){if("default"!==n){var r=Object.getOwnPropertyDescriptor(t,n);Object.defineProperty(e,n,r.get?r:{enumerable:!0,get:function(){return t[n]}})}})),e.default=t,Object.freeze(e)}require("ses");var l=u(t);var h=u(n);var p=u(r);var f=d(o);var g=u(s);var v=u(i);var y=u(a);var w=u(c);function m(t,e){var n={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.indexOf(r)<0&&(n[r]=t[r]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(t);o<r.length;o++)e.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(t,r[o])&&(n[r[o]]=t[r[o]])}return n}function x(t,e,n,r){var o,s=arguments.length,i=s<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(t,e,n,r);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(i=(s<3?o(i):s>3?o(e,n,i):o(e,n))||i);return s>3&&i&&Object.defineProperty(e,n,i),i}function b(t,e,n,r){return new(n||(n=Promise))((function(o,s){function i(t){try{c(r.next(t))}catch(t){s(t)}}function a(t){try{c(r.throw(t))}catch(t){s(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(i,a)}c((r=r.apply(t,e||[])).next())}))}const{crypto:S}=e.Bitcoin;const _=(t,e)=>{const n=Date.now();const r=S.Hash.sha256(Buffer.from(e+n));const o=[S.ECDSA.sign(r,t,"big").toString("hex"),t.publicKey.toString(),n];return`Bearer ${Buffer.from(o.join(":")).toString("base64")}`};const{Transaction:O}=e.Bitcoin;function T(t){return b(this,void 0,void 0,(function*(){if(!function(t){return void 0!==t.config}(t))throw new Error("Unknown error");const{message:e,config:n,response:r}=t;const o=function(t){try{const e=JSON.parse(t);if("object"!=typeof e)throw new Error("Invalid object");if("string"!=typeof e.txhex)throw new Error("Invalid object");return new O(e.txhex)}catch(t){return null}}(null==n?void 0:n.data);const s=`message\t${e}`;const i=`request\t${null==n?void 0:n.method} ${null==n?void 0:n.url}`;const a=o?`transaction\t ${JSON.stringify(o.toJSON(),null,2)}`:"";const c="post"===(null==n?void 0:n.method)?`data\t${null==n?void 0:n.data}`:"";const u=r?`response\t${JSON.stringify(r.data)}`:"";const d=o?a:c;throw t.message=`\n    Communication Error\n    ${s}\n    ${i}\n    ${d}\n    ${u}`,t}))}class P{constructor(t,e,n={}){this.baseUrl=t,this.headers=n,this.privateKey=e}get(t){return b(this,void 0,void 0,(function*(){const e=`${this.baseUrl}${t}`;try{let t={};return this.privateKey&&(t={Authentication:_(this.privateKey,this.baseUrl)}),(yield h.default.get(e,{headers:Object.assign(Object.assign({},this.headers),t)})).data}catch(t){return T(t)}}))}post(t,e){return b(this,void 0,void 0,(function*(){const n=`${this.baseUrl}${t}`;try{let t={};return this.privateKey&&(t={Authentication:_(this.privateKey,this.baseUrl)}),(yield h.default.post(n,e,{headers:Object.assign(Object.assign({},this.headers),t)})).data}catch(t){return T(t)}}))}delete(t){return b(this,void 0,void 0,(function*(){const e=`${this.baseUrl}${t}`;try{let t={};return this.privateKey&&(t={Authentication:_(this.privateKey,this.baseUrl)}),(yield h.default.delete(e,{headers:Object.assign(Object.assign({},this.headers),t)})).data}catch(t){return T(t)}}))}}const{PrivateKey:B,Transaction:E}=e.Bitcoin;const{UnspentOutput:A}=E;function C(t){if(!/^[0-9A-Fa-f]{64}$/.test(t))throw new Error(`Invalid txId: ${t}`)}function N(t){if(!/^[0-9A-Fa-f]{64}\/\d+$/.test(t))throw new Error(`Invalid outId: ${t}`)}function R(t){N(t);const[e,n]=t.split("/");return{txId:e,outputIndex:parseInt(n,10)}}let I=class{constructor(t,e=new B){this.nodeConfig=t,this.bcn=new P(t.url,e)}get chain(){return this.nodeConfig.chain}get network(){return this.nodeConfig.network}getBalance(t){return b(this,void 0,void 0,(function*(){const{chain:e,network:n}=this;return yield this.bcn.get(`/v1/${e}/${n}/address/${t}/balance`)}))}getTransaction(t){return b(this,void 0,void 0,(function*(){return new E(yield this.getRawTx(t))}))}getRawTx(t){return b(this,void 0,void 0,(function*(){C(t);const{chain:e,network:n}=this;return this.bcn.get(`/v1/${e}/${n}/tx/${t}`)}))}getTransactions(t){return b(this,void 0,void 0,(function*(){return(yield this.getRawTxs(t)).map((t=>new E(t)))}))}getRawTxs(t){return b(this,void 0,void 0,(function*(){t.map(C);const{chain:e,network:n}=this;return this.bcn.post(`/v1/${e}/${n}/tx/bulk/`,{txIds:t})}))}sendTransaction(t){return b(this,void 0,void 0,(function*(){return this.bcn.post(`/v1/${this.chain}/${this.network}/tx/send`,{rawTx:t})}))}getUtxosFromAddress(t){return b(this,void 0,void 0,(function*(){const{chain:e,network:n}=this;return(yield this.bcn.get(`/v1/${e}/${n}/wallet/${t.toString()}/utxos`)).map((({rev:t,scriptPubKey:e,satoshis:n})=>{const[r,o]=t.split("/");return new A({txId:r,outputIndex:parseInt(o,10),satoshis:n,script:e})}))}))}getOwnedRevs(t){return b(this,void 0,void 0,(function*(){const{chain:e,network:n}=this;return this.bcn.get(`/v1/${e}/${n}/wallet/${t.toString()}/non-standard-utxos`)}))}queryRevs(t){return b(this,void 0,void 0,(function*(){const{publicKey:e,contractName:n,contractHash:r}=t;if(void 0===e&&void 0===n&&void 0===r)throw new Error("Filter parameter for queryRevs endpoint cannot be empty.");let o="";e&&(o+=`?publicKey=${e}`),n&&(o+=0===o.length?"?":"&",o+=`contractName=${n}`),r&&(o+=0===o.length?"?":"&",o+=`contractHash=${r}`);const{chain:s,network:i}=this;return this.bcn.get(`/v1/${s}/${i}/non-standard-utxos${o}`)}))}getLatestRev(t){return b(this,void 0,void 0,(function*(){N(t);const{chain:e,network:n}=this;const[{rev:r}]=yield this.bcn.get(`/v1/${e}/${n}/rev/${t}`);return r}))}getLatestRevs(t){return b(this,void 0,void 0,(function*(){t.map(N),t.map(N);const{chain:e,network:n}=this;return yield this.bcn.post(`/v1/${e}/${n}/revs`,{ids:t})}))}static getSecretOutput({_url:t,privateKey:e}){return b(this,void 0,void 0,(function*(){const n=t.split("/");const r=n[n.length-1];const o=n.slice(0,-2).join("/");const s=new P(o,e);return{host:o,data:yield s.get(`/v1/store/${r}`)}}))}static setSecretOutput({secretOutput:t,host:e,privateKey:n}){return b(this,void 0,void 0,(function*(){return new P(e,n).post("/v1/store/",t)}))}static deleteSecretOutput({_url:t,privateKey:e}){return b(this,void 0,void 0,(function*(){const n=t.split("/");const r=n[n.length-1];const o=n.slice(0,-2).join("/");const s=new P(o,e);yield s.delete(`/v1/store/${r}`)}))}};I=x([t=>t],I);const K=parseInt(process.env.BC_DUST_LIMIT||"",10)||1546;const j=parseInt(process.env.BC_DEFAULT_FEE||"",10)||2500;var U={MIN_NON_DUST_AMOUNT:K,SCRIPT_CHUNK_SIZE:parseInt(process.env.BC_SCRIPT_CHUNK_SIZE||"",10)||479,DEFAULT_FEE:j,SIGHASH_ALL:1,FEE_PER_KB:2e4,PUBLIC_KEY_SIZE:65,ANYONE_CAN_SPEND_SEED:"replace this seed",PASSPHRASE:"",ENCODING_LENGTH:3,ENCODING_NUMBER_LENGTH:3,MAX_PUBKEYS_PER_SCRIPT:3,OP_RETURN_SIZE:80};const{PublicKey:D,crypto:$}=e.Bitcoin;const{Point:k}=$;function M(t){return Buffer.from(t,"hex").toString().replace(/\0/g,"")}function H(t,e){return t.slice(e)+t.slice(0,e)}function L(t,e,n){if(t.length*Math.log2(e)>53)throw new Error(`Input too large ${t.length} ${Math.log2(e)}`);if(![2,10,16].includes(e)||![2,10,16].includes(n))throw new Error("ToBase or FromBase invalid in covertNumber.");if(2===e&&t.length%8!=0)throw new Error("Binary strings must be byte aligned.");if(16===e&&t.length%2!=0)throw new Error("Hex strings must be of even length.");const r=parseInt(t,e).toString(n);return 2===n?r.padStart(8*Math.ceil(r.length/8),"0"):16===n?r.padStart(2*Math.ceil(r.length/2),"0"):r}function G(t,e){const n=new RegExp(`.{1,${e}}`,"g");return t.match(n)||[]}function F(t){return G(t,2).map((t=>L(t,16,2))).join("")}function q(t){return G(t,8).map((t=>L(t,2,16))).join("")}function W(t){return t.toString(16).padStart(U.ENCODING_NUMBER_LENGTH,"0")}function J(t){return parseInt(t,16)}function Y(t){if(62!==t.length)throw new Error("Input to hexToPublicKey must be of length 62");let e=!1;let n=0;let r;for(;!e;){if(n>=256)throw new Error("Something went wrong storing data");const o=n.toString(16).padStart(2,"0")+q(H(F(t).padStart(64,"0"),n));try{r=k.fromX(!1,o),e=!0}catch(t){n+=1}}if(!r)throw new Error("Something went wrong storing data");return new D(r)}function z(t){const e=t.point.getX().toString("hex").padStart(64,"0");const n=L(e.slice(0,2),16,10);return q((o=parseInt(n,10),(r=F(e.slice(2))).slice(-o)+r.slice(0,-o)));var r,o}function X(t){return new Promise((e=>{setTimeout(e,t)}))}function Z(t,e){return`m/44'/${function(t,e){if("testnet"===e||"regtest"===e)return"1";if("BTC"===t)return"0";if("LTC"===t)return"2";if("DOGE"===t)return"3";if("BCH"===t)return"145";if("BSV"===t)return"236";throw new Error(`Unsupported chain ${t}`)}(t,e)}'/0'/0/0`}const{PublicKey:V,Script:Q}=e.Bitcoin;function tt(t){if(t.length>U.MAX_PUBKEYS_PER_SCRIPT)throw new Error("Too many owners");return function(t){const e=new Q;return e.add("OP_1"),t.forEach((t=>{e.add(t)})),e.add(`OP_${t.length}`),e.add("OP_CHECKMULTISIG"),e}(t.map((t=>t.toBuffer())))}function et(t){return function(t){return t.chunks.filter((t=>t.buf)).map((t=>t.buf))}(t).map((t=>V.fromBuffer(t)))}function nt(t){return Buffer.from(p.default.SHA256(t).toString(),"hex").toString("hex").substr(0,4)}function rt(t){return`${nt(t)};${t}`}function ot(t){const e=t.substr(0,4);const n=t.substr(5);if(!function(t,e){return nt(t)===e}(n,e))throw new Error("Decryption failure");return n}function st(t){if(void 0!==t._readers){const{_readers:e,_url:n,_owners:r,_amount:o}=t,s=m(t,["_readers","_url","_owners","_amount"]);const i=function(t,e){const n=l.default.randomBytes(32).toString("hex");const r=function(t,e){if(!/^[0-9a-f]{64}$/.test(e))throw new Error("Invalid secret");const n=Buffer.from(e,"hex").toString("binary");const r=rt(t);return p.default.AES.encrypt(r,n).toString()}(t,n);const o=e.map((t=>function(t,e){if(!/^0[2-3][0-9a-f]{64}|04[0-9a-f]{128}$/.test(e))throw new Error("Invalid publicKey");const n=rt(t);return f.encrypt(e,Buffer.from(n,"utf8")).toString("base64")}(n,t)));return{__cypher:r,__secrets:o}}(JSON.stringify(s),e);return void 0!==n&&(i._url=n),void 0!==r&&(i._owners=r),void 0!==o&&(i._amount=o),i}return t}const{Transaction:at}=e.Bitcoin;const{Output:ct}=at;const{UnspentOutput:ut}=at;let dt=class{constructor(t,e,n){const r=new at(n);r.feePerKb(U.FEE_PER_KB),this.nodeConfig=t,this.tx=r,this.outData=[],this.privateKey=e}get txId(){return this.tx.id}get chain(){return this.nodeConfig.chain}get network(){return this.nodeConfig.network}get restClient(){return new I(this.nodeConfig,this.privateKey)}get inputs(){return this.tx.inputs.map((t=>`${t.prevTxId.toString("hex")}/${t.outputIndex}`))}get inRevs(){const{enc:t}=this;let[e]=t;return e=Number.isFinite(e)?e:0,this.tx.inputs.slice(0,e).map((({prevTxId:t,outputIndex:e})=>`${t.toString("hex")}/${e}`))}get outRevs(){const{enc:t}=this;let[,e]=t;return e=Number.isFinite(e)?e:0,Array.from(Array(e).keys()).map((t=>`${this.tx.id}/${t}`))}get opReturns(){try{const{outputs:t}=this.tx;return t.filter((({script:t})=>t.isDataOut())).map((({script:t})=>t.getData())).map((t=>t.toString())).join()}catch(t){return""}}get enc(){return G(this.opReturns.slice(0,U.ENCODING_LENGTH*U.ENCODING_NUMBER_LENGTH),U.ENCODING_NUMBER_LENGTH).map(J)}get dataPrefix(){return this.opReturns.slice(9)}getOwnerOutputs(){const{enc:t}=this;const[,e=0]=t;return this.tx.outputs.slice(0,e)}getDataOutputs(){const{enc:t}=this;const[,e,n]=t;return this.tx.outputs.slice(e,n)}getOutData(t){return b(this,void 0,void 0,(function*(){try{const e=this.getDataOutputs().map((t=>t.script)).map((t=>et(t))).flat().map(z).map(M).join("");const{dataPrefix:n}=this;const r=JSON.parse(n+e);const o=t.toBuffer().toString("hex");const s=this.getOwnerOutputs();if(s.length!==r.length)throw new Error("Inconsistent state");const i=s.map(((t,e)=>Object.assign(Object.assign({},r[e]),{_owners:et(t.script).map((t=>t.toString())),_amount:t.satoshis})));return Promise.all(i.map((e=>b(this,void 0,void 0,(function*(){try{const n=yield function(t){return e=>b(this,void 0,void 0,(function*(){if(function(t){return void 0!==t._url}(e)){const{_url:n}=e,r=m(e,["_url"]);const{host:o,data:s}=yield I.getSecretOutput({_url:n,privateKey:t});return Object.assign(Object.assign(Object.assign({},r),JSON.parse(s)),{_url:o})}return e}))}(t)(e);return function(t,e){if(function(t){return void 0!==t.__cypher&&void 0!==t.__secrets}(t)){const{__cypher:n,__secrets:r}=t,o=m(t,["__cypher","__secrets"]);return Object.assign(Object.assign(Object.assign({},o),JSON.parse(function({__cypher:t,__secrets:e},n){let r="";if(n.forEach((n=>{e.forEach((e=>{try{const o=function(t,e){if(!/^[0-9a-f]{64}$/.test(e))throw new Error("Invalid privateKey");return ot(f.decrypt(e,Buffer.from(t,"base64")).toString("utf8"))}(e,n);r=function(t,e){if(!/^[0-9a-f]{64}$/.test(e))throw new Error("Invalid secret");const n=Buffer.from(e,"hex").toString("binary");return ot(p.default.AES.decrypt(t,n).toString(p.default.enc.Utf8))}(t,o)}catch(t){const e=["Decryption failure","Unsupported state or unable to authenticate data"];if(t instanceof Error&&!e.includes(t.message))throw t}}))})),r)return r;throw new Error("Decryption failure")}({__cypher:n,__secrets:r},e))),{_readers:[]})}return t}(n,[o])}catch(t){return null}})))))}catch(t){return[]}}))}getOwners(){return this.getOwnerOutputs().map((t=>et(t.script).map((t=>t.toString()))))}getAmounts(){return this.getOwnerOutputs().map((t=>t.satoshis))}spendFromData(t){return b(this,void 0,void 0,(function*(){if(!t.length)return;const n=t.map(R);const r=n.map((t=>t.txId));const o=yield this.restClient.getTransactions(r);for(let t=0;t<n.length;t+=1){const{txId:r,outputIndex:s}=n[t];const{outputs:i}=o[t];const a=i[s];const c=Math.round(a.satoshis);const u=new e.Bitcoin.Script(a.script);const d=new ut({txId:r,outputIndex:s,satoshis:c,script:u});const l=et(u).map((t=>t.toString()));this.tx.from([d],l,1)}}))}createOpReturnOut(t){this.tx.addData(JSON.stringify(t))}createDataOuts(t){t.forEach((({_amount:t,_owners:n=[]})=>{if(Array.isArray(n)&&n.length>U.MAX_PUBKEYS_PER_SCRIPT)throw new Error("Too many owners.");const r=n.map((t=>e.Bitcoin.PublicKey.fromString(t)));const o=t||U.MIN_NON_DUST_AMOUNT;const s=tt(r);this.tx.addOutput(new ct({script:s,satoshis:o}))}));const n=t.map((t=>m(t,["_amount","_owners"])));const r=U.MIN_NON_DUST_AMOUNT;const o=JSON.stringify(n);const s=U.OP_RETURN_SIZE-U.ENCODING_LENGTH*U.ENCODING_NUMBER_LENGTH;const i=o.slice(0,s);const a=function(t){var e;return function(t,e){const n=[];for(let r=0;r<t.length;r+=e)n.push(t.slice(r,r+e));return n}(G((e=t,Buffer.from(e).toString("hex")),62).map((t=>t.padStart(62,"0"))).map(Y),U.MAX_PUBKEYS_PER_SCRIPT).map((t=>tt(t)))}(o.slice(s));const c=W(this.tx.inputs.length)+W(this.tx.outputs.length)+W(this.tx.outputs.length+a.length);a.forEach((t=>{this.tx.addOutput(new ct({script:t,satoshis:r}))})),this.tx.addData(c+i)}static fromTxHex(t,e,n){return b(this,void 0,void 0,(function*(){const r=new this(e,n);r.tx.fromString(t);let o=[];let s=[];let i=[];try{o=yield r.getOutData(n)}catch(t){}try{s=r.getOwners()}catch(t){}try{i=r.getAmounts()}catch(t){}return r.outData=o.map(((t,e)=>Object.assign(Object.assign({},t),{_owners:s[e],_amount:i[e]}))),r}))}static fromTxId(t,e,n){return b(this,void 0,void 0,(function*(){const r=new I(e,n);const o=yield r.getRawTx(t);return this.fromTxHex(o,e,n)}))}};dt=x([t=>t],dt);class lt{constructor(t,e,n={}){const{chain:r,network:o}=e;const{path:s=Z(r,o),passphrase:i=""}=n;let a=t.toHDPrivateKey(i,o);s&&(a=a.derive(s));const c=a.publicKey.toAddress(o);this.mnemonic=t,this.restClient=e,this.path=s,this.passphrase=i,this.hdPrivateKey=a,this.address=c}get chain(){return this.restClient.chain}get network(){return this.restClient.network}get nodeConfig(){return this.restClient.nodeConfig}getMnemonic(){return this.mnemonic}derive(t="0"){const e=`${this.path}${this.path.length>0?"/":""}${t}`;return new lt(this.mnemonic,this.restClient,{path:e})}getPrivateKey(){return this.hdPrivateKey.privateKey}getPublicKey(){return this.hdPrivateKey.publicKey}getAddress(){return this.address}getBalance(){return b(this,void 0,void 0,(function*(){return this.restClient.getBalance(this.getAddress())}))}getUtxos(t=this.getAddress()){return b(this,void 0,void 0,(function*(){return this.restClient.getUtxosFromAddress(t)}))}selectUtxos(t,e){let n=0;const r=[];!function(t){const e=t;for(let t=e.length-1;t>0;t-=1){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}}(t);for(let o=0;o<t.length;o+=1){const s=t[o];if(n+=s.satoshis,r.push(s),n>=e)return r}const{network:o,chain:s}=this.restClient.nodeConfig;throw new Error(`Insufficient balance in address ${this.getAddress().toString()} on ${o} ${s}. Found ${n}, required ${e}.`)}fundAndSendTransaction(t){return b(this,void 0,void 0,(function*(){t.tx.feePerKb(U.FEE_PER_KB);const{chain:n,network:r}=this.nodeConfig;const{enc:o}=t;const[,s=0]=o;const i=s*function(t){if("LTC"===t)return 8e3;if("BTC"===t)return 22;if("DOGE"===t)return 7e6;if("BCH"===t)return 2700;throw new Error(`Unsupported chain ${t}`)}(n);const a=.001*t.tx._getOutputAmount();const c=Math.max(U.MIN_NON_DUST_AMOUNT,i+a);t.tx.to(function(t,e){const n={"any-testnet":"gLjNGbKQzxqKA9bv2nhn1Ewf7rxYVXgrtR","BTC-mainnet":"84ZHRqRPTcUv6AFGMVC1KmSUeC9Y8SNfMm","LTC-mainnet":"mov5ivrsqWut5ffZhiz18uAkwy2D4y98iz","DOGE-mainnet":"1MVukPYmWdbEoxy3Sqq1ES4nYqDfpB5e68","BCH-mainnet":"P9CmJszhvARfQc8YjUW1K2oBnus1ZQWEqk","BSV-mainnet":"G2wxQ74zX48WMo7sfiX1faGGNQB8ebVth"};return H("testnet"===e||"regtest"===e?n["any-testnet"]:n[`${t}-${e}`],19)}(n,r),Math.round(c));let u=t.tx._getInputAmount();const d=t.tx._getOutputAmount();const l=t.tx._estimateFee();let h=d-u+Math.round(l);if(h>0){const n=yield this.getUtxos();this.selectUtxos(n,h).forEach((n=>{t.tx.from([new e.Bitcoin.Transaction.UnspentOutput(n)])})),u=t.tx._getInputAmount(),h=d-u+Math.round(t.tx._estimateFee())}return t.tx.change(this.getAddress()),t.tx.sign(this.getPrivateKey(),U.SIGHASH_ALL),yield this.restClient.sendTransaction(t.tx.toString())}))}send(t,e){return b(this,void 0,void 0,(function*(){const n=new dt(this.restClient.nodeConfig,this.getPrivateKey());return n.tx.to(e,t),this.fundAndSendTransaction(n)}))}}class ht{constructor(t){this.wallet=t}get chain(){return this.wallet.chain}get network(){return this.wallet.network}get nodeConfig(){return this.wallet.nodeConfig}fromTxHex(t){return b(this,void 0,void 0,(function*(){const{wallet:e,nodeConfig:n}=this;const r=e.getPrivateKey();return dt.fromTxHex(t,n,r)}))}fromTxId(t){return b(this,void 0,void 0,(function*(){const{wallet:e,nodeConfig:n}=this;const r=new I(n,e.getPrivateKey());const o=yield r.getRawTx(t);return this.fromTxHex(o)}))}get(t){return b(this,void 0,void 0,(function*(){const e=t.map(R);return Promise.all(e.map((({txId:t,outputIndex:e})=>b(this,void 0,void 0,(function*(){const{outData:n}=yield this.fromTxId(t);if(e>n.length)throw new Error("Index out of bounds");return n[e]})))))}))}put(t){return this.update([],t)}createTx(t,e){return b(this,void 0,void 0,(function*(){const{wallet:n,nodeConfig:r}=this;const o=n.getPrivateKey();const s=new dt(r,o);const i=e.map((t=>{var{_owners:e}=t,n=m(t,["_owners"]);return Object.assign({_owners:e||[this.wallet.getPublicKey().toString()]},n)})).map(st);const a=yield Promise.all(i.map(function(t){return e=>b(this,void 0,void 0,(function*(){if(void 0!==e._url){const{_url:n,_owners:r,_amount:o}=e,s=m(e,["_url","_owners","_amount"]);const i=yield I.setSecretOutput({host:n,secretOutput:{data:JSON.stringify(s)},privateKey:t});return void 0!==r&&(i._owners=r),void 0!==o&&(i._amount=o),i}return e}))}(o)));return yield s.spendFromData(t),yield s.createDataOuts(a),s}))}update(t,e){return b(this,void 0,void 0,(function*(){const n=yield this.createTx(t,e);return yield this.wallet.fundAndSendTransaction(n),n.outRevs}))}}var pt={CHAIN:process.env.CHAIN||"LTC",NETWORK:process.env.NETWORK||"testnet",BCN_URL:process.env.BCN_URL||"https://node.bitcoincomputer.io"};const{CHAIN:ft="LTC",NETWORK:gt="regtest",RPC_USER:vt,RPC_PASSWORD:yt,RPC_HOST:wt}=process.env;const mt="LTC"===process.env.CHAIN?19332:8332;var xt=Object.assign(Object.assign({},pt),{CHAIN:ft,NETWORK:gt,BCN_URL:"http://127.0.0.1:3000",RPC_PROTOCOL:"http",RPC_USER:vt,RPC_PASSWORD:yt,RPC_HOST:wt,RPC_PORT:mt,TEST_ADDRESSES:"mwADSUHvPCGrrX4ozP8Kcd5JCWK93rnc8h;moMoH1vTgCc2dkDfGSKYPnafxy22wSqgrr;mmQEk8VwtSehRryLF8jhVapYg553hJGhNa;miKQVhZbFKSsJcQZ8eXwBQ89xNyetpN34q;mzoGRNh55y9j57TPdwRGi3nt9X4CFwpqUS;n1X6JFDyxibtdhYrc7mrkuft6o168ELFNW;mjLcig6eTZVJkgRgJFMkwrYHpfMnZ1t4kk;mfYkMQAe7afeRSkgLxAtwnMVryjLTfr95Q"});const bt=t=>(Object.prototype.toString.call(t).match(/\s([a-zA-Z]+)/)||[])[1];const St=t=>"object"==typeof t?bt(t):bt(t).toLowerCase();const _t=t=>["number","string","boolean","undefined","Null"].includes(St(t));const Ot=t=>_t(t)||["Array","Object"].includes(St(t));const Tt=(t,e)=>{if(!Ot(t)||!Ot(e))throw new Error(`Unsupported data types for deep equals: ${St(t)} & ${St(e)}`);if(St(t)!==St(e))return!1;if(_t(t)&&_t(e))return t===e;const n=(t,e)=>Object.entries(t).every((([t,n])=>Tt(e[t],n)));return t&&e&&n(t,e)&&n(e,t)};var Pt=g.default;var Bt=v.default;var Et=y.default;function At(t){"string"==typeof t&&(t=function(t){var e=Et.parse(t);var n=e.hostname;var r=parseInt(e.port,10);var o=e.protocol;o=o.substring(0,o.length-1);var s=e.auth.split(":");return{host:n,port:r,protocol:o,user:s[0]?decodeURIComponent(s[0]):null,pass:s[1]?decodeURIComponent(s[1]):null}}(t)),t=t||{},this.host=t.host||"127.0.0.1",this.port=t.port||8332,this.user=t.user||"user",this.pass=t.pass||"pass",this.protocol="http"===t.protocol?Pt:Bt,this.batchedCalls=null,this.disableAgent=t.disableAgent||!1;var e=void 0!==t.rejectUnauthorized;this.rejectUnauthorized=!e||t.rejectUnauthorized,At.config.log?this.log=At.config.log:this.log=At.loggers[At.config.logger||"normal"]}var Ct=console.log.bind(console);var Nt=function(){};function Rt(t,e){var n=this;t=JSON.stringify(t);var r=this.user+":"+this.pass;var o=Buffer.from&&Buffer.from!==Uint8Array.from?Buffer.from(r):new Buffer(r);this.auth=o.toString("base64");var s={host:n.host,path:"/",method:"POST",port:n.port,rejectUnauthorized:n.rejectUnauthorized,agent:!n.disableAgent&&void 0};if(n.httpOptions)for(var i in n.httpOptions)s[i]=n.httpOptions[i];var a=!1;var c="Bitcoin JSON-RPC: ";var u=this.protocol.request(s,(function(t){var r="";t.on("data",(function(t){r+=t})),t.on("end",(function(){if(!a)if(a=!0,401!==t.statusCode)if(403!==t.statusCode){if(500===t.statusCode&&"Work queue depth exceeded"===r.toString("utf8")){var o=new Error("Bitcoin JSON-RPC: "+r.toString("utf8"));return o.code=429,void e(o)}var s;try{s=JSON.parse(r)}catch(o){n.log.err(o.stack),n.log.err(r),n.log.err("HTTP Status code:"+t.statusCode);var i=new Error(c+"Error Parsing JSON: "+o.message);return void e(i)}e(s.error,s)}else e(new Error(c+"Connection Rejected: 403 Forbidden"));else e(new Error(c+"Connection Rejected: 401 Unnauthorized"))}))}));u.on("error",(function(t){var n=new Error(c+"Request Error: "+t.message);a||(a=!0,e(n))})),u.setHeader("Content-Length",t.length),u.setHeader("Content-Type","application/json"),u.setHeader("Authorization","Basic "+n.auth),u.write(t),u.end()}At.loggers={none:{info:Nt,warn:Nt,err:Nt,debug:Nt},normal:{info:Ct,warn:Ct,err:Ct,debug:Nt},debug:{info:Ct,warn:Ct,err:Ct,debug:Ct}},At.config={logger:"normal"},At.prototype.batch=function(t,e){this.batchedCalls=[],t(),Rt.call(this,this.batchedCalls,e),this.batchedCalls=null},At.callspec={abandonTransaction:"str",abortRescan:"",addMultiSigAddress:"",addNode:"",analyzePSBT:"str",backupWallet:"",bumpFee:"str",clearBanned:"",combinePSBT:"obj",combineRawTransaction:"obj",convertToPSBT:"str",createMultiSig:"",createPSBT:"obj",createRawTransaction:"obj obj",createWallet:"str",decodePSBT:"str",decodeScript:"str",decodeRawTransaction:"",deriveAddresses:"str",disconnectNode:"",dumpPrivKey:"",dumpWallet:"str",encryptWallet:"",enumerateSigners:"",estimateFee:"",estimateSmartFee:"int str",estimatePriority:"int",generate:"int",generateBlock:"str obj",generateToAddress:"int str",generateToDescriptor:"int str",getAccount:"",getAccountAddress:"str",getAddedNodeInfo:"",getAddressMempool:"obj",getAddressUtxos:"obj",getAddressBalance:"obj",getAddressDeltas:"obj",getAddressesByLabel:"str",getAddressInfo:"str",getAddressTxids:"obj",getAddressesByAccount:"",getBalance:"str int",getBalances:"",getBestBlockHash:"",getBlockDeltas:"str",getBlock:"str int",getBlockchainInfo:"",getBlockCount:"",getBlockFilter:"str",getBlockHashes:"int int obj",getBlockHash:"int",getBlockHeader:"str",getBlockNumber:"",getBlockStats:"str",getBlockTemplate:"",getConnectionCount:"",getChainTips:"",getChainTxStats:"",getDescriptorInfo:"str",getDifficulty:"",getGenerate:"",getHashesPerSec:"",getIndexInfo:"",getInfo:"",getMemoryInfo:"",getMemoryPool:"",getMemPoolAncestors:"str",getMemPoolDescendants:"str",getMemPoolEntry:"str",getMemPoolInfo:"",getMiningInfo:"",getNetTotals:"",getNetworkHashPS:"",getNetworkInfo:"",getNewAddress:"str str",getNodeAddresses:"",getPeerInfo:"",getRawChangeAddress:"",getRawMemPool:"bool",getRawTransaction:"str int",getReceivedByAccount:"str int",getReceivedByAddress:"str int",getReceivedByLabel:"str",getRpcInfo:"",getSpentInfo:"obj",getTransaction:"",getTxOut:"str int bool",getTxOutProof:"",getTxOutSetInfo:"",getUnconfirmedBalance:"",getWalletInfo:"",getWork:"",getZmqNotifications:"",finalizePSBT:"str",fundRawTransaction:"str",help:"",importAddress:"str str bool",importDescriptors:"str",importMulti:"obj obj",importPrivKey:"str str bool",importPrunedFunds:"str, str",importPubKey:"str",importWallet:"str",invalidateBlock:"str",joinPSBTs:"obj",keyPoolRefill:"",listAccounts:"int",listAddressGroupings:"",listBanned:"",listDescriptors:"",listLabels:"",listLockUnspent:"bool",listReceivedByAccount:"int bool",listReceivedByAddress:"int bool",listReceivedByLabel:"",listSinceBlock:"str int",listTransactions:"str int int",listUnspent:"int int",listWalletDir:"",listWallets:"",loadWallet:"str",lockUnspent:"",logging:"",move:"str str float int str",ping:"",preciousBlock:"str",prioritiseTransaction:"str float int",pruneBlockChain:"int",psbtBumpFee:"str",removePrunedFunds:"str",reScanBlockChain:"",saveMemPool:"",send:"obj",setHDSeed:"",setLabel:"str str",setWalletFlag:"str",scanTxOutSet:"str",sendFrom:"str str float int str str",sendMany:"str obj int str",sendRawTransaction:"str",sendToAddress:"str float str str",setAccount:"",setBan:"str str",setNetworkActive:"bool",setGenerate:"bool int",setTxFee:"float",signMessage:"",signMessageWithPrivKey:"str str",signRawTransaction:"",signRawTransactionWithKey:"str obj",signRawTransactionWithWallet:"str",stop:"",submitBlock:"str",submitHeader:"str",testMemPoolAccept:"obj",unloadWallet:"",upgradeWallet:"",uptime:"",utxoUpdatePSBT:"str",validateAddress:"",verifyChain:"",verifyMessage:"",verifyTxOutProof:"str",walletCreateFundedPSBT:"",walletDisplayAddress:"str",walletLock:"",walletPassPhrase:"string int",walletPassphraseChange:"",walletProcessPSBT:"str"};var It=function(t,e,n){return Array.prototype.slice.call(t,e,n)};function Kt(){return parseInt(1e5*Math.random())}!function(t,e,n){function r(t,e){return function(){var r=arguments.length-1;this.batchedCalls&&(r=arguments.length);for(var o=0;o<r;o++)e[o]&&(arguments[o]=e[o](arguments[o]));this.batchedCalls?this.batchedCalls.push({jsonrpc:"2.0",method:t,params:It(arguments),id:Kt()}):n.call(this,{method:t,params:It(arguments,0,arguments.length-1),id:Kt()},arguments[arguments.length-1])}}var o={str:function(t){return t.toString()},int:function(t){return parseFloat(t)},float:function(t){return parseFloat(t)},bool:function(t){return!0===t||"1"==t||"true"==t||"true"==t.toString().toLowerCase()},obj:function(t){return"string"==typeof t?JSON.parse(t):t}};for(var s in e){var i=[];if(e[s].length){i=e[s].split(" ");for(var a=0;a<i.length;a++)o[i[a]]?i[a]=o[i[a]]:i[a]=o.str}var c=s.toLowerCase();t.prototype[s]=r(c,i),t.prototype[c]=t.prototype[s]}}(At,At.callspec,Rt);var jt=At;const Ut=["travel upgrade inside soda birth essence junk merit never twenty system opinion","hover harsh text dice wealth pill across trade soccer olive view acquire","damp comfort scan couple absurd enter slogan cheap ketchup print syrup hurdle one document diamond","notable rose silver indicate wreck mean raise together jar fish seat air","lens release coil rain forward lemon cube satisfy inject visa ring segment"];class Dt extends class{constructor(t,e){this.chain=t,this.network=e}}{constructor(t,e,n){super(t,e),this.url=n}}const{PrivateKey:$t,Opcode:kt,Script:Mt,Mnemonic:Ht,crypto:Lt,Transaction:Gt,encoding:Ft}=e.Bitcoin;const{CHAIN:qt,NETWORK:Wt,BCN_URL:Jt}=xt;function Yt(t=0){return new Ht(Ut[t])}function zt(t=0){return function(t=0){return Yt(t).toHDPrivateKey("",Wt).derive(Z(qt,Wt))}(t).privateKey}function Xt(t=0){return zt(t).toPublicKey()}function Zt(t=0){return Xt(t).toAddress()}function Vt(t=1e5,n=0){const r=Mt.buildPublicKeyHashOut(Zt(n));return{address:Zt(n),txId:"a477af6b2667c29670467e4e0728b685ee07b240235771862318e29ddbe58458",outputIndex:n,script:r,vout:0,amount:t/1e8,satoshis:t,scriptPubKey:"",inspect:()=>"",toObject:()=>new e.Bitcoin.Transaction.UnspentOutput({})}}new Dt(qt,Wt,Jt);const{PrivateKey:Qt,Transaction:te,Script:ee,PublicKey:ne,crypto:{Point:re}}=e.Bitcoin;const{Interpreter:oe}=ee;const{Output:se}=te;const ie=Yt(1);const{MIN_NON_DUST_AMOUNT:ae}=U;const ce=new Dt(xt.CHAIN,xt.NETWORK,xt.BCN_URL);const ue=new I(ce,((t,e,n={})=>{const{path:r,passphrase:o}=n;let s=t.toHDPrivateKey(o,e);return r&&(s=s.derive(r)),s.privateKey})(ie,ce.network));const de=t=>({randomString:[...Array(Math.round(20*Math.random()))].map((()=>Math.random().toString(36)[2])).join(""),_owners:[t.getPublicKey().toString()],_amount:U.MIN_NON_DUST_AMOUNT,__cls:`class ${l.default.randomBytes(32).toString("hex")} {\n            constructor(n) {\n                this.n = n;\n            }\n            inc(n) {\n                this.n += n;\n                return this.n;\n            }\n        }`});beforeAll((()=>b(void 0,void 0,void 0,(function*(){yield b(void 0,void 0,void 0,(function*(){const t=(()=>{const t=xt.RPC_PROTOCOL;const e=xt.RPC_USER;const n=xt.RPC_PASSWORD;const r=xt.RPC_HOST;const o=xt.RPC_PORT;return new jt({protocol:t,user:e,pass:n,host:r,port:o})})();const e=w.default.promisify(jt.prototype.generateToAddress.bind(t));yield e(1,Zt(0)),yield e(1,Zt(1)),yield e(1,Zt(2)),yield e(1,Zt(3)),yield e(1,Zt(4)),yield e(100,(new Ht).toHDPrivateKey("",Wt).derive(Z(qt,Wt)).privateKey.toPublicKey().toAddress())}))}))),1e4),describe("DataTransaction",(()=>{describe("constructor",(()=>{it("should create a new data transaction",(()=>b(void 0,void 0,void 0,(function*(){const t=new dt(ce,new Qt);expect(t).toBeDefined();const e=t.tx.toJSON();expect(e.hash).toBe(t.tx.id),expect(e.version).toBe(1),expect(e.inputs.length).toBeDefined(),expect(e.inputs.length).toBe(0),expect(e.outputs.length).toBeDefined(),expect(e.outputs.length).toBe(0),expect(e.nLockTime).toBe(0)}))))})),describe("get inRevs",(()=>{const t=new lt(ie,ue);const e=new ht(t);it("Should work for put",(()=>b(void 0,void 0,void 0,(function*(){const n=[de(t),de(t)];const{inRevs:r}=yield e.createTx([],n);expect(r).toEqual([])}))),2e4),it("Should work for update",(()=>b(void 0,void 0,void 0,(function*(){const n=yield e.put([de(t)]);yield X(2e3);const r=yield e.update(n,[de(t)]);expect(r).toEqual([expect.any(String)]);const o=r[0].split("/")[0];yield X(2e3);const{inRevs:s}=yield dt.fromTxId(o,ce,t.getPrivateKey());expect(s).toEqual(n)}))),6e4),it.skip("Should work for an update to two different puts",(()=>b(void 0,void 0,void 0,(function*(){const n={a:"a".repeat(500)};const r=yield e.put([n,n]);yield X(2e3);const o=yield e.put([n]);const s=r.concat(...o);yield X(2e3);const i=(yield e.update(s,[de(t)]))[0].split("/")[0];const{inRevs:a}=yield dt.fromTxId(i,ce,t.getPrivateKey());expect(Tt(a,s)).toBe(!0)}))),1e5)})),describe("getOutData",(()=>{const t=new lt(ie,ue);const e=new ht(t);it("Should work for put",(()=>b(void 0,void 0,void 0,(function*(){const n=[de(t),de(t)];const r=yield e.createTx([],n);const o=yield r.getOutData(t.getPrivateKey());expect(o).toEqual(n)}))),2e4)})),describe("createDataOuts",(()=>{it("should broadcast a transaction using data",(()=>b(void 0,void 0,void 0,(function*(){const t=new lt(ie,ue);const e=t.getAddress();const n=yield t.getUtxos();const r=t.getPrivateKey();const o={_owners:[t.getPublicKey().toString()],_amount:ae,a:"a"};const s=new dt(ce,t.getPrivateKey());n.forEach((t=>s.tx.from([new te.UnspentOutput(t)]))),s.createDataOuts([o]),s.tx.change(e),s.tx.sign(r,U.SIGHASH_ALL);const{tx:i}=s;expect(i).toBeDefined(),expect(Array.isArray(i.inputs)).toBe(!0),expect(i.inputs.length).toBeGreaterThan(0),expect(Array.isArray(i.outputs)).toBe(!0),expect(s.tx.outputs.length).toBeGreaterThanOrEqual(2),expect(s.tx.outputs.length).toBeLessThanOrEqual(3);const a=yield ue.sendTransaction(i.toString());expect(a).toBeDefined()}))),2e4),it("should broadcast a transaction with a lot of data",(()=>b(void 0,void 0,void 0,(function*(){const t=new lt(ie,ue);const e=t.getAddress();const n="a".repeat(500);const r=yield t.getUtxos();const o=t.getPrivateKey();const s={_owners:[t.getPublicKey().toString()],_amount:ae,a:n};const i=new dt(ce,t.getPrivateKey());r.forEach((t=>i.tx.from([new te.UnspentOutput(t)]))),i.createDataOuts([s]),i.tx.change(e),i.tx.sign(o,U.SIGHASH_ALL),expect(i).toBeDefined(),expect(Array.isArray(i.tx.inputs)).toBe(!0),expect(i.tx.inputs.length).toBeGreaterThan(0),expect(Array.isArray(i.tx.outputs)).toBe(!0),expect(i.tx.outputs.length).toBeGreaterThanOrEqual(3),expect(i.tx.outputs.length).toBeLessThanOrEqual(24);const a=yield ue.sendTransaction(i.tx.toString());expect(a).toBeDefined()}))),6e4)})),describe("spendFromData",(()=>{it("should spend from an output",(()=>b(void 0,void 0,void 0,(function*(){const t=new Qt;const e=U.MIN_NON_DUST_AMOUNT;const n=U.SIGHASH_ALL;const r=[Xt(0),Xt(1),Xt(2)].map((t=>t.toString()));const o=new dt(ce,t);o.tx.from([new te.UnspentOutput(Vt())]),o.createDataOuts([Object.assign({_owners:r,_amount:e},{a:1})]),o.tx.sign(zt(),n);const s=new dt(ce,t);Object.defineProperty(s,"restClient",{get:jest.fn((()=>({getTransactions:()=>b(void 0,void 0,void 0,(function*(){return Promise.resolve([o.tx])}))})))}),yield s.spendFromData([`${o.tx.id}/0`]),s.tx.to(Zt(),1e4),s.tx.sign(zt(0),U.SIGHASH_ALL);const i=s.tx.inputs[0].script;const a=o.tx.outputs[0].script;const c=oe.SCRIPT_VERIFY_P2SH;const u=(new oe).verify(i,a,s.tx,0,c);expect(u).toEqual(!0)}))))})),describe("from",(()=>{it("should spend from a transaction with data",(()=>b(void 0,void 0,void 0,(function*(){const t=U.SIGHASH_ALL;const e=new lt(ie,ue);const n=e.getPrivateKey();const r=new Qt("KwF9LjRraetZuEjR8VqEq539z137LW5anYDUnVK11vM3mNMHTWb4");const o=new Qt("L4PqnaPTCkYhAqH3YQmefjxQP6zRcF4EJbdGqR8v6adtG9XSsadY");const s=r.publicKey;const i=o.publicKey;const a="1".repeat(32);const c=re.fromX(!1,a);const u=new ne(c);expect(u.point.getX().toString("hex",32)).toBe(a);const d=(new ee).add("OP_1").add(s.toBuffer()).add(i.toBuffer()).add(u.toBuffer()).add("OP_3").add("OP_CHECKMULTISIG");const l=yield e.getUtxos();const h=new dt(ce,e.getPrivateKey());l.forEach((t=>h.tx.from([new te.UnspentOutput(t)]))),h.tx.addOutput(new se({script:d,satoshis:U.MIN_NON_DUST_AMOUNT})),h.tx.change(e.getAddress()),h.tx.sign(n,t),yield X(2e3);const p=yield ue.sendTransaction(h.tx.toString());expect(p).toBeDefined()}))),2e4)})),describe("fromTxId",(()=>{it("should return a data transaction from a random txId",(()=>b(void 0,void 0,void 0,(function*(){const t=new lt(ie,ue);const e=yield t.getUtxos();const n={_owners:[t.getPublicKey().toString()],_amount:ae};const r={data:{a:Math.random().toString()}};const o=new dt(ce,t.getPrivateKey());e.forEach((t=>o.tx.from([new te.UnspentOutput(t)]))),o.createDataOuts([Object.assign(Object.assign({},n),r)]);const s=yield t.fundAndSendTransaction(o);yield X(2e3),expect(s).toBeDefined();const i=yield dt.fromTxId(s,ce,t.getPrivateKey());expect(i).toMatchObject({restClient:expect.anything(),tx:expect.anything(),outData:expect.anything()})}))),6e4)}))}));
