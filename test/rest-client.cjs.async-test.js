"use strict";var t=require("crypto");var e=require("hash.js");var n=require("bitcoin-computer-bitcore");var o=require("axios");var r=require("crypto-js");var s=require("eciesjs");var i=require("http");var c=require("https");var a=require("url");function u(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}function d(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(n){if("default"!==n){var o=Object.getOwnPropertyDescriptor(t,n);Object.defineProperty(e,n,o.get?o:{enumerable:!0,get:function(){return t[n]}})}})),e.default=t,Object.freeze(e)}require("util"),require("ses");var l=u(t);var h=u(e);var f=u(o);var p=u(r);var g=d(s);var v=u(i);var y=u(c);var x=u(a);function m(t,e){var n={};for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&e.indexOf(o)<0&&(n[o]=t[o]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(o=Object.getOwnPropertySymbols(t);r<o.length;r++)e.indexOf(o[r])<0&&Object.prototype.propertyIsEnumerable.call(t,o[r])&&(n[o[r]]=t[o[r]])}return n}function S(t,e,n,o){var r,s=arguments.length,i=s<3?e:null===o?o=Object.getOwnPropertyDescriptor(e,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(t,e,n,o);else for(var c=t.length-1;c>=0;c--)(r=t[c])&&(i=(s<3?r(i):s>3?r(e,n,i):r(e,n))||i);return s>3&&i&&Object.defineProperty(e,n,i),i}function w(t,e,n,o){return new(n||(n=Promise))((function(r,s){function i(t){try{a(o.next(t))}catch(t){s(t)}}function c(t){try{a(o.throw(t))}catch(t){s(t)}}function a(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(i,c)}a((o=o.apply(t,e||[])).next())}))}const b=process.env.CHAIN||"LTC";const B=process.env.NETWORK||"testnet";const _=process.env.BCN_URL||"https://node.bitcoincomputer.io";const O=parseInt(process.env.BC_DUST_LIMIT||"",10)||1546;const T=parseInt(process.env.BC_DEFAULT_FEE||"",10)||2500;var R={CHAIN:b,NETWORK:B,BCN_URL:_,MIN_NON_DUST_AMOUNT:O,SCRIPT_CHUNK_SIZE:parseInt(process.env.BC_SCRIPT_CHUNK_SIZE||"",10)||479,DEFAULT_FEE:T,SIGHASH_ALL:1,FEE_PER_KB:2e4,PUBLIC_KEY_SIZE:65,ANYONE_CAN_SPEND_SEED:"replace this seed",PASSPHRASE:"",ENCODING_LENGTH:3,ENCODING_NUMBER_LENGTH:3,MAX_PUBKEYS_PER_SCRIPT:3,OP_RETURN_SIZE:80};const{crypto:N}=n.Bitcoin;const E=(t,e)=>{const n=Date.now();const o=N.Hash.sha256(Buffer.from(e+n));const r=[N.ECDSA.sign(o,t,"big").toString("hex"),t.publicKey.toString(),n];return`Bearer ${Buffer.from(r.join(":")).toString("base64")}`};const P=(t,e,n={})=>{const{path:o,passphrase:r}=n;let s=t.toHDPrivateKey(r,e);return o&&(s=s.derive(o)),s.privateKey};const{Transaction:C}=n.Bitcoin;function A(t){return w(this,void 0,void 0,(function*(){if(!function(t){return void 0!==t.config}(t))throw new Error("Unknown error");const{message:e,config:n,response:o}=t;const r=function(t){try{const e=JSON.parse(t);if("object"!=typeof e)throw new Error("Invalid object");if("string"!=typeof e.txhex)throw new Error("Invalid object");return new C(e.txhex)}catch(t){return null}}(null==n?void 0:n.data);const s=`message\t${e}`;const i=`request\t${null==n?void 0:n.method} ${null==n?void 0:n.url}`;const c=r?`transaction\t ${JSON.stringify(r.toJSON(),null,2)}`:"";const a="post"===(null==n?void 0:n.method)?`data\t${null==n?void 0:n.data}`:"";const u=o?`response\t${JSON.stringify(o.data)}`:"";const d=r?c:a;throw t.message=`\n    Communication Error\n    ${s}\n    ${i}\n    ${d}\n    ${u}`,t}))}class D{constructor(t,e,n={}){this.baseUrl=t,this.headers=n,this.privateKey=e}get(t){return w(this,void 0,void 0,(function*(){const e=`${this.baseUrl}${t}`;try{let t={};return this.privateKey&&(t={Authentication:E(this.privateKey,this.baseUrl)}),(yield f.default.get(e,{headers:Object.assign(Object.assign({},this.headers),t)})).data}catch(t){return A(t)}}))}post(t,e){return w(this,void 0,void 0,(function*(){const n=`${this.baseUrl}${t}`;try{let t={};return this.privateKey&&(t={Authentication:E(this.privateKey,this.baseUrl)}),(yield f.default.post(n,e,{headers:Object.assign(Object.assign({},this.headers),t)})).data}catch(t){return A(t)}}))}delete(t){return w(this,void 0,void 0,(function*(){const e=`${this.baseUrl}${t}`;try{let t={};return this.privateKey&&(t={Authentication:E(this.privateKey,this.baseUrl)}),(yield f.default.delete(e,{headers:Object.assign(Object.assign({},this.headers),t)})).data}catch(t){return A(t)}}))}}const{PrivateKey:$,Transaction:I}=n.Bitcoin;function K(t){if(!/^[0-9A-Fa-f]{64}$/.test(t))throw new Error(`Invalid txId: ${t}`)}function U(t){if(!/^[0-9A-Fa-f]{64}\/\d+$/.test(t))throw new Error(`Invalid outId: ${t}`)}function j(t){U(t);const[e,n]=t.split("/");return{txId:e,outputIndex:parseInt(n,10)}}let k=class{constructor(t,e=new $){this.nodeConfig=t,this.bcn=new D(t.url,e)}get chain(){return this.nodeConfig.chain}get network(){return this.nodeConfig.network}getBalance(t){return w(this,void 0,void 0,(function*(){const{chain:e,network:n}=this;return yield this.bcn.get(`/v1/${e}/${n}/address/${t}/balance`)}))}getTransaction(t){return w(this,void 0,void 0,(function*(){return new I(yield this.getRawTx(t))}))}getRawTx(t){return w(this,void 0,void 0,(function*(){K(t);const{chain:e,network:n}=this;return this.bcn.get(`/v1/${e}/${n}/tx/${t}`)}))}getRawTxData(t){return w(this,void 0,void 0,(function*(){K(t);const{chain:e,network:n}=this;return this.bcn.get(`/v1/${e}/${n}/tx-data/${t}`)}))}getTransactions(t){return w(this,void 0,void 0,(function*(){return(yield this.getRawTxs(t)).map((t=>new I(t)))}))}getRawTxs(t){return w(this,void 0,void 0,(function*(){t.map(K);const{chain:e,network:n}=this;return this.bcn.post(`/v1/${e}/${n}/tx/bulk/`,{txIds:t})}))}sendTransaction(t){return w(this,void 0,void 0,(function*(){return this.bcn.post(`/v1/${this.chain}/${this.network}/tx/send`,{rawTx:t})}))}getUtxosFromAddress(t){return w(this,void 0,void 0,(function*(){const{chain:e,network:n}=this;return this.bcn.get(`/v1/${e}/${n}/wallet/${t.toString()}/utxos`)}))}postNonStandardUtxo(t){return w(this,void 0,void 0,(function*(){const{chain:e,network:n}=this;return this.bcn.post(`/v1/${e}/${n}/non-standard-utxo`,t)}))}getOwnedRevs(t){return w(this,void 0,void 0,(function*(){const{chain:e,network:n}=this;return this.bcn.get(`/v1/${e}/${n}/wallet/${t.toString()}/non-standard-utxos`)}))}queryRevs(t){return w(this,void 0,void 0,(function*(){const{publicKey:e,contractName:n,contractHash:o}=t;if(void 0===e&&void 0===n&&void 0===o)throw new Error("Filter parameter for queryRevs endpoint cannot be empty.");let r="";e&&(r+=`?publicKey=${e}`),n&&(r+=0===r.length?"?":"&",r+=`contractName=${n}`),o&&(r+=0===r.length?"?":"&",r+=`contractHash=${o}`);const{chain:s,network:i}=this;return this.bcn.get(`/v1/${s}/${i}/non-standard-utxos${r}`)}))}getLatestRev(t){return w(this,void 0,void 0,(function*(){U(t);const{chain:e,network:n}=this;const[{rev:o}]=yield this.bcn.get(`/v1/${e}/${n}/rev/${t}`);return o}))}getLatestRevs(t){return w(this,void 0,void 0,(function*(){t.map(U),t.map(U);const{chain:e,network:n}=this;return yield this.bcn.post(`/v1/${e}/${n}/revs`,{ids:t})}))}static getSecretOutput({_url:t,privateKey:e}){return w(this,void 0,void 0,(function*(){const n=t.split("/");const o=n[n.length-1];const r=n.slice(0,-2).join("/");const s=new D(r,e);return{host:r,data:yield s.get(`/v1/store/${o}`)}}))}static setSecretOutput({secretOutput:t,host:e,privateKey:n}){return w(this,void 0,void 0,(function*(){return new D(e,n).post("/v1/store/",t)}))}static deleteSecretOutput({_url:t,privateKey:e}){return w(this,void 0,void 0,(function*(){const n=t.split("/");const o=n[n.length-1];const r=n.slice(0,-2).join("/");const s=new D(r,e);yield s.delete(`/v1/store/${o}`)}))}};k=S([t=>t],k);const{PublicKey:H,crypto:M}=n.Bitcoin;const{Point:L}=M;function F(t){return Buffer.from(t,"hex").toString().replace(/\0/g,"")}function q(t,e){return t.slice(e)+t.slice(0,e)}function G(t,e,n){if(t.length*Math.log2(e)>53)throw new Error(`Input too large ${t.length} ${Math.log2(e)}`);if(![2,10,16].includes(e)||![2,10,16].includes(n))throw new Error("ToBase or FromBase invalid in covertNumber.");if(2===e&&t.length%8!=0)throw new Error("Binary strings must be byte aligned.");if(16===e&&t.length%2!=0)throw new Error("Hex strings must be of even length.");const o=parseInt(t,e).toString(n);return 2===n?o.padStart(8*Math.ceil(o.length/8),"0"):16===n?o.padStart(2*Math.ceil(o.length/2),"0"):o}function W(t,e){const n=new RegExp(`.{1,${e}}`,"g");return t.match(n)||[]}function J(t){return W(t,2).map((t=>G(t,16,2))).join("")}function Y(t){return W(t,8).map((t=>G(t,2,16))).join("")}function z(t){return t.toString(16).padStart(R.ENCODING_NUMBER_LENGTH,"0")}function V(t){return parseInt(t,16)}function Z(t){if(62!==t.length)throw new Error("Input to hexToPublicKey must be of length 62");let e=!1;let n=0;let o;for(;!e;){if(n>=256)throw new Error("Something went wrong storing data");const r=n.toString(16).padStart(2,"0")+Y(q(J(t).padStart(64,"0"),n));try{o=L.fromX(!1,r),e=!0}catch(t){n+=1}}if(!o)throw new Error("Something went wrong storing data");return new H(o)}function X(t){const e=t.point.getX().toString("hex").padStart(64,"0");const n=G(e.slice(0,2),16,10);return Y((r=parseInt(n,10),(o=J(e.slice(2))).slice(-r)+o.slice(0,-r)));var o,r}function Q(t){return new Promise((e=>{setTimeout(e,t)}))}function tt(t,e){return`m/44'/${function(t,e){if("testnet"===e||"regtest"===e)return"1";if("BTC"===t)return"0";if("LTC"===t)return"2";if("DOGE"===t)return"3";if("BCH"===t)return"145";if("BSV"===t)return"236";throw new Error(`Unsupported chain ${t}`)}(t,e)}'/0'/0/0`}const{PublicKey:et,Script:nt}=n.Bitcoin;function ot(t){if(t.length>R.MAX_PUBKEYS_PER_SCRIPT)throw new Error("Too many owners");return function(t){const e=new nt;return e.add("OP_1"),t.forEach((t=>{e.add(t)})),e.add(`OP_${t.length}`),e.add("OP_CHECKMULTISIG"),e}(t.map((t=>t.toBuffer())))}function rt(t){return function(t){return t.chunks.filter((t=>t.buf)).map((t=>t.buf))}(t).map((t=>et.fromBuffer(t)))}function st(t){return Buffer.from(p.default.SHA256(t).toString(),"hex").toString("hex").substr(0,4)}function ct(t){return`${st(t)};${t}`}function at(t){const e=t.substr(0,4);const n=t.substr(5);if(!function(t,e){return st(t)===e}(n,e))throw new Error("Decryption failure");return n}function ut(t){if(void 0!==t._readers){const{_readers:e,_url:n,_owners:o,_amount:r}=t,s=m(t,["_readers","_url","_owners","_amount"]);const i=function(t,e){const n=l.default.randomBytes(32).toString("hex");const o=function(t,e){if(!/^[0-9a-f]{64}$/.test(e))throw new Error("Invalid secret");const n=Buffer.from(e,"hex").toString("binary");const o=ct(t);return p.default.AES.encrypt(o,n).toString()}(t,n);const r=e.map((t=>function(t,e){if(!/^0[2-3][0-9a-f]{64}|04[0-9a-f]{128}$/.test(e))throw new Error("Invalid publicKey");const n=ct(t);return g.encrypt(e,Buffer.from(n,"utf8")).toString("base64")}(n,t)));return{__cypher:o,__secrets:r}}(JSON.stringify(s),e);return void 0!==n&&(i._url=n),void 0!==o&&(i._owners=o),void 0!==r&&(i._amount=r),i}return t}const{Transaction:dt}=n.Bitcoin;const{Output:lt}=dt;const{UnspentOutput:ht}=dt;let ft=class{constructor(t,e,n){const o=new dt(n);o.feePerKb(R.FEE_PER_KB),this.nodeConfig=t,this.tx=o,this.outData=[],this.privateKey=e}get txId(){return this.tx.id}get chain(){return this.nodeConfig.chain}get network(){return this.nodeConfig.network}get restClient(){return new k(this.nodeConfig,this.privateKey)}get inputs(){return this.tx.inputs.map((t=>`${t.prevTxId.toString("hex")}/${t.outputIndex}`))}get inRevs(){const{enc:t}=this;let[e]=t;return e=Number.isFinite(e)?e:0,this.tx.inputs.slice(0,e).map((({prevTxId:t,outputIndex:e})=>`${t.toString("hex")}/${e}`))}get outRevs(){const{enc:t}=this;let[,e]=t;return e=Number.isFinite(e)?e:0,Array.from(Array(e).keys()).map((t=>`${this.tx.id}/${t}`))}get opReturns(){try{const{outputs:t}=this.tx;return t.filter((({script:t})=>t.isDataOut())).map((({script:t})=>t.getData())).map((t=>t.toString())).join()}catch(t){return""}}get enc(){return W(this.opReturns.slice(0,R.ENCODING_LENGTH*R.ENCODING_NUMBER_LENGTH),R.ENCODING_NUMBER_LENGTH).map(V)}get dataPrefix(){return this.opReturns.slice(9)}getOwnerOutputs(){const{enc:t}=this;const[,e=0]=t;return this.tx.outputs.slice(0,e)}getDataOutputs(){const{enc:t}=this;const[,e,n]=t;return this.tx.outputs.slice(e,n)}getOutData(t){return w(this,void 0,void 0,(function*(){try{const e=this.getDataOutputs().map((t=>t.script)).map((t=>rt(t))).flat().map(X).map(F).join("");const{dataPrefix:n}=this;const o=JSON.parse(n+e);const r=t.toBuffer().toString("hex");const s=this.getOwnerOutputs();if(s.length!==o.length)throw new Error("Inconsistent state");const i=s.map(((t,e)=>Object.assign(Object.assign({},o[e]),{_owners:rt(t.script).map((t=>t.toString())),_amount:t.satoshis})));return Promise.all(i.map((e=>w(this,void 0,void 0,(function*(){try{const n=yield function(t){return e=>w(this,void 0,void 0,(function*(){if(function(t){return void 0!==t._url}(e)){const{_url:n}=e,o=m(e,["_url"]);const{host:r,data:s}=yield k.getSecretOutput({_url:n,privateKey:t});return Object.assign(Object.assign(Object.assign({},o),JSON.parse(s)),{_url:r})}return e}))}(t)(e);return function(t,e){if(function(t){return void 0!==t.__cypher&&void 0!==t.__secrets}(t)){const{__cypher:n,__secrets:o}=t,r=m(t,["__cypher","__secrets"]);return Object.assign(Object.assign(Object.assign({},r),JSON.parse(function({__cypher:t,__secrets:e},n){let o="";if(n.forEach((n=>{e.forEach((e=>{try{const r=function(t,e){if(!/^[0-9a-f]{64}$/.test(e))throw new Error("Invalid privateKey");return at(g.decrypt(e,Buffer.from(t,"base64")).toString("utf8"))}(e,n);o=function(t,e){if(!/^[0-9a-f]{64}$/.test(e))throw new Error("Invalid secret");const n=Buffer.from(e,"hex").toString("binary");return at(p.default.AES.decrypt(t,n).toString(p.default.enc.Utf8))}(t,r)}catch(t){const e=["Decryption failure","Unsupported state or unable to authenticate data"];if(t instanceof Error&&!e.includes(t.message))throw t}}))})),o)return o;throw new Error("Decryption failure")}({__cypher:n,__secrets:o},e))),{_readers:[]})}return t}(n,[r])}catch(t){return null}})))))}catch(t){return[]}}))}getOwners(){return this.getOwnerOutputs().map((t=>rt(t.script).map((t=>t.toString()))))}getAmounts(){return this.getOwnerOutputs().map((t=>t.satoshis))}spendFromData(t){return w(this,void 0,void 0,(function*(){if(!t.length)return;const e=t.map(j);const o=e.map((t=>t.txId));const r=yield this.restClient.getTransactions(o);for(let t=0;t<e.length;t+=1){const{txId:o,outputIndex:s}=e[t];const{outputs:i}=r[t];const c=i[s];const a=Math.round(c.satoshis);const u=new n.Bitcoin.Script(c.script);const d=new ht({txId:o,outputIndex:s,satoshis:a,script:u});const l=rt(u).map((t=>t.toString()));this.tx.from([d],l,1)}}))}createOpReturnOut(t){this.tx.addData(JSON.stringify(t))}createDataOuts(t){t.forEach((({_amount:t,_owners:e=[]})=>{if(Array.isArray(e)&&e.length>R.MAX_PUBKEYS_PER_SCRIPT)throw new Error("Too many owners.");const o=e.map((t=>n.Bitcoin.PublicKey.fromString(t)));const r=t||R.MIN_NON_DUST_AMOUNT;const s=ot(o);this.tx.addOutput(new lt({script:s,satoshis:r}))}));const e=t.map((t=>m(t,["_amount","_owners"])));const o=R.MIN_NON_DUST_AMOUNT;const r=JSON.stringify(e);const s=R.OP_RETURN_SIZE-R.ENCODING_LENGTH*R.ENCODING_NUMBER_LENGTH;const i=r.slice(0,s);const c=function(t){var e;return function(t,e){const n=[];for(let o=0;o<t.length;o+=e)n.push(t.slice(o,o+e));return n}(W((e=t,Buffer.from(e).toString("hex")),62).map((t=>t.padStart(62,"0"))).map(Z),R.MAX_PUBKEYS_PER_SCRIPT).map((t=>ot(t)))}(r.slice(s));const a=z(this.tx.inputs.length)+z(this.tx.outputs.length)+z(this.tx.outputs.length+c.length);c.forEach((t=>{this.tx.addOutput(new lt({script:t,satoshis:o}))})),this.tx.addData(a+i)}static fromTxHex(t,e,n){return w(this,void 0,void 0,(function*(){const o=new this(e,n);o.tx.fromString(t);const r=yield o.getOutData(n);const s=o.getOwners();const i=o.getAmounts();return o.outData=r.map(((t,e)=>Object.assign(Object.assign({},t),{_owners:s[e],_amount:i[e]}))),o}))}static fromTxId(t,e,n){return w(this,void 0,void 0,(function*(){const o=new k(e,n);const r=yield o.getRawTx(t);return this.fromTxHex(r,e,n)}))}};ft=S([t=>t],ft);class pt{constructor(t,e,n={}){const{chain:o,network:r}=e;const{path:s=tt(o,r),passphrase:i=""}=n;let c=t.toHDPrivateKey(i,r);s&&(c=c.derive(s));const a=c.publicKey.toAddress(r);this.mnemonic=t,this.restClient=e,this.path=s,this.passphrase=i,this.hdPrivateKey=c,this.address=a}get chain(){return this.restClient.chain}get network(){return this.restClient.network}get nodeConfig(){return this.restClient.nodeConfig}getMnemonic(){return this.mnemonic}derive(t="0"){const e=`${this.path}${this.path.length>0?"/":""}${t}`;return new pt(this.mnemonic,this.restClient,{path:e})}getPrivateKey(){return this.hdPrivateKey.privateKey}getPublicKey(){return this.hdPrivateKey.publicKey}getAddress(){return this.address}getBalance(){return w(this,void 0,void 0,(function*(){return this.restClient.getBalance(this.getAddress())}))}getUtxos(t=this.getAddress()){return w(this,void 0,void 0,(function*(){return this.restClient.getUtxosFromAddress(t)}))}selectUtxos(t,e){let n=0;const o=[];!function(t){const e=t;for(let t=e.length-1;t>0;t-=1){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}}(t);for(let r=0;r<t.length;r+=1){const s=t[r];if(n+=1e8*s.amount,o.push(s),n>=e)return o}const{network:r,chain:s}=this.restClient.nodeConfig;throw new Error(`Insufficient balance in address ${this.getAddress().toString()} on ${r} ${s}. Found ${n}, required ${e}.`)}fundAndSendTransaction(t){return w(this,void 0,void 0,(function*(){t.tx.feePerKb(R.FEE_PER_KB);const{chain:e,network:o}=this.nodeConfig;const{enc:r}=t;const[,s]=r;const i=s*function(t){if("LTC"===t)return 8e3;if("BTC"===t)return 22;if("DOGE"===t)return 7e6;if("BCH"===t)return 2700;throw new Error(`Unsupported chain ${t}`)}(e);const c=.001*t.tx._getOutputAmount();const a=Math.max(R.MIN_NON_DUST_AMOUNT,i+c);t.tx.to(function(t,e){const n={"any-testnet":"gLjNGbKQzxqKA9bv2nhn1Ewf7rxYVXgrtR","BTC-mainnet":"84ZHRqRPTcUv6AFGMVC1KmSUeC9Y8SNfMm","LTC-mainnet":"mov5ivrsqWut5ffZhiz18uAkwy2D4y98iz","DOGE-mainnet":"1MVukPYmWdbEoxy3Sqq1ES4nYqDfpB5e68","BCH-mainnet":"P9CmJszhvARfQc8YjUW1K2oBnus1ZQWEqk","BSV-mainnet":"G2wxQ74zX48WMo7sfiX1faGGNQB8ebVth"};return q("testnet"===e||"regtest"===e?n["any-testnet"]:n[`${t}-${e}`],19)}(e,o),Math.round(a));let u=t.tx._getInputAmount();const d=t.tx._getOutputAmount();const l=t.tx._estimateFee();let h=d-u+Math.round(l);for(;h>0;){const e=yield this.getUtxos(this.getAddress());this.selectUtxos(e,h).forEach((e=>{t.tx.from([new n.Bitcoin.Transaction.UnspentOutput(e)])})),u=t.tx._getInputAmount(),h=d-u+Math.round(t.tx._estimateFee())}t.tx.change(this.getAddress()),t.tx.sign(this.getPrivateKey(),R.SIGHASH_ALL);const f=yield this.restClient.sendTransaction(t.tx.toString());return yield this.storeResult(f,t),f}))}storeResult(t,e){return w(this,void 0,void 0,(function*(){const{inputs:n,inRevs:o,outRevs:r}=e;const s=yield e.getOutData(this.getPrivateKey());const i=JSON.stringify(s);yield this.restClient.postNonStandardUtxo({outData:i,txId:t,inputs:n,inRevs:o,outRevs:r})}))}send(t,e){return w(this,void 0,void 0,(function*(){const n=new ft(this.restClient.nodeConfig,this.getPrivateKey());return n.tx.to(e,t),this.fundAndSendTransaction(n)}))}}const{CHAIN:gt="LTC",NETWORK:vt="regtest",RPC_USER:yt,RPC_PASSWORD:xt,RPC_HOST:mt}=process.env;const St="LTC"===process.env.CHAIN?19332:8332;var wt=Object.assign(Object.assign({},R),{CHAIN:gt,NETWORK:vt,BCN_URL:"http://127.0.0.1:3000",RPC_PROTOCOL:"http",RPC_USER:yt,RPC_PASSWORD:xt,RPC_HOST:mt,RPC_PORT:St,TEST_ADDRESSES:"moMoH1vTgCc2dkDfGSKYPnafxy22wSqgrr;mmQEk8VwtSehRryLF8jhVapYg553hJGhNa;miKQVhZbFKSsJcQZ8eXwBQ89xNyetpN34q;mzoGRNh55y9j57TPdwRGi3nt9X4CFwpqUS;n1X6JFDyxibtdhYrc7mrkuft6o168ELFNW;mjLcig6eTZVJkgRgJFMkwrYHpfMnZ1t4kk;mfYkMQAe7afeRSkgLxAtwnMVryjLTfr95Q"});var bt=v.default;var Bt=y.default;var _t=x.default;function Ot(t){"string"==typeof t&&(t=function(t){var e=_t.parse(t);var n=e.hostname;var o=parseInt(e.port,10);var r=e.protocol;r=r.substring(0,r.length-1);var s=e.auth.split(":");return{host:n,port:o,protocol:r,user:s[0]?decodeURIComponent(s[0]):null,pass:s[1]?decodeURIComponent(s[1]):null}}(t)),t=t||{},this.host=t.host||"127.0.0.1",this.port=t.port||8332,this.user=t.user||"user",this.pass=t.pass||"pass",this.protocol="http"===t.protocol?bt:Bt,this.batchedCalls=null,this.disableAgent=t.disableAgent||!1;var e=void 0!==t.rejectUnauthorized;this.rejectUnauthorized=!e||t.rejectUnauthorized,Ot.config.log?this.log=Ot.config.log:this.log=Ot.loggers[Ot.config.logger||"normal"]}var Tt=console.log.bind(console);var Rt=function(){};function Nt(t,e){var n=this;t=JSON.stringify(t);var o=this.user+":"+this.pass;var r=Buffer.from&&Buffer.from!==Uint8Array.from?Buffer.from(o):new Buffer(o);this.auth=r.toString("base64");var s={host:n.host,path:"/",method:"POST",port:n.port,rejectUnauthorized:n.rejectUnauthorized,agent:!n.disableAgent&&void 0};if(n.httpOptions)for(var i in n.httpOptions)s[i]=n.httpOptions[i];var c=!1;var a="Bitcoin JSON-RPC: ";var u=this.protocol.request(s,(function(t){var o="";t.on("data",(function(t){o+=t})),t.on("end",(function(){if(!c)if(c=!0,401!==t.statusCode)if(403!==t.statusCode){if(500===t.statusCode&&"Work queue depth exceeded"===o.toString("utf8")){var r=new Error("Bitcoin JSON-RPC: "+o.toString("utf8"));return r.code=429,void e(r)}var s;try{s=JSON.parse(o)}catch(r){n.log.err(r.stack),n.log.err(o),n.log.err("HTTP Status code:"+t.statusCode);var i=new Error(a+"Error Parsing JSON: "+r.message);return void e(i)}e(s.error,s)}else e(new Error(a+"Connection Rejected: 403 Forbidden"));else e(new Error(a+"Connection Rejected: 401 Unnauthorized"))}))}));u.on("error",(function(t){var n=new Error(a+"Request Error: "+t.message);c||(c=!0,e(n))})),u.setHeader("Content-Length",t.length),u.setHeader("Content-Type","application/json"),u.setHeader("Authorization","Basic "+n.auth),u.write(t),u.end()}Ot.loggers={none:{info:Rt,warn:Rt,err:Rt,debug:Rt},normal:{info:Tt,warn:Tt,err:Tt,debug:Rt},debug:{info:Tt,warn:Tt,err:Tt,debug:Tt}},Ot.config={logger:"normal"},Ot.prototype.batch=function(t,e){this.batchedCalls=[],t(),Nt.call(this,this.batchedCalls,e),this.batchedCalls=null},Ot.callspec={abandonTransaction:"str",abortRescan:"",addMultiSigAddress:"",addNode:"",analyzePSBT:"str",backupWallet:"",bumpFee:"str",clearBanned:"",combinePSBT:"obj",combineRawTransaction:"obj",convertToPSBT:"str",createMultiSig:"",createPSBT:"obj",createRawTransaction:"obj obj",createWallet:"str",decodePSBT:"str",decodeScript:"str",decodeRawTransaction:"",deriveAddresses:"str",disconnectNode:"",dumpPrivKey:"",dumpWallet:"str",encryptWallet:"",enumerateSigners:"",estimateFee:"",estimateSmartFee:"int str",estimatePriority:"int",generate:"int",generateBlock:"str obj",generateToAddress:"int str",generateToDescriptor:"int str",getAccount:"",getAccountAddress:"str",getAddedNodeInfo:"",getAddressMempool:"obj",getAddressUtxos:"obj",getAddressBalance:"obj",getAddressDeltas:"obj",getAddressesByLabel:"str",getAddressInfo:"str",getAddressTxids:"obj",getAddressesByAccount:"",getBalance:"str int",getBalances:"",getBestBlockHash:"",getBlockDeltas:"str",getBlock:"str int",getBlockchainInfo:"",getBlockCount:"",getBlockFilter:"str",getBlockHashes:"int int obj",getBlockHash:"int",getBlockHeader:"str",getBlockNumber:"",getBlockStats:"str",getBlockTemplate:"",getConnectionCount:"",getChainTips:"",getChainTxStats:"",getDescriptorInfo:"str",getDifficulty:"",getGenerate:"",getHashesPerSec:"",getIndexInfo:"",getInfo:"",getMemoryInfo:"",getMemoryPool:"",getMemPoolAncestors:"str",getMemPoolDescendants:"str",getMemPoolEntry:"str",getMemPoolInfo:"",getMiningInfo:"",getNetTotals:"",getNetworkHashPS:"",getNetworkInfo:"",getNewAddress:"str str",getNodeAddresses:"",getPeerInfo:"",getRawChangeAddress:"",getRawMemPool:"bool",getRawTransaction:"str int",getReceivedByAccount:"str int",getReceivedByAddress:"str int",getReceivedByLabel:"str",getRpcInfo:"",getSpentInfo:"obj",getTransaction:"",getTxOut:"str int bool",getTxOutProof:"",getTxOutSetInfo:"",getUnconfirmedBalance:"",getWalletInfo:"",getWork:"",getZmqNotifications:"",finalizePSBT:"str",fundRawTransaction:"str",help:"",importAddress:"str str bool",importDescriptors:"str",importMulti:"obj obj",importPrivKey:"str str bool",importPrunedFunds:"str, str",importPubKey:"str",importWallet:"str",invalidateBlock:"str",joinPSBTs:"obj",keyPoolRefill:"",listAccounts:"int",listAddressGroupings:"",listBanned:"",listDescriptors:"",listLabels:"",listLockUnspent:"bool",listReceivedByAccount:"int bool",listReceivedByAddress:"int bool",listReceivedByLabel:"",listSinceBlock:"str int",listTransactions:"str int int",listUnspent:"int int",listWalletDir:"",listWallets:"",loadWallet:"str",lockUnspent:"",logging:"",move:"str str float int str",ping:"",preciousBlock:"str",prioritiseTransaction:"str float int",pruneBlockChain:"int",psbtBumpFee:"str",removePrunedFunds:"str",reScanBlockChain:"",saveMemPool:"",send:"obj",setHDSeed:"",setLabel:"str str",setWalletFlag:"str",scanTxOutSet:"str",sendFrom:"str str float int str str",sendMany:"str obj int str",sendRawTransaction:"str",sendToAddress:"str float str str",setAccount:"",setBan:"str str",setNetworkActive:"bool",setGenerate:"bool int",setTxFee:"float",signMessage:"",signMessageWithPrivKey:"str str",signRawTransaction:"",signRawTransactionWithKey:"str obj",signRawTransactionWithWallet:"str",stop:"",submitBlock:"str",submitHeader:"str",testMemPoolAccept:"obj",unloadWallet:"",upgradeWallet:"",uptime:"",utxoUpdatePSBT:"str",validateAddress:"",verifyChain:"",verifyMessage:"",verifyTxOutProof:"str",walletCreateFundedPSBT:"",walletDisplayAddress:"str",walletLock:"",walletPassPhrase:"string int",walletPassphraseChange:"",walletProcessPSBT:"str"};var Et=function(t,e,n){return Array.prototype.slice.call(t,e,n)};function Pt(){return parseInt(1e5*Math.random())}!function(t,e,n){function o(t,e){return function(){var o=arguments.length-1;this.batchedCalls&&(o=arguments.length);for(var r=0;r<o;r++)e[r]&&(arguments[r]=e[r](arguments[r]));this.batchedCalls?this.batchedCalls.push({jsonrpc:"2.0",method:t,params:Et(arguments),id:Pt()}):n.call(this,{method:t,params:Et(arguments,0,arguments.length-1),id:Pt()},arguments[arguments.length-1])}}var r={str:function(t){return t.toString()},int:function(t){return parseFloat(t)},float:function(t){return parseFloat(t)},bool:function(t){return!0===t||"1"==t||"true"==t||"true"==t.toString().toLowerCase()},obj:function(t){return"string"==typeof t?JSON.parse(t):t}};for(var s in e){var i=[];if(e[s].length){i=e[s].split(" ");for(var c=0;c<i.length;c++)r[i[c]]?i[c]=r[i[c]]:i[c]=r.str}var a=s.toLowerCase();t.prototype[s]=o(a,i),t.prototype[a]=t.prototype[s]}}(Ot,Ot.callspec,Nt);const Ct=["travel upgrade inside soda birth essence junk merit never twenty system opinion","hover harsh text dice wealth pill across trade soccer olive view acquire","damp comfort scan couple absurd enter slogan cheap ketchup print syrup hurdle one document diamond","notable rose silver indicate wreck mean raise together jar fish seat air","lens release coil rain forward lemon cube satisfy inject visa ring segment"];class At{constructor(t){this.wallet=t}get chain(){return this.wallet.chain}get network(){return this.wallet.network}get nodeConfig(){return this.wallet.nodeConfig}fromTxHex(t){return w(this,void 0,void 0,(function*(){const{wallet:e,nodeConfig:n}=this;const o=e.getPrivateKey();return ft.fromTxHex(t,n,o)}))}fromTxId(t){return w(this,void 0,void 0,(function*(){const{wallet:e,nodeConfig:n}=this;const o=new k(n,e.getPrivateKey());const r=yield o.getRawTx(t);return this.fromTxHex(r)}))}get(t){return w(this,void 0,void 0,(function*(){const e=t.map(j);return Promise.all(e.map((({txId:t,outputIndex:e})=>w(this,void 0,void 0,(function*(){const{outData:n}=yield this.fromTxId(t);if(e>n.length)throw new Error("Index out of bounds");return n[e]})))))}))}put(t){return this.update([],t)}createTx(t,e){return w(this,void 0,void 0,(function*(){const{wallet:n,nodeConfig:o}=this;const r=n.getPrivateKey();const s=new ft(o,r);const i=e.map((t=>{var{_owners:e}=t,n=m(t,["_owners"]);return Object.assign({_owners:e||[this.wallet.getPublicKey().toString()]},n)})).map(ut);const c=yield Promise.all(i.map(function(t){return e=>w(this,void 0,void 0,(function*(){if(void 0!==e._url){const{_url:n,_owners:o,_amount:r}=e,s=m(e,["_url","_owners","_amount"]);const i=yield k.setSecretOutput({host:n,secretOutput:{data:JSON.stringify(s)},privateKey:t});return void 0!==o&&(i._owners=o),void 0!==r&&(i._amount=r),i}return e}))}(r)));return yield s.spendFromData(t),yield s.createDataOuts(c),s}))}update(t,e){return w(this,void 0,void 0,(function*(){const n=yield this.createTx(t,e);return yield this.wallet.fundAndSendTransaction(n),n.outRevs}))}}class Dt extends class{constructor(t,e){this.chain=t,this.network=e}}{constructor(t,e,n){super(t,e),this.url=n}}const{PrivateKey:$t,Opcode:It,Script:Kt,Mnemonic:Ut,crypto:jt,Transaction:kt,encoding:Ht}=n.Bitcoin;const Mt=new Dt(wt.CHAIN,wt.NETWORK,wt.BCN_URL);function Lt(t=0){return new Ut(Ct[t])}function Ft(t=0){return function(t=0){return Lt(t).toHDPrivateKey("",wt.NETWORK)}(t).privateKey}function qt(t=0){return function(t=0){return Ft(t).toPublicKey()}(t).toAddress()}const Gt=(t=0)=>w(void 0,void 0,void 0,(function*(){const e=Lt(t);const n=P(e,wt.NETWORK);const o=new k(Mt,n);const r=new pt(e,o,{});const s=new At(r);const[i]=yield s.put([{a:1}]);const[c]=i.split("/");return c}));const Wt=Lt(1);const Jt=Lt(2);const Yt=P(Wt,wt.NETWORK);const zt=P(Jt,wt.NETWORK);const{Transaction:Vt,Address:Zt,PrivateKey:Xt,PublicKey:Qt}=n.Bitcoin;const te=new Dt(wt.CHAIN,wt.NETWORK,wt.BCN_URL);const ee=new k(te,Yt);const ne=new k(te,zt);const oe=new pt(Wt,ee,{});const re=new pt(Jt,ne,{});expect.extend({reallyAnything:()=>({pass:!0,message:()=>""})});const se=(t,e)=>{if("BCH"===t&&"testnet"===e)return"muxV6vsSV85yNDSJXZEx3vf66ecTFvTnci";if("BCH"===t&&"livenet"===e)return"17dRYrqakYBot4P1Hf6eAM64yKGgpFbVzx";if("LTC"===t&&"regtest"===e)return"2MvciC8pyRyeY5FnVQmzpMfaLxdWL3qgKkk";throw new Error("Something when wrong.")};describe("RestClient",(()=>{describe("getBalance",(()=>{it("Should retrieve the balance for a given address",(()=>w(void 0,void 0,void 0,(function*(){const t=new Zt(se(wt.CHAIN,wt.NETWORK));const e=yield ee.getBalance(t);expect(e).toBeDefined()}))),2e4)})),describe("getTransaction",(()=>{it("Should retrieve the transaction for a given id",(()=>w(void 0,void 0,void 0,(function*(){const t=yield Gt();const e=yield ee.getTransaction(t);if(expect(e).toBeDefined(),expect(e.outputs).toBeDefined(),expect(typeof e.outputs.length).toBe("number"),e.outputs.length){const[t]=e.outputs;expect(t.script).toBeDefined(),expect(t.satoshis).toBeDefined()}}))),2e4)})),describe("getRawTx",(()=>{it("Should retrieve the raw transaction for a given block id",(()=>w(void 0,void 0,void 0,(function*(){const t=yield Gt();const e=yield ee.getRawTx(t);expect(e).toBeDefined(),expect(typeof e).toBe("string"),expect(e.length).toBeGreaterThan(5)}))),2e4)})),describe("getRawTxData",(()=>{it("Should retrieve the raw transaction for a given block id",(()=>w(void 0,void 0,void 0,(function*(){const t=yield Gt();const{hex:e}=yield ee.getRawTxData(t);expect(e).toBeDefined(),expect(typeof e).toBe("string"),expect(e.length).toBeGreaterThan(5)}))),2e4)})),describe("getTransactions",(()=>{it("Should retrieve the transactions in the same order as the given ids",(()=>w(void 0,void 0,void 0,(function*(){const t=yield Gt(0);const e=yield Gt(1);const n=yield ee.getTransactions([t,e]);if(expect(n).toBeDefined(),expect(n.length).toBe(2),expect(n[0].id).toBeDefined(),expect(n[0].id).toBe(t),expect(n[0].outputs).toBeDefined(),expect(typeof n[0].outputs.length).toBe("number"),n[0].outputs.length){const[t]=n[0].outputs;expect(t.script).toBeDefined(),expect(t.satoshis).toBeDefined()}if(expect(n[1].id).toBeDefined(),expect(n[1].id).toBe(e),expect(n[1].outputs).toBeDefined(),expect(typeof n[1].outputs.length).toBe("number"),n[1].outputs.length){const[t]=n[1].outputs;expect(t.script).toBeDefined(),expect(t.satoshis).toBeDefined()}const o=yield ee.getTransactions([e,t]);expect(o).toBeDefined(),expect(o.length).toBe(2),expect(o[0].toString()).toBe(n[1].toString()),expect(o[1].toString()).toBe(n[0].toString())}))),2e4)})),describe("sendTransaction",(()=>{it("Should build and broadcast a transaction",(()=>w(void 0,void 0,void 0,(function*(){const t=new ft(te,oe.getPrivateKey());t.tx.feePerKb(wt.DEFAULT_FEE),t.tx.to(oe.getAddress(),wt.MIN_NON_DUST_AMOUNT);const e=t.tx._estimateFee();const n=t.tx._getOutputAmount()-t.tx._getInputAmount()+e;const o=yield oe.getUtxos();oe.selectUtxos(o,n).forEach((e=>t.tx.from([new Vt.UnspentOutput(e)]))),t.tx.change(oe.getAddress()),t.tx.sign(oe.getPrivateKey(),wt.SIGHASH_ALL),yield oe.restClient.sendTransaction(t.tx.toString()),expect(t.tx).toBeDefined()}))),2e4)})),describe("getUtxosFromAddress",(()=>{it("Should retrieve the utxo set of the first test address",(()=>w(void 0,void 0,void 0,(function*(){const t=se(wt.CHAIN,wt.NETWORK);const e=yield ee.getUtxosFromAddress(new Zt(t));expect(e).toBeDefined(),expect(typeof e).toBe("object"),expect(typeof e.length).toBe("number"),e.length>0&&(expect(e[0].txid).toBeDefined(),expect(e[0].vout).toBeDefined(),expect(e[0].amount).toBeDefined(),expect(e[0].scriptPubKey).toBeDefined())}))),2e4),it("should return the utxo for a p2pkh address",(()=>w(void 0,void 0,void 0,(function*(){const t=qt();const e=Ft();const[n]=yield ee.getUtxosFromAddress(new Zt(t));const o=new Xt;const r=Qt.fromPrivateKey(o);const s=new Zt(r,wt.NETWORK);const i=new Xt;const c=Qt.fromPrivateKey(i);const a=new Zt(c,wt.NETWORK);const u=new ft(te,new Xt);u.tx.from(n),u.tx.to(s.toString(),wt.MIN_NON_DUST_AMOUNT),u.tx.change(a.toString()),u.tx.sign(e,wt.SIGHASH_ALL);const d=yield ee.sendTransaction(u.tx.toString());expect(d).toBeDefined();const l=yield ee.getUtxosFromAddress(s);expect(l.length).toBeGreaterThan(0)})))),it("should not return the utxo for a (bare multisig) data utxo",(()=>w(void 0,void 0,void 0,(function*(){const t=qt();const e=Ft();const[n]=yield ee.getUtxosFromAddress(new Zt(t));const o=new Xt;const r=Qt.fromPrivateKey(o);const s=new Zt(r,wt.NETWORK);const i=new Xt;const c=Qt.fromPrivateKey(i);const a=new Zt(c,wt.NETWORK);const u=new ft(te,new Xt);u.tx.from(n),u.createDataOuts([{_owners:[r.toString()]}]),u.tx.change(a.toString()),u.tx.sign(e,wt.SIGHASH_ALL);const d=yield ee.sendTransaction(u.tx.toString());expect(d).toBeDefined();const l=yield ee.getUtxosFromAddress(s);expect(l.length).toBe(0)}))))})),describe("postNonStandardUtxo",(()=>{it("Should issue a post request to store an empty array of data outputs",(()=>w(void 0,void 0,void 0,(function*(){const t=l.default.randomBytes(32).toString("hex");const e={txId:l.default.randomBytes(32).toString("hex"),outData:JSON.stringify([{__cls:`class ${t} {\n            constructor(n) {\n                this.n = n;\n            }\n            inc(n) {\n                this.n += n;\n                return this.n;\n            }\n        }`}]),inputs:[],inRevs:[],outRevs:[]};const n=yield ee.postNonStandardUtxo(e);expect(n).toEqual({status:"Success"})}))),1e4),it("Should issue a post request to store a longer array of data outputs",(()=>w(void 0,void 0,void 0,(function*(){const t=l.default.randomBytes(32).toString("hex");const e=l.default.randomBytes(32).toString("hex");const n={txId:l.default.randomBytes(32).toString("hex"),outData:JSON.stringify([{_owners:["abc"],__cls:`class ${t} {\n            constructor(n) {\n                this.n = n;\n            }\n            inc(n) {\n                this.n += n;\n                return this.n;\n            }\n        }`},{_owners:["b"],__cls:`class ${e} {\n            constructor(n) {\n                this.n = n;\n            }\n            inc(n) {\n                this.n += n;\n                return this.n;\n            }\n        }`}]),inputs:[],inRevs:[],outRevs:[]};const o=yield ee.postNonStandardUtxo(n);expect(o).toEqual({status:"Success"})}))))})),describe("getOwnedRevs",(()=>{it("Should work for an object with a single owner",(()=>w(void 0,void 0,void 0,(function*(){const t=l.default.randomBytes(32).toString("hex");const e=oe.getPublicKey();const n={a:"a",b:"b",_owners:[e.toString()],__cls:`class ${t} {\n            constructor(n) {\n                this.n = n;\n            }\n            inc(n) {\n                this.n += n;\n                return this.n;\n            }\n        }`};const o=l.default.randomBytes(32).toString("hex");const r={txId:o,outData:JSON.stringify([n]),inputs:[],inRevs:[],outRevs:[`${o}/0`]};yield ee.postNonStandardUtxo(r);const s=yield ee.getOwnedRevs(e);expect(s).toBeDefined(),expect(s.length).toBeGreaterThan(0),expect(s[0].contractName).toBeDefined(),expect(s[0].contractHash).toBeDefined(),expect(s[0].rev).toBeDefined()})))),it("Should work for an object with two owners",(()=>w(void 0,void 0,void 0,(function*(){const t=l.default.randomBytes(32).toString("hex");const e=oe.getPublicKey();const n=re.getPublicKey();const o={a:"a",b:"b",_owners:[e.toString(),n.toString()],__cls:`class ${t} {\n            constructor(n) {\n                this.n = n;\n            }\n            inc(n) {\n                this.n += n;\n                return this.n;\n            }\n        }`};const r=l.default.randomBytes(32).toString("hex");const s={txId:r,outData:JSON.stringify([o]),inputs:[],inRevs:[],outRevs:[`${r}/0`]};yield ee.postNonStandardUtxo(s);const i=yield ee.getOwnedRevs(e);expect(i).toBeDefined(),expect(i.length).toBeGreaterThan(0),expect(i[0].rev).toBeDefined();const c=yield ee.getOwnedRevs(n);expect(c).toBeDefined(),expect(c.length).toBeGreaterThan(0),expect(c[0].rev).toBeDefined()}))))})),describe("getLatestRevs",(()=>{it("Should retrieve the latest rev for the single input object id",(()=>w(void 0,void 0,void 0,(function*(){const t=l.default.randomBytes(32).toString("hex");const e={a:"a",b:"b",_owners:[oe.getPublicKey().toString()],__cls:`class ${t} {\n            constructor(n) {\n                this.n = n;\n            }\n            inc(n) {\n                this.n += n;\n                return this.n;\n            }\n        }`};const n=l.default.randomBytes(32).toString("hex");const o={txId:n,outData:JSON.stringify([e]),inputs:[],inRevs:[],outRevs:[`${n}/0`]};const r=yield ee.postNonStandardUtxo(o);yield Q(2e3),expect(r).toEqual({status:"Success"});const s=yield ee.getLatestRevs([`${n}/0`]);expect(s).toBeDefined(),expect(s.length).toBe(1),expect(s[0]).toBe(`${n}/0`)})))),it("Should retrieve the latest revs in the same order as input object ids",(()=>w(void 0,void 0,void 0,(function*(){const t=l.default.randomBytes(32).toString("hex");const e=l.default.randomBytes(32).toString("hex");const n=oe.getPublicKey();const o={a:"a",b:"b",_owners:[n.toString()],__cls:`class ${t} {\n            constructor(n) {\n                this.n = n;\n            }\n            inc(n) {\n                this.n += n;\n                return this.n;\n            }\n        }`};const r={c:"c",d:"d",_owners:[n.toString()],__cls:`class ${e} {\n            constructor(n) {\n                this.n = n;\n            }\n            inc(n) {\n                this.n += n;\n                return this.n;\n            }\n        }`};const s=l.default.randomBytes(32).toString("hex");const i={txId:s,outData:JSON.stringify([o,r]),inputs:[],inRevs:[],outRevs:[`${s}/0`,`${s}/1`]};const c=yield ee.postNonStandardUtxo(i);yield Q(2e3),expect(c).toEqual({status:"Success"});const a=yield ee.getLatestRevs([`${s}/0`,`${s}/1`]);expect(a).toBeDefined(),expect(a.length).toBe(2),expect(a[0]).toBe(`${s}/0`),expect(a[1]).toBe(`${s}/1`);const u=yield ee.getLatestRevs([`${s}/1`,`${s}/0`]);expect(u).toBeDefined(),expect(u.length).toBe(2),expect(u[0]).toBe(`${s}/1`),expect(u[1]).toBe(`${s}/0`)}))))})),describe("Secrets Store API",(()=>{const t={a:Math.random().toString()};const e=JSON.stringify(t);const o={data:e};const r="http://127.0.0.1:3000";const s=n.Bitcoin.crypto.Hash.sha256(Buffer.from(e)).toString("hex");afterEach((()=>w(void 0,void 0,void 0,(function*(){try{yield k.deleteSecretOutput({_url:`${r}/store/${s}`,privateKey:Yt})}catch(t){}})))),it("Should be able to store an object on the server",(()=>w(void 0,void 0,void 0,(function*(){const{_url:t}=yield k.setSecretOutput({host:r,privateKey:Yt,secretOutput:o});expect(t).toBe(`${r}/store/${s}`)})))),it("Should not throw an error if the same object is stored twice",(()=>w(void 0,void 0,void 0,(function*(){yield k.setSecretOutput({host:r,privateKey:Yt,secretOutput:o});const{_url:t}=yield k.setSecretOutput({host:r,privateKey:Yt,secretOutput:o});expect(t).toBe(`${r}/store/${s}`)})))),it("Should be able to retrieve an object on the server",(()=>w(void 0,void 0,void 0,(function*(){const{_url:e}=yield k.setSecretOutput({host:r,privateKey:Yt,secretOutput:o});const{host:n,data:s}=yield k.getSecretOutput({_url:e,privateKey:Yt});expect(JSON.parse(s)).toEqual(t),expect(n).toEqual(r)})))),it("Should be able to delete an object on the server",(()=>w(void 0,void 0,void 0,(function*(){const{_url:t}=yield k.setSecretOutput({host:r,privateKey:Yt,secretOutput:o});let e;yield k.deleteSecretOutput({_url:t,privateKey:Yt});try{e=yield k.getSecretOutput({_url:t,privateKey:Yt})}catch(t){e=t.response}expect(e.status).toBe(403),expect(e.data.error).toBe("No entry found.")}))))})),describe("queryRevs",(()=>{const t=l.default.randomBytes(32).toString("hex");const e=`class ${t} {\n            constructor(n) {\n                this.n = n;\n            }\n            inc(n) {\n                this.n += n;\n                return this.n;\n            }\n        }`;const n=h.default.sha256().update(e).digest("hex");const o=Qt.fromPrivateKey(Xt.fromRandom());const r=Qt.fromPrivateKey(Xt.fromRandom());const s={a:"a",b:"b",_owners:[o.toString()],__cls:e};const i=l.default.randomBytes(32).toString("hex");const c=JSON.stringify([s]);const a={c:"c",d:"d",_owners:[o.toString()]};const u=l.default.randomBytes(32).toString("hex");const d=JSON.stringify([a]);beforeAll((()=>w(void 0,void 0,void 0,(function*(){const t={txId:i,outData:c,inputs:[],inRevs:[],outRevs:[`${i}/0`]};yield ee.postNonStandardUtxo(t);const e={txId:u,outData:d,inputs:[`${i}/0`],inRevs:[`${i}/0`],outRevs:[`${u}/0`]};yield ee.postNonStandardUtxo(e)})))),it("Should retrieve the latest revs for the given public key",(()=>w(void 0,void 0,void 0,(function*(){const t=yield ee.queryRevs({publicKey:o});expect(t).toBeDefined(),expect(t.length).toBe(1),expect(t[0]).toBe(`${u}/0`)})))),it("Should retrieve the latest revs for the given contract name",(()=>w(void 0,void 0,void 0,(function*(){const e=yield ee.queryRevs({contractName:t});expect(e).toBeDefined(),expect(e.length).toBe(1),expect(e[0]).toBe(`${u}/0`)})))),it("Should retrieve the latest revs for the given contract hash",(()=>w(void 0,void 0,void 0,(function*(){const t=yield ee.queryRevs({contractHash:n});expect(t).toBeDefined(),expect(t.length).toBe(1),expect(t[0]).toBe(`${u}/0`)})))),it("Should retrieve the latest revs for the given public key and contract name combination",(()=>w(void 0,void 0,void 0,(function*(){const e=yield ee.queryRevs({publicKey:o,contractName:t});expect(e).toBeDefined(),expect(e.length).toBe(1),expect(e[0]).toBe(`${u}/0`)})))),it("Should retrieve blank if there are no latest revs for the given public key",(()=>w(void 0,void 0,void 0,(function*(){const t=yield ee.queryRevs({publicKey:r});expect(t).toBeDefined(),expect(t.length).toBe(0)}))))}))}));
