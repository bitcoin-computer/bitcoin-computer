"use strict";require("ses");var t=require("bitcoin-computer-bitcore");function e(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var r=e(require("axios"));function n(t,e,r,n){return new(r||(r=Promise))((function(o,i){function s(t){try{a(n.next(t))}catch(t){i(t)}}function c(t){try{a(n.throw(t))}catch(t){i(t)}}function a(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,c)}a((n=n.apply(t,e||[])).next())}))}const{crypto:o}=t.Bitcoin;const i=(t,e)=>{const r=Date.now();const n=o.Hash.sha256(Buffer.from(e+r));const i=[o.ECDSA.sign(n,t,"big").toString("hex"),t.publicKey.toString(),r];return`Bearer ${Buffer.from(i.join(":")).toString("base64")}`};const{Transaction:s}=t.Bitcoin;function c(t){return n(this,void 0,void 0,(function*(){if(!function(t){return void 0!==t.config}(t))throw new Error("Unknown error");const{message:e,config:r,response:n}=t;const o=function(t){try{const e=JSON.parse(t);if("object"!=typeof e)throw new Error("Invalid object");if("string"!=typeof e.txhex)throw new Error("Invalid object");return new s(e.txhex)}catch(t){return null}}(null==r?void 0:r.data);const i=`message\t${e}`;const c=`request\t${null==r?void 0:r.method} ${null==r?void 0:r.url}`;const a=o?`transaction\t ${JSON.stringify(o.toJSON(),null,2)}`:"";const u="post"===(null==r?void 0:r.method)?`data\t${null==r?void 0:r.data}`:"";const d=n?`response\t${JSON.stringify(n.data)}`:"";const h=o?a:u;throw t.message=`\n    Communication Error\n    ${i}\n    ${c}\n    ${h}\n    ${d}`,t}))}class a{constructor(t,e,r={}){this.baseUrl=t,this.headers=r,this.privateKey=e}get(t){return n(this,void 0,void 0,(function*(){const e=`${this.baseUrl}${t}`;try{let t={};return this.privateKey&&(t={Authentication:i(this.privateKey,this.baseUrl)}),(yield r.default.get(e,{headers:Object.assign(Object.assign({},this.headers),t)})).data}catch(t){return c(t)}}))}post(t,e){return n(this,void 0,void 0,(function*(){const n=`${this.baseUrl}${t}`;try{let t={};return this.privateKey&&(t={Authentication:i(this.privateKey,this.baseUrl)}),(yield r.default.post(n,e,{headers:Object.assign(Object.assign({},this.headers),t)})).data}catch(t){return c(t)}}))}delete(t){return n(this,void 0,void 0,(function*(){const e=`${this.baseUrl}${t}`;try{let t={};return this.privateKey&&(t={Authentication:i(this.privateKey,this.baseUrl)}),(yield r.default.delete(e,{headers:Object.assign(Object.assign({},this.headers),t)})).data}catch(t){return c(t)}}))}}const{PrivateKey:u,Transaction:d}=t.Bitcoin;function h(t){if(!/^[0-9A-Fa-f]{64}$/.test(t))throw new Error(`Invalid txId: ${t}`)}function v(t){if(!/^[0-9A-Fa-f]{64}\/\d+$/.test(t))throw new Error(`Invalid outId: ${t}`)}let l=class{constructor(t,e=new u){this.nodeConfig=t,this.bcn=new a(t.url,e)}get chain(){return this.nodeConfig.chain}get network(){return this.nodeConfig.network}getBalance(t){return n(this,void 0,void 0,(function*(){const{chain:e,network:r}=this;return yield this.bcn.get(`/v1/${e}/${r}/address/${t}/balance`)}))}getTransaction(t){return n(this,void 0,void 0,(function*(){return new d(yield this.getRawTx(t))}))}getRawTx(t){return n(this,void 0,void 0,(function*(){h(t);const{chain:e,network:r}=this;return this.bcn.get(`/v1/${e}/${r}/tx/${t}`)}))}getRawTxData(t){return n(this,void 0,void 0,(function*(){h(t);const{chain:e,network:r}=this;return this.bcn.get(`/v1/${e}/${r}/tx-data/${t}`)}))}getTransactions(t){return n(this,void 0,void 0,(function*(){return(yield this.getRawTxs(t)).map((t=>new d(t)))}))}getRawTxs(t){return n(this,void 0,void 0,(function*(){t.map(h);const{chain:e,network:r}=this;return this.bcn.post(`/v1/${e}/${r}/tx/bulk/`,{txIds:t})}))}sendTransaction(t){return n(this,void 0,void 0,(function*(){return this.bcn.post(`/v1/${this.chain}/${this.network}/tx/send`,{rawTx:t})}))}getUtxosFromAddress(t){return n(this,void 0,void 0,(function*(){const{chain:e,network:r}=this;return this.bcn.get(`/v1/${e}/${r}/wallet/${t.toString()}/utxos`)}))}postNonStandardUtxo(t){return n(this,void 0,void 0,(function*(){const{chain:e,network:r}=this;return this.bcn.post(`/v1/${e}/${r}/non-standard-utxo`,t)}))}getOwnedRevs(t){return n(this,void 0,void 0,(function*(){const{chain:e,network:r}=this;return this.bcn.get(`/v1/${e}/${r}/wallet/${t.toString()}/non-standard-utxos`)}))}queryRevs(t){return n(this,void 0,void 0,(function*(){const{publicKey:e,contractName:r,contractHash:n}=t;if(void 0===e&&void 0===r&&void 0===n)throw new Error("Filter parameter for queryRevs endpoint cannot be empty.");let o="";e&&(o+=`?publicKey=${e}`),r&&(o+=0===o.length?"?":"&",o+=`contractName=${r}`),n&&(o+=0===o.length?"?":"&",o+=`contractHash=${n}`);const{chain:i,network:s}=this;return this.bcn.get(`/v1/${i}/${s}/non-standard-utxos${o}`)}))}getLatestRev(t){return n(this,void 0,void 0,(function*(){v(t);const{chain:e,network:r}=this;const[{rev:n}]=yield this.bcn.get(`/v1/${e}/${r}/rev/${t}`);return n}))}getLatestRevs(t){return n(this,void 0,void 0,(function*(){t.map(v),t.map(v);const{chain:e,network:r}=this;return yield this.bcn.post(`/v1/${e}/${r}/revs`,{ids:t})}))}static getSecretOutput({_url:t,privateKey:e}){return n(this,void 0,void 0,(function*(){const r=t.split("/");const n=r[r.length-1];const o=r.slice(0,-2).join("/");const i=new a(o,e);return{host:o,data:yield i.get(`/v1/store/${n}`)}}))}static setSecretOutput({secretOutput:t,host:e,privateKey:r}){return n(this,void 0,void 0,(function*(){return new a(e,r).post("/v1/store/",t)}))}static deleteSecretOutput({_url:t,privateKey:e}){return n(this,void 0,void 0,(function*(){const r=t.split("/");const n=r[r.length-1];const o=r.slice(0,-2).join("/");const i=new a(o,e);yield i.delete(`/v1/store/${n}`)}))}};l=function(t,e,r,n){var o,i=arguments.length,s=i<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,r,n);else for(var c=t.length-1;c>=0;c--)(o=t[c])&&(s=(i<3?o(s):i>3?o(e,r,s):o(e,r))||s);return i>3&&s&&Object.defineProperty(e,r,s),s}([t=>t],l);const f=t=>(Object.prototype.toString.call(t).match(/\s([a-zA-Z]+)/)||[])[1];const b=t=>"object"==typeof t?f(t):f(t).toLowerCase();const g=t=>{if((t=>["number","string","boolean","undefined","Null"].includes(b(t)))(t))return t;if((t=>"Array"===b(t))(t))return t.map(g);if((t=>"Object"===b(t))(t)){const e=Object.keys(t).reduce(((e,r)=>(e[r]=g(t[r]),e)),{});const r=Object.create(Object.getPrototypeOf(t));return Object.assign(r,e)}throw new Error(`Unsupported data type for clone: ${b(t)}`)};function p(t,e){let r=0;return e.map((e=>"__"===e?t[r++]:e))}function w(t){return{smartArgs:t.filter((t=>t._rev)),dumbArgs:t.map((t=>t._rev?"__":t))}}describe("helpers",(()=>{describe("splitArgs",(()=>{it("should work for an array of dumb objects",(()=>{expect(w([{a:1},{b:2}])).toEqual({dumbArgs:[{a:1},{b:2}],smartArgs:[]})})),it("should work for an array of smart objects",(()=>{expect(w([{a:1,_rev:"rev1"},{b:2,_rev:"rev1"}])).toEqual({dumbArgs:["__","__"],smartArgs:[{_rev:"rev1",a:1},{_rev:"rev1",b:2}]})})),it("should work for an array of smart objects",(()=>{expect(w([{a:1},{b:2,_rev:"rev1"}])).toEqual({dumbArgs:[{a:1},"__"],smartArgs:[{_rev:"rev1",b:2}]})}))})),describe("mergeArgs",(()=>{it("should work for an array of dumb objects",(()=>{const t=[{a:1}];const e=g(t);expect(p(t,["__"])).toEqual([{a:1}]),expect(e).toEqual(t)})),it("should work for an array of dumb objects",(()=>{const t=[{a:1},{b:2}];const{smartArgs:e,dumbArgs:r}=w(t);expect(p(e,r)).toEqual(t)})),it("should work for an array of smart objects",(()=>{const t=[{a:1,_rev:"rev0"},{b:2,_rev:"rev0"}];const{smartArgs:e,dumbArgs:r}=w(t);expect(p(e,r)).toEqual(t)})),it("should work for a mixed array of objects",(()=>{const t=[{a:1},{b:2,_rev:"rev0"}];const{smartArgs:e,dumbArgs:r}=w(t);expect(p(e,r)).toEqual(t)}))}))}));
