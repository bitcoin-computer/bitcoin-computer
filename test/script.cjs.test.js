"use strict";var e=require("bitcoin-computer-bitcore");const t=process.env.CHAIN||"LTC";const r=process.env.NETWORK||"testnet";const o=parseInt(process.env.BC_DUST_LIMIT||"",10)||1546;const n=parseInt(process.env.BC_DEFAULT_FEE||"",10)||2500;var a={CHAIN:t,NETWORK:r,MIN_NON_DUST_AMOUNT:o,SCRIPT_CHUNK_SIZE:parseInt(process.env.BC_SCRIPT_CHUNK_SIZE||"",10)||479,BBS_URL:process.env.BBS_URL?process.env.BBS_URL:"https://node.bitcoincomputer.io",DEFAULT_FEE:n,SIGHASH_ALL:1,SIGHASH_FORKID:64,FEE_PER_KB:2e4,PUBLIC_KEY_SIZE:65,ANYONE_CAN_SPEND_SEED:"replace this seed",DEFAULT_PATH:"m/44'/0'/0'/0",PASSPHRASE:"",ENCODING_LENGTH:3,ENCODING_NUMBER_LENGTH:3,MAX_PUBKEYS_PER_SCRIPT:3,OP_RETURN_SIZE:80};const{PublicKey:c,Mnemonic:s,crypto:i}=e.Bitcoin;const{Point:f}=i;function p(e){return Buffer.from(e,"hex").toString().replace(/\0/g,"")}function u(e,t,r){if(e.length*Math.log2(t)>53)throw new Error(`Input too large ${e.length} ${Math.log2(t)}`);if(![2,10,16].includes(t)||![2,10,16].includes(r))throw new Error("ToBase or FromBase invalid in covertNumber.");if(2===t&&e.length%8!=0)throw new Error("Binary strings must be byte aligned.");if(16===t&&e.length%2!=0)throw new Error("Hex strings must be of even length.");const o=parseInt(e,t).toString(r);return 2===r?o.padStart(8*Math.ceil(o.length/8),"0"):16===r?o.padStart(2*Math.ceil(o.length/2),"0"):o}function d(e,t){const r=new RegExp(`.{1,${t}}`,"g");return e.match(r)||[]}function E(e){return d(e,2).map((e=>u(e,16,2))).join("")}function S(e){return d(e,8).map((e=>u(e,2,16))).join("")}function l(e){if(62!==e.length)throw new Error("Input to hexToPublicKey must be of length 62");let t=!1;let r=0;let o;for(;!t;){if(r>=256)throw new Error("Something went wrong storing data");const c=r.toString(16).padStart(2,"0")+S((a=r,(n=E(e).padStart(64,"0")).slice(a)+n.slice(0,a)));try{o=f.fromX(!1,c),t=!0}catch(e){r+=1}}var n,a;if(!o)throw new Error("Something went wrong storing data");return new c(o)}function _(e){const t=e.point.getX().toString("hex").padStart(64,"0");const r=u(t.slice(0,2),16,10);return S((n=parseInt(r,10),(o=E(t.slice(2))).slice(-n)+o.slice(0,-n)));var o,n}function h(e){const t=function(e){return((e,t,r={})=>{const{path:o,passphrase:n}=r;let a=e.toHDPrivateKey(n,t);return o&&(a=a.derive(o)),a.privateKey})(new s(a.ANYONE_CAN_SPEND_SEED),e,{path:a.DEFAULT_PATH,passphrase:""})}(e);return c.fromPrivateKey(t)}const{PublicKey:m,Script:b}=e.Bitcoin;function O(e,t,r){const o=r?[...e,h(t).toBuffer()]:e;const n=new b;return n.add("OP_1"),o.forEach((e=>{n.add(e)})),n.add(`OP_${o.length}`),n.add("OP_CHECKMULTISIG"),n}function B(e,t){const r=e.chunks.filter((e=>e.buf));return(t?r.slice(0,-1):r).map((e=>e.buf))}function T(e,t,r){if(e.length>a.MAX_PUBKEYS_PER_SCRIPT)throw new Error("Too many owners");return O(e.map((e=>e.toBuffer())),t,r)}function P(e,t){return B(e,t).map((e=>m.fromBuffer(e)))}function g(e,t){var r;return function(e,t){const r=[];for(let t=0;t<e.length;t+=2)r.push(e.slice(t,t+2));return r}(d((r=e,Buffer.from(r).toString("hex")),62).map((e=>e.padStart(62,"0"))).map(l)).map((e=>T(e,t,!0)))}function N(e){return e.map((e=>P(e,!0))).flat().map(_).map(p).join("")}describe("Script",(()=>{describe("bufsToScript",(()=>{it("should create a script from an array of buffers when anyOneCanSpend is false",(()=>{const e=O([Buffer.from("1"),Buffer.from("2"),Buffer.from("3")],a.NETWORK,!1);expect(e.toASM()).toBe("OP_1 31 32 33 OP_3 OP_CHECKMULTISIG")})),it("should create a script from an array of buffers when anyOneCanSpend is true",(()=>{const e=O([Buffer.from("1"),Buffer.from("2"),Buffer.from("3")],a.NETWORK,!0);expect(e.toASM()).toBe("OP_1 31 32 33 032d82aeda52200bec66ade26355968b6d96c271f60b473aa7c63c2c97d4db8309 OP_4 OP_CHECKMULTISIG")}))})),describe("scriptToBufs",(()=>{it("should create a an array of buffers from a script when anyOneCanSpend is true",(()=>{const e=[Buffer.from("1"),Buffer.from("2"),Buffer.from("3")];const t=B(O(e,a.NETWORK,!0),!0);expect(t).toEqual(e)})),it("should create a an array of buffers from a script when anyOneCanSpend is false",(()=>{const e=[Buffer.from("1"),Buffer.from("2"),Buffer.from("3")];const t=B(O(e,a.NETWORK,!1),!1);expect(t).toEqual(e)}))})),describe("publicKeysToScript",(()=>{it("should create a script from an array of buffers",(()=>{const e=T(["1","2","3"].map((e=>e.padStart(62,"0"))).map(l),a.NETWORK,!1);expect(e.toASM()).toBe("OP_1 020000000000000000000000000000000000000000000000000000000000000001 020000000000000000000000000000000000000000000000000000000000000002 020000000000000000000000000000000000000000000000000000000000000003 OP_3 OP_CHECKMULTISIG")}))})),describe("scriptToPublicKeys",(()=>{it("should create a script from an array of buffers",(()=>{const e=["1","2","3"].map((e=>e.padStart(62,"0"))).map(l);const t=P(T(e,a.NETWORK,!0),!0);expect(t).toEqual(e)}))})),describe("dataToScripts",(()=>{it("should create a script from a json object",(()=>{const e={a:"1".repeat(54)};const t=g(JSON.stringify(e),a.NETWORK);expect(t.length).toBe(1);const[r]=t;expect(r.toASM()).toBe("OP_1 0203d9130911d1118989898989898989898989898989898989898989898989898b 02003131313131313131313131313131313131313131313131313131313131227d 032d82aeda52200bec66ade26355968b6d96c271f60b473aa7c63c2c97d4db8309 OP_3 OP_CHECKMULTISIG")})),it("should create a script from a large json object",(()=>{const e={a:"1".repeat(55)};const t=g(JSON.stringify(e),a.NETWORK);expect(t.length).toBe(2),expect(t[0].toASM()).toBe("OP_1 0203d9130911d1118989898989898989898989898989898989898989898989898b 020162626262626262626262626262626262626262626262626262626262626244 032d82aeda52200bec66ade26355968b6d96c271f60b473aa7c63c2c97d4db8309 OP_3 OP_CHECKMULTISIG"),expect(t[1].toASM()).toBe("OP_1 0201000000000000000000000000000000000000000000000000000000000000fa 032d82aeda52200bec66ade26355968b6d96c271f60b473aa7c63c2c97d4db8309 OP_2 OP_CHECKMULTISIG")}))})),describe("scriptsToData",(()=>{it("should create a json object from a script",(()=>{const e={a:"1".repeat(54)};const t=g(JSON.stringify(e),a.NETWORK);expect(t.length).toBe(1);const r=N(t);const o=JSON.parse(r);expect(o).toEqual(e)})),it("should create a large json object from an array of script",(()=>{const e={a:"1".repeat(55)};const t=g(JSON.stringify(e),a.NETWORK);expect(t.length).toBe(2);const r=N(t);const o=JSON.parse(r);expect(o).toEqual(e)}))}))}));
