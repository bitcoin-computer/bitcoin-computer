"use strict";var t=require("bitcoin-computer-bitcore");process.env.CHAIN,process.env.NETWORK,process.env.BCN_URL,parseInt(process.env.BC_DUST_LIMIT||"",10),parseInt(process.env.BC_DEFAULT_FEE||"",10),parseInt(process.env.BC_SCRIPT_CHUNK_SIZE||"",10);const{PublicKey:e,crypto:r}=t.Bitcoin;const{Point:o}=r;function n(t){return Buffer.from(t,"hex").toString().replace(/\0/g,"")}function c(t,e,r){if(t.length*Math.log2(e)>53)throw new Error(`Input too large ${t.length} ${Math.log2(e)}`);if(![2,10,16].includes(e)||![2,10,16].includes(r))throw new Error("ToBase or FromBase invalid in covertNumber.");if(2===e&&t.length%8!=0)throw new Error("Binary strings must be byte aligned.");if(16===e&&t.length%2!=0)throw new Error("Hex strings must be of even length.");const o=parseInt(t,e).toString(r);return 2===r?o.padStart(8*Math.ceil(o.length/8),"0"):16===r?o.padStart(2*Math.ceil(o.length/2),"0"):o}function a(t,e){const r=new RegExp(`.{1,${e}}`,"g");return t.match(r)||[]}function s(t){return a(t,2).map((t=>c(t,16,2))).join("")}function i(t){return a(t,8).map((t=>c(t,2,16))).join("")}function f(t){if(62!==t.length)throw new Error("Input to hexToPublicKey must be of length 62");let r=!1;let n=0;let c;for(;!r;){if(n>=256)throw new Error("Something went wrong storing data");const e=n.toString(16).padStart(2,"0")+i((f=n,(a=s(t).padStart(64,"0")).slice(f)+a.slice(0,f)));try{c=o.fromX(!1,e),r=!0}catch(t){n+=1}}var a,f;if(!c)throw new Error("Something went wrong storing data");return new e(c)}function p(t){const e=t.point.getX().toString("hex").padStart(64,"0");const r=c(e.slice(0,2),16,10);return i((n=parseInt(r,10),(o=s(e.slice(2))).slice(-n)+o.slice(0,-n)));var o,n}const{PublicKey:u,Script:l}=t.Bitcoin;function h(t){const e=new l;return e.add("OP_1"),t.forEach((t=>{e.add(t)})),e.add(`OP_${t.length}`),e.add("OP_CHECKMULTISIG"),e}function d(t){return t.chunks.filter((t=>t.buf)).map((t=>t.buf))}function g(t){if(t.length>3)throw new Error("Too many owners");return h(t.map((t=>t.toBuffer())))}function m(t){return d(t).map((t=>u.fromBuffer(t)))}function S(t){var e;return function(t,e){const r=[];for(let e=0;e<t.length;e+=3)r.push(t.slice(e,e+3));return r}(a((e=t,Buffer.from(e).toString("hex")),62).map((t=>t.padStart(62,"0"))).map(f)).map((t=>g(t)))}function b(t){return t.map((t=>m(t))).flat().map(p).map(n).join("")}describe("Script",(()=>{describe("bufsToScript",(()=>{it("should create a script from an array of buffers when anyOneCanSpend is true",(()=>{const t=h([Buffer.from("1"),Buffer.from("2"),Buffer.from("3")]);expect(t.toASM()).toBe("OP_1 31 32 33 OP_3 OP_CHECKMULTISIG")}))})),describe("scriptToBufs",(()=>{it("should create a an array of buffers from a script when anyOneCanSpend is false",(()=>{const t=[Buffer.from("1"),Buffer.from("2"),Buffer.from("3")];const e=d(h(t));expect(e).toEqual(t)}))})),describe("publicKeysToScript",(()=>{it("should create a script from an array of buffers",(()=>{const t=g(["1","2","3"].map((t=>t.padStart(62,"0"))).map(f));expect(t.toASM()).toBe("OP_1 020000000000000000000000000000000000000000000000000000000000000001 020000000000000000000000000000000000000000000000000000000000000002 020000000000000000000000000000000000000000000000000000000000000003 OP_3 OP_CHECKMULTISIG")}))})),describe("scriptToPublicKeys",(()=>{it("should create a script from an array of buffers",(()=>{const t=["1","2","3"].map((t=>t.padStart(62,"0"))).map(f);const e=m(g(t));expect(e).toEqual(t)}))})),describe("dataToScripts",(()=>{it("should create a script from a json object",(()=>{const t={a:"1".repeat(85)};const e=S(JSON.stringify(t));expect(e.length).toBe(1);const[r]=e;expect(r.toASM()).toBe("OP_1 0203d9130911d1118989898989898989898989898989898989898989898989898b 020162626262626262626262626262626262626262626262626262626262626262 02003131313131313131313131313131313131313131313131313131313131227d OP_3 OP_CHECKMULTISIG")})),it("should create a script from a large json object",(()=>{const t={a:"1".repeat(86)};const e=S(JSON.stringify(t));expect(e.length).toBe(2),expect(e[0].toASM()).toBe("OP_1 0203d9130911d1118989898989898989898989898989898989898989898989898b 020162626262626262626262626262626262626262626262626262626262626262 020162626262626262626262626262626262626262626262626262626262626244 OP_3 OP_CHECKMULTISIG"),expect(e[1].toASM()).toBe("OP_1 0201000000000000000000000000000000000000000000000000000000000000fa OP_1 OP_CHECKMULTISIG")}))})),describe("scriptsToData",(()=>{it("should create a json object from a script",(()=>{const t={a:"1".repeat(85)};const e=S(JSON.stringify(t));expect(e.length).toBe(1);const r=b(e);const o=JSON.parse(r);expect(o).toEqual(t)})),it("should create a large json object from an array of script",(()=>{const t={a:"1".repeat(86)};const e=S(JSON.stringify(t));expect(e.length).toBe(2);const r=b(e);const o=JSON.parse(r);expect(o).toEqual(t)}))}))}));
