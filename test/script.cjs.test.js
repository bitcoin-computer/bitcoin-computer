"use strict";var e=require("chai");var t=require("bitcoin-computer-bitcore");require("child_process");var r={CHAIN:process.env.CHAIN||"LTC",NETWORK:process.env.NETWORK||"testnet",BCN_URL:process.env.BCN_URL||"https://node.bitcoincomputer.io",RPC_USER:process.env.RPC_USER||"bcn-admin",RPC_PASSWORD:process.env.RPC_PASSWORD||"kH4nU5Okm6-uyC0_mA5ztVNacJqZbYd_KGLl6mx722A=",TEST_MNEMONICS:"travel upgrade inside soda birth essence junk merit never twenty system opinion;toddler hockey salute wheel harvest video narrow riot guitar lake sea call;cannon hour begin test replace fury motion squirrel envelope announce neck culture"};parseInt(process.env.BC_DUST_LIMIT||"",10),parseInt(process.env.BC_DEFAULT_FEE||"",10),parseInt(process.env.BC_SCRIPT_CHUNK_SIZE||"",10);const{PublicKey:n,Mnemonic:o,crypto:c}=t.Bitcoin;const{Point:a}=c;function s(e){return Buffer.from(e,"hex").toString().replace(/\0/g,"")}function i(e,t,r){if(e.length*Math.log2(t)>53)throw new Error(`Input too large ${e.length} ${Math.log2(t)}`);if(![2,10,16].includes(t)||![2,10,16].includes(r))throw new Error("ToBase or FromBase invalid in covertNumber.");if(2===t&&e.length%8!=0)throw new Error("Binary strings must be byte aligned.");if(16===t&&e.length%2!=0)throw new Error("Hex strings must be of even length.");const n=parseInt(e,t).toString(r);return 2===r?n.padStart(8*Math.ceil(n.length/8),"0"):16===r?n.padStart(2*Math.ceil(n.length/2),"0"):n}function p(e,t){const r=new RegExp(`.{1,${t}}`,"g");return e.match(r)||[]}function f(e){return p(e,2).map((e=>i(e,16,2))).join("")}function u(e){return p(e,8).map((e=>i(e,2,16))).join("")}function d(e){if(62!==e.length)throw new Error("Input to hexToPublicKey must be of length 62");let t=!1;let r=0;let o;for(;!t;){if(r>=256)throw new Error("Something went wrong storing data");const n=r.toString(16).padStart(2,"0")+u((s=r,(c=f(e).padStart(64,"0")).slice(s)+c.slice(0,s)));try{o=a.fromX(!1,n),t=!0}catch(e){r+=1}}var c,s;if(!o)throw new Error("Something went wrong storing data");return new n(o)}function l(e){const t=e.point.getX().toString("hex").padStart(64,"0");const r=i(t.slice(0,2),16,10);return u((o=parseInt(r,10),(n=f(t.slice(2))).slice(-o)+n.slice(0,-o)));var n,o}function S(e=r.CHAIN,t=r.NETWORK){if("testnet"===t||"regtest"===t)return 1;if("BTC"===e)return 0;if("LTC"===e)return 2;if("DOGE"===e)return 3;if("BCH"===e)return 145;if("BSV"===e)return 236;throw new Error(`Unsupported chain ${e}`)}function h(e=r.CHAIN,t=r.NETWORK){return function({purpose:e=44,coinType:t=2,account:r=0}={}){return`m/${e.toString()}'/${t.toString()}'/${r.toString()}'`}({coinType:S(e,t)})}function b(e,t){const r=function(e,t){return((e,t,r={})=>{const{path:n="m/44'/0'/0'/0",passphrase:o=""}=r;let c=e.toHDPrivateKey(o,t);return n&&(c=c.derive(n)),c.privateKey})(new o("replace this seed"),t,{path:h(e,t),passphrase:""})}(e,t);return n.fromPrivateKey(r)}const{PublicKey:O,Script:g}=t.Bitcoin;function m(e,t,r,n){const o=n?[...e,b(t,r).toBuffer()]:e;const c=new g;return c.add("OP_1"),o.forEach((e=>{c.add(e)})),c.add(`OP_${o.length}`),c.add("OP_CHECKMULTISIG"),c}function C(e,t){const r=e.chunks.filter((e=>e.buf));return(t?r.slice(0,-1):r).map((e=>e.buf))}function N(e,t,r,n){if(e.length>3)throw new Error("Too many owners");return m(e.map((e=>e.toBuffer())),t,r,n)}function I(e,t){return C(e,t).map((e=>O.fromBuffer(e)))}function _(e,t,r,n){var o;return function(e,t){const r=[];for(let n=0;n<e.length;n+=t)r.push(e.slice(n,n+t));return r}(p((o=e,Buffer.from(o).toString("hex")),62).map((e=>e.padStart(62,"0"))).map(d),n?2:3).map((e=>N(e,t,r,n)))}function E(e,t){return e.map((e=>I(e,t))).flat().map(l).map(s).join("")}describe("Script",(()=>{describe("bufsToScript",(()=>{it("should create a script from an array of buffers when anyOneCanSpend is true",(()=>{const t=m([Buffer.from("1"),Buffer.from("2"),Buffer.from("3")],r.CHAIN,r.NETWORK,!1);e.expect(t.toASM()).eq("OP_1 31 32 33 OP_3 OP_CHECKMULTISIG")}))})),describe("scriptToBufs",(()=>{it("should create a an array of buffers from a script when anyOneCanSpend is false",(()=>{const t=[Buffer.from("1"),Buffer.from("2"),Buffer.from("3")];const n=C(m(t,r.CHAIN,r.NETWORK,!1),!1);e.expect(n).to.deep.eq(t)}))})),describe("publicKeysToScript",(()=>{it("should create a script from an array of buffers",(()=>{const t=N(["1","2","3"].map((e=>e.padStart(62,"0"))).map(d),r.CHAIN,r.NETWORK,!1);e.expect(t.toASM()).eq("OP_1 020000000000000000000000000000000000000000000000000000000000000001 020000000000000000000000000000000000000000000000000000000000000002 020000000000000000000000000000000000000000000000000000000000000003 OP_3 OP_CHECKMULTISIG")}))})),describe("scriptToPublicKeys",(()=>{it("should create a script from an array of buffers",(()=>{const t=["1","2","3"].map((e=>e.padStart(62,"0"))).map(d);const n=I(N(t,r.CHAIN,r.NETWORK,!1),!1);e.expect(n).to.deep.eq(t)}))})),describe("stringToScripts",(()=>{it("should create a script from a json object",(()=>{const t={a:"1".repeat(85)};const n=_(JSON.stringify(t),r.CHAIN,r.NETWORK,!1);e.expect(n.length).eq(1);const[o]=n;e.expect(o.toASM()).eq("OP_1 0203d9130911d1118989898989898989898989898989898989898989898989898b 020162626262626262626262626262626262626262626262626262626262626262 02003131313131313131313131313131313131313131313131313131313131227d OP_3 OP_CHECKMULTISIG")})),it("should create a script from a large json object",(()=>{const t={a:"1".repeat(86)};const n=_(JSON.stringify(t),r.CHAIN,r.NETWORK,!1);e.expect(n.length).eq(2),e.expect(n[0].toASM()).eq("OP_1 0203d9130911d1118989898989898989898989898989898989898989898989898b 020162626262626262626262626262626262626262626262626262626262626262 020162626262626262626262626262626262626262626262626262626262626244 OP_3 OP_CHECKMULTISIG"),e.expect(n[1].toASM()).eq("OP_1 0201000000000000000000000000000000000000000000000000000000000000fa OP_1 OP_CHECKMULTISIG")})),it("should create a script from a json object using anyOneCanSpend publicKey",(()=>{const t={a:"1".repeat(85)};const n=_(JSON.stringify(t),r.CHAIN,r.NETWORK,!0);e.expect(n.length).eq(2),e.expect(n[0].toASM()).eq("OP_1 0203d9130911d1118989898989898989898989898989898989898989898989898b 020162626262626262626262626262626262626262626262626262626262626262 03d92bbbd61e057a68d266ba234842393c03455e8eda5df591ab1d344b1d30d029 OP_3 OP_CHECKMULTISIG"),e.expect(n[1].toASM()).eq("OP_1 02003131313131313131313131313131313131313131313131313131313131227d 03d92bbbd61e057a68d266ba234842393c03455e8eda5df591ab1d344b1d30d029 OP_2 OP_CHECKMULTISIG")})),it("should create a script from a large json object using anyOneCanSpend publicKey",(()=>{const t={a:"1".repeat(86)};const n=_(JSON.stringify(t),r.CHAIN,r.NETWORK,!0);e.expect(n.length).eq(2),e.expect(n[0].toASM()).eq("OP_1 0203d9130911d1118989898989898989898989898989898989898989898989898b 020162626262626262626262626262626262626262626262626262626262626262 03d92bbbd61e057a68d266ba234842393c03455e8eda5df591ab1d344b1d30d029 OP_3 OP_CHECKMULTISIG"),e.expect(n[1].toASM()).eq("OP_1 020162626262626262626262626262626262626262626262626262626262626244 0201000000000000000000000000000000000000000000000000000000000000fa 03d92bbbd61e057a68d266ba234842393c03455e8eda5df591ab1d344b1d30d029 OP_3 OP_CHECKMULTISIG")}))})),describe("scriptsToString",(()=>{it("should create a json object from a script",(()=>{const t={a:"1".repeat(85)};const n=_(JSON.stringify(t),r.CHAIN,r.NETWORK,!1);e.expect(n.length).eq(1);const o=E(n,!1);const c=JSON.parse(o);e.expect(c).to.deep.eq(t)})),it("should create a large json object from an array of script",(()=>{const t={a:"1".repeat(86)};const n=_(JSON.stringify(t),r.CHAIN,r.NETWORK,!1);e.expect(n.length).eq(2);const o=E(n,!1);const c=JSON.parse(o);e.expect(c).to.deep.eq(t)})),it("should create a json object from a script using anyOneCanSpend publicKey",(()=>{const t={a:"1".repeat(85)};const n=_(JSON.stringify(t),r.CHAIN,r.NETWORK,!0);e.expect(n.length).eq(2);const o=E(n,!0);const c=JSON.parse(o);e.expect(c).to.deep.eq(t)})),it("should create a large json object from an array of script using anyOneCanSpend publicKey",(()=>{const t={a:"1".repeat(86)};const n=_(JSON.stringify(t),r.CHAIN,r.NETWORK,!0);e.expect(n.length).eq(2);const o=E(n,!0);const c=JSON.parse(o);e.expect(c).to.deep.eq(t)}))}))}));
