"use strict";var e=require("chai");var t=require("bitcoin-computer-bitcore");require("child_process");var c=process.env.CHAIN||"LTC",r=process.env.NETWORK||"testnet";process.env.BCN_URL,parseInt(process.env.BC_DUST_LIMIT||"",10),parseInt(process.env.BC_DEFAULT_FEE||"",10),parseInt(process.env.BC_SCRIPT_CHUNK_SIZE||"",10);const{PublicKey:n,crypto:o}=t.Bitcoin;const{Point:i}=o;function f(e){return Buffer.from(e).toString("hex")}function a(e){return Buffer.from(e,"hex").toString().replace(/\0/g,"")}function s(e,t){return e.slice(t)+e.slice(0,t)}function p(e,t){return e.slice(-t)+e.slice(0,-t)}function u(e,t,c){if(e.length*Math.log2(t)>53)throw new Error(`Input too large ${e.length} ${Math.log2(t)}`);if(![2,10,16].includes(t)||![2,10,16].includes(c))throw new Error("ToBase or FromBase invalid in covertNumber.");if(2===t&&e.length%8!=0)throw new Error("Binary strings must be byte aligned.");if(16===t&&e.length%2!=0)throw new Error("Hex strings must be of even length.");const r=parseInt(e,t).toString(c);return 2===c?r.padStart(8*Math.ceil(r.length/8),"0"):16===c?r.padStart(2*Math.ceil(r.length/2),"0"):r}function d(e,t){const c=new RegExp(`.{1,${t}}`,"g");return e.match(c)||[]}function x(e){return d(e,2).map((e=>u(e,16,2))).join("")}function h(e){return d(e,8).map((e=>u(e,2,16))).join("")}function b(e){return e.toString(16).padStart(3,"0")}function q(e){return parseInt(e,16)}function l(e){if(62!==e.length)throw new Error("Input to hexToPublicKey must be of length 62");let t=!1;let c=0;let r;for(;!t;){if(c>=256)throw new Error("Something went wrong storing data");const n=c.toString(16).padStart(2,"0")+h(s(x(e).padStart(64,"0"),c));try{r=i.fromX(!1,n),t=!0}catch(e){c+=1}}if(!r)throw new Error("Something went wrong storing data");return new n(r)}function g(e){const t=e.point.getX().toString("hex").padStart(64,"0");const c=u(t.slice(0,2),16,10);const r=parseInt(c,10);return h(p(x(t.slice(2)),r))}function w(e=c,t=r){if("testnet"===t||"regtest"===t)return 1;if("BTC"===e)return 0;if("LTC"===e)return 2;if("DOGE"===e)return 3;if("BCH"===e)return 145;if("BSV"===e)return 236;throw new Error(`Unsupported chain ${e}`)}function m({purpose:e=44,coinType:t=2,account:c=0}={}){return`m/${e.toString()}'/${t.toString()}'/${c.toString()}'`}function E(e=c,t=r){return m({coinType:w(e,t)})}function T(){return Math.round(Math.random()*Math.pow(2,31))}function S({chain:e=c,network:t=r,account:n=T()}={}){return m({account:n,coinType:w(e,t)})}describe("utils",(()=>{describe("asciiToHex",(()=>{it("should convert a string to a hex",(()=>{e.expect(f("aaa")).eq("616161"),e.expect(f("111")).eq("313131"),e.expect(f("const s1 = 'Ã©'")).eq("636f6e7374207331203d2027c3a927"),e.expect(f("Ã©")).eq("c3a9"),e.expect(f("ðŸ‘©")).eq("f09f91a9")})),it("should be the inverse of hexToAscii",(()=>{e.expect(a(f("aaa"))).eq("aaa"),e.expect(a(f("111"))).eq("111"),e.expect(a(f("const s1 = 'Ã©'"))).eq("const s1 = 'Ã©'"),e.expect(a(f("Ã©"))).eq("Ã©"),e.expect(a(f("ðŸ‘©"))).eq("ðŸ‘©")}))})),describe("hexToAscii",(()=>{it("should convert a hex to a string",(()=>{e.expect(a("616161")).eq("aaa"),e.expect(a("313131")).eq("111"),e.expect(a("636f6e7374207331203d2027c3a927")).eq("const s1 = 'Ã©'"),e.expect(a("c3a9")).eq("Ã©"),e.expect(a("f09f91a9")).eq("ðŸ‘©")})),it("should be the inverse of asciiToHex",(()=>{e.expect(f(a("616161"))).eq("616161"),e.expect(f(a("313131"))).eq("313131"),e.expect(f(a("636f6e7374207331203d2027c3a927"))).eq("636f6e7374207331203d2027c3a927"),e.expect(f(a("c3a9"))).eq("c3a9")}))})),describe("intToHex",(()=>{it("should convert an integer to a hex",(()=>{e.expect(b(0)).eq("000"),e.expect(b(16)).eq("010"),e.expect(b(2048)).eq("800"),e.expect(b(Number.MAX_SAFE_INTEGER)).eq("1fffffffffffff"),e.expect(b(Number.MAX_SAFE_INTEGER+1)).eq("20000000000000"),e.expect(b(Number.MAX_VALUE)).eq("fffffffffffff800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000")})),it("should be the inverse of hexToInt",(()=>{e.expect(q(b(0))).eq(0),e.expect(q(b(16))).eq(16),e.expect(q(b(Number.MAX_SAFE_INTEGER))).eq(Number.MAX_SAFE_INTEGER),e.expect(q(b(Number.MAX_SAFE_INTEGER+1))).eq(Number.MAX_SAFE_INTEGER+1),e.expect(q(b(Number.MAX_VALUE))).eq(Number.MAX_VALUE)}))})),describe("hexToInt",(()=>{it("should convert a hex to an integer",(()=>{e.expect(q("0")).eq(0),e.expect(q("10")).eq(16),e.expect(q("ff")).eq(255),e.expect(q("fff")).eq(4095),e.expect(q("ffff")).eq(65535),e.expect(q("1fffffffffffff")).eq(Number.MAX_SAFE_INTEGER),e.expect(q("20000000000000")).eq(Number.MAX_SAFE_INTEGER+1),e.expect(q("fffffffffffff800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000")).eq(Number.MAX_VALUE)})),it("should be the inverse of hexToInt",(()=>{e.expect(b(q("0"))).eq("000"),e.expect(b(q("10"))).eq("010"),e.expect(b(q("1fffffffffffff"))).eq("1fffffffffffff"),e.expect(b(q("20000000000000"))).eq("20000000000000"),e.expect(b(q("fffffffffffff800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"))).eq("fffffffffffff800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000")}))})),describe("rotateRight",(()=>{it("should rotate a string",(()=>{e.expect(s("abcde",2)).eq("cdeab"),e.expect(s("abcde",5)).eq("abcde"),e.expect(s("abcde",0)).eq("abcde"),e.expect(s("73b438d64ad669ba462cd097a2e327c23c5716fb03b95272228726b1dd8c9c",2)).eq("b438d64ad669ba462cd097a2e327c23c5716fb03b95272228726b1dd8c9c73")})),it("should be the inverse of rotateLeft",(()=>{const t="abcdefg";e.expect(p(s(t,3),3)).eq(t)}))})),describe("rotateLeft",(()=>{it("should rotate a string",(()=>{e.expect(p("abcde",2)).eq("deabc"),e.expect(p("abcde",5)).eq("abcde"),e.expect(p("abcde",0)).eq("abcde"),e.expect(p("73b438d64ad669ba462cd097a2e327c23c5716fb03b95272228726b1dd8c9c",2)).eq("9c73b438d64ad669ba462cd097a2e327c23c5716fb03b95272228726b1dd8c")})),it("should be the inverse of rotateRight",(()=>{const t="abcdefg";e.expect(s(p(t,3),3)).eq(t)}))})),describe("convertNumber",(()=>{it("should convert a binary string to hex",(()=>{e.expect(u("00000001",2,16)).eq("01"),e.expect(u("00000011",2,16)).eq("03"),e.expect(u("00000111",2,16)).eq("07"),e.expect(u("00001111",2,16)).eq("0f"),e.expect(u("00010000",2,16)).eq("10")})),it("should convert a hex string to binary",(()=>{e.expect(u("01",16,2)).eq("00000001"),e.expect(u("03",16,2)).eq("00000011"),e.expect(u("07",16,2)).eq("00000111"),e.expect(u("0f",16,2)).eq("00001111"),e.expect(u("10",16,2)).eq("00010000")})),it("should be able to compute the inverse",(()=>{const t="10";const c=u(t,16,2);e.expect(c).eq("00010000"),e.expect(u(u(t,16,2),2,16)).eq(t)})),it("should be able to compute the inverse of a large number",(()=>{const t="f".repeat(12);e.expect(u(u(t,16,2),2,16)).eq(t)})),it("should throw an error if the input is too large",(()=>{const t="f".repeat(14);e.expect((()=>u(t,16,2))).throws()}))})),describe("hexToBin",(()=>{it("should convert a hex string to a binary string",(()=>{e.expect(x("01")).eq("00000001"),e.expect(x("03")).eq("00000011"),e.expect(x("07")).eq("00000111"),e.expect(x("0f")).eq("00001111"),e.expect(x("10")).eq("00010000"),e.expect(x("f".repeat(14))).eq("1".repeat(56))}))})),describe("binToHex",(()=>{it("should convert a binary string to a hex string",(()=>{e.expect(h("00000001")).eq("01"),e.expect(h("00000011")).eq("03"),e.expect(h("00000111")).eq("07"),e.expect(h("00001111")).eq("0f"),e.expect((()=>h("1"))).throws("Binary strings must be byte aligned.")}))})),describe("chunkString",(()=>{it("should split up an array",(()=>{e.expect(d("1234567",2)).to.deep.eq(["12","34","56","7"]),e.expect(d("",2)).to.deep.eq([])}))})),describe("chunkArray",(()=>{it("should split up an array",(()=>{e.expect(function(e,t){const c=[];for(let t=0;t<e.length;t+=2)c.push(e.slice(t,t+2));return c}([1,2,3,4,5,6,7])).to.deep.eq([[1,2],[3,4],[5,6],[7]])}))})),describe("hexToPublicKey",(()=>{it("should convert a hex string to a public key without shifting",(()=>{const t=l(f("1").padStart(62,"0"));e.expect(t).to.not.be.undefined})),it("should convert a hex string to a public key with shifting",(()=>{const t=l(f("11").padStart(62,"0"));e.expect(t).to.not.be.undefined})),it("should throw an error if the input is not of length 62",(()=>{e.expect((()=>l("1"))).throws("Input to hexToPublicKey must be of length 62")}))})),describe("publicKeyToHex",(()=>{it("should work with a publicKeyToHex without rotating",(()=>{const t=f("11").padStart(62,"0");const c=g(l(t));e.expect(c).eq(t)})),it("should work with a publicKeyToHex with rotating",(()=>{const t="1".padStart(62,"0");const c=g(l(t));e.expect(c).eq(t)})),it("should work with a random input",(()=>{const t=(e=>{let t="";const c="abcdef0123456789";for(let e=0;e<62;e+=1)t+=c.charAt(Math.floor(Math.random()*c.length));return t})();const c=g(l(t));e.expect(c).eq(t)})),it("should perform round trip between ascii and a public key",(()=>{const t="qwerty";const c=a(g(l(f(t).padStart(62,"0"))));e.expect(c).to.be.deep.eq(t)})),it("should perform round trip between ascii and a public key",(()=>{const t="5b7b2261223a317d5d";const c=a(g(l(f(t).padStart(62,"0"))));e.expect(c).to.be.deep.eq(t)}))})),describe("getCoinType",(()=>{it("should work",(()=>{e.expect(w()).eq(1),e.expect(w("LTC","mainnet")).eq(2)}))})),describe("getPath",(()=>{it("should work",(()=>{e.expect(E()).eq("m/44'/1'/0'"),e.expect(E("LTC","mainnet")).eq("m/44'/2'/0'")}))})),describe("getIndexPath",(()=>{it("should work",(()=>{e.expect(S()).to.be.an("string"),e.expect(S({chain:"LTC",network:"mainnet",account:123})).eq("m/44'/2'/123'")}))})),describe("getRandomIntegerInsecure",(()=>{it("should work",(()=>{e.expect(T()).to.be.an("number")}))}))}));
