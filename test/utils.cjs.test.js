"use strict";var e=require("chai");var t=require("bitcoin-computer-bitcore");require("child_process");const{CHAIN:c,NETWORK:r,BCN_URL:n,RPC_USER:o,RPC_PASSWORD:i,TEST_MNEMONICS:f}=process.env;const a=c||"LTC";const s=r||"testnet";parseInt(process.env.BC_DUST_LIMIT||"",10),parseInt(process.env.BC_DEFAULT_FEE||"",10),parseInt(process.env.BC_SCRIPT_CHUNK_SIZE||"",10),parseInt(process.env.MWEB_HEIGHT||"",10);const{PublicKey:p,Mnemonic:u,crypto:d}=t.Bitcoin;const{Point:h}=d;function x(e){return Buffer.from(e).toString("hex")}function b(e){return Buffer.from(e,"hex").toString().replace(/\0/g,"")}function q(e,t){return e.slice(t)+e.slice(0,t)}function l(e,t){return e.slice(-t)+e.slice(0,-t)}function g(e,t,c){if(e.length*Math.log2(t)>53)throw new Error(`Input too large ${e.length} ${Math.log2(t)}`);if(![2,10,16].includes(t)||![2,10,16].includes(c))throw new Error("ToBase or FromBase invalid in covertNumber.");if(2===t&&e.length%8!=0)throw new Error("Binary strings must be byte aligned.");if(16===t&&e.length%2!=0)throw new Error("Hex strings must be of even length.");const r=parseInt(e,t).toString(c);return 2===c?r.padStart(8*Math.ceil(r.length/8),"0"):16===c?r.padStart(2*Math.ceil(r.length/2),"0"):r}function w(e,t){const c=new RegExp(`.{1,${t}}`,"g");return e.match(c)||[]}function E(e){return w(e,2).map((e=>g(e,16,2))).join("")}function m(e){return w(e,8).map((e=>g(e,2,16))).join("")}function T(e){return e.toString(16).padStart(3,"0")}function S(e){return parseInt(e,16)}function _(e){if(62!==e.length)throw new Error("Input to hexToPublicKey must be of length 62");let t=!1;let c=0;let r;for(;!t;){if(c>=256)throw new Error("Something went wrong storing data");const n=c.toString(16).padStart(2,"0")+m(q(E(e).padStart(64,"0"),c));try{r=h.fromX(!1,n),t=!0}catch(e){c+=1}}if(!r)throw new Error("Something went wrong storing data");return new p(r)}function A(e){const t=e.point.getX().toString("hex").padStart(64,"0");const c=g(t.slice(0,2),16,10);const r=parseInt(c,10);return m(l(E(t.slice(2)),r))}function I(e=a,t=s){if("testnet"===t||"regtest"===t)return 1;if("BTC"===e)return 0;if("LTC"===e)return 2;if("DOGE"===e)return 3;if("BCH"===e)return 145;if("BSV"===e)return 236;throw new Error(`Unsupported chain ${e}`)}function v({purpose:e=44,coinType:t=2,account:c=0}={}){return`m/${e.toString()}'/${t.toString()}'/${c.toString()}'`}function y({chain:e=a,network:t=s}={}){return v({coinType:I(e,t)})}function N(){return Math.round(Math.random()*Math.pow(2,31))}function M({chain:e=a,network:t=s,account:c=N()}={}){return v({account:c,coinType:I(e,t)})}describe("utils",(()=>{describe("asciiToHex",(()=>{it("should convert a string to a hex",(()=>{e.expect(x("aaa")).eq("616161"),e.expect(x("111")).eq("313131"),e.expect(x("const s1 = 'Ã©'")).eq("636f6e7374207331203d2027c3a927"),e.expect(x("Ã©")).eq("c3a9"),e.expect(x("ðŸ‘©")).eq("f09f91a9")})),it("should be the inverse of hexToAscii",(()=>{e.expect(b(x("aaa"))).eq("aaa"),e.expect(b(x("111"))).eq("111"),e.expect(b(x("const s1 = 'Ã©'"))).eq("const s1 = 'Ã©'"),e.expect(b(x("Ã©"))).eq("Ã©"),e.expect(b(x("ðŸ‘©"))).eq("ðŸ‘©")}))})),describe("hexToAscii",(()=>{it("should convert a hex to a string",(()=>{e.expect(b("616161")).eq("aaa"),e.expect(b("313131")).eq("111"),e.expect(b("636f6e7374207331203d2027c3a927")).eq("const s1 = 'Ã©'"),e.expect(b("c3a9")).eq("Ã©"),e.expect(b("f09f91a9")).eq("ðŸ‘©")})),it("should be the inverse of asciiToHex",(()=>{e.expect(x(b("616161"))).eq("616161"),e.expect(x(b("313131"))).eq("313131"),e.expect(x(b("636f6e7374207331203d2027c3a927"))).eq("636f6e7374207331203d2027c3a927"),e.expect(x(b("c3a9"))).eq("c3a9")}))})),describe("intToHex",(()=>{it("should convert an integer to a hex",(()=>{e.expect(T(0)).eq("000"),e.expect(T(16)).eq("010"),e.expect(T(2048)).eq("800"),e.expect(T(Number.MAX_SAFE_INTEGER)).eq("1fffffffffffff"),e.expect(T(Number.MAX_SAFE_INTEGER+1)).eq("20000000000000"),e.expect(T(Number.MAX_VALUE)).eq("fffffffffffff800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000")})),it("should be the inverse of hexToInt",(()=>{e.expect(S(T(0))).eq(0),e.expect(S(T(16))).eq(16),e.expect(S(T(Number.MAX_SAFE_INTEGER))).eq(Number.MAX_SAFE_INTEGER),e.expect(S(T(Number.MAX_SAFE_INTEGER+1))).eq(Number.MAX_SAFE_INTEGER+1),e.expect(S(T(Number.MAX_VALUE))).eq(Number.MAX_VALUE)}))})),describe("hexToInt",(()=>{it("should convert a hex to an integer",(()=>{e.expect(S("0")).eq(0),e.expect(S("10")).eq(16),e.expect(S("ff")).eq(255),e.expect(S("fff")).eq(4095),e.expect(S("ffff")).eq(65535),e.expect(S("1fffffffffffff")).eq(Number.MAX_SAFE_INTEGER),e.expect(S("20000000000000")).eq(Number.MAX_SAFE_INTEGER+1),e.expect(S("fffffffffffff800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000")).eq(Number.MAX_VALUE)})),it("should be the inverse of hexToInt",(()=>{e.expect(T(S("0"))).eq("000"),e.expect(T(S("10"))).eq("010"),e.expect(T(S("1fffffffffffff"))).eq("1fffffffffffff"),e.expect(T(S("20000000000000"))).eq("20000000000000"),e.expect(T(S("fffffffffffff800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"))).eq("fffffffffffff800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000")}))})),describe("rotateRight",(()=>{it("should rotate a string",(()=>{e.expect(q("abcde",2)).eq("cdeab"),e.expect(q("abcde",5)).eq("abcde"),e.expect(q("abcde",0)).eq("abcde"),e.expect(q("73b438d64ad669ba462cd097a2e327c23c5716fb03b95272228726b1dd8c9c",2)).eq("b438d64ad669ba462cd097a2e327c23c5716fb03b95272228726b1dd8c9c73")})),it("should be the inverse of rotateLeft",(()=>{const t="abcdefg";e.expect(l(q(t,3),3)).eq(t)}))})),describe("rotateLeft",(()=>{it("should rotate a string",(()=>{e.expect(l("abcde",2)).eq("deabc"),e.expect(l("abcde",5)).eq("abcde"),e.expect(l("abcde",0)).eq("abcde"),e.expect(l("73b438d64ad669ba462cd097a2e327c23c5716fb03b95272228726b1dd8c9c",2)).eq("9c73b438d64ad669ba462cd097a2e327c23c5716fb03b95272228726b1dd8c")})),it("should be the inverse of rotateRight",(()=>{const t="abcdefg";e.expect(q(l(t,3),3)).eq(t)}))})),describe("convertNumber",(()=>{it("should convert a binary string to hex",(()=>{e.expect(g("00000001",2,16)).eq("01"),e.expect(g("00000011",2,16)).eq("03"),e.expect(g("00000111",2,16)).eq("07"),e.expect(g("00001111",2,16)).eq("0f"),e.expect(g("00010000",2,16)).eq("10")})),it("should convert a hex string to binary",(()=>{e.expect(g("01",16,2)).eq("00000001"),e.expect(g("03",16,2)).eq("00000011"),e.expect(g("07",16,2)).eq("00000111"),e.expect(g("0f",16,2)).eq("00001111"),e.expect(g("10",16,2)).eq("00010000")})),it("should be able to compute the inverse",(()=>{const t="10";const c=g(t,16,2);e.expect(c).eq("00010000"),e.expect(g(g(t,16,2),2,16)).eq(t)})),it("should be able to compute the inverse of a large number",(()=>{const t="f".repeat(12);e.expect(g(g(t,16,2),2,16)).eq(t)})),it("should throw an error if the input is too large",(()=>{const t="f".repeat(14);e.expect((()=>g(t,16,2))).throws()}))})),describe("hexToBin",(()=>{it("should convert a hex string to a binary string",(()=>{e.expect(E("01")).eq("00000001"),e.expect(E("03")).eq("00000011"),e.expect(E("07")).eq("00000111"),e.expect(E("0f")).eq("00001111"),e.expect(E("10")).eq("00010000"),e.expect(E("f".repeat(14))).eq("1".repeat(56))}))})),describe("binToHex",(()=>{it("should convert a binary string to a hex string",(()=>{e.expect(m("00000001")).eq("01"),e.expect(m("00000011")).eq("03"),e.expect(m("00000111")).eq("07"),e.expect(m("00001111")).eq("0f"),e.expect((()=>m("1"))).throws("Binary strings must be byte aligned.")}))})),describe("chunkString",(()=>{it("should split up an array",(()=>{e.expect(w("1234567",2)).to.deep.eq(["12","34","56","7"]),e.expect(w("",2)).to.deep.eq([])}))})),describe("chunkArray",(()=>{it("should split up an array",(()=>{e.expect(function(e,t){const c=[];for(let t=0;t<e.length;t+=2)c.push(e.slice(t,t+2));return c}([1,2,3,4,5,6,7])).to.deep.eq([[1,2],[3,4],[5,6],[7]])}))})),describe("hexToPublicKey",(()=>{it("should convert a hex string to a public key without shifting",(()=>{const t=_(x("1").padStart(62,"0"));e.expect(t).to.not.be.undefined})),it("should convert a hex string to a public key with shifting",(()=>{const t=_(x("11").padStart(62,"0"));e.expect(t).to.not.be.undefined})),it("should throw an error if the input is not of length 62",(()=>{e.expect((()=>_("1"))).throws("Input to hexToPublicKey must be of length 62")}))})),describe("publicKeyToHex",(()=>{it("should work with a publicKeyToHex without rotating",(()=>{const t=x("11").padStart(62,"0");const c=A(_(t));e.expect(c).eq(t)})),it("should work with a publicKeyToHex with rotating",(()=>{const t="1".padStart(62,"0");const c=A(_(t));e.expect(c).eq(t)})),it("should work with a random input",(()=>{const t=(e=>{let t="";const c="abcdef0123456789";for(let e=0;e<62;e+=1)t+=c.charAt(Math.floor(Math.random()*c.length));return t})();const c=A(_(t));e.expect(c).eq(t)})),it("should perform round trip between ascii and a public key",(()=>{const t="qwerty";const c=b(A(_(x(t).padStart(62,"0"))));e.expect(c).to.be.deep.eq(t)})),it("should perform round trip between ascii and a public key",(()=>{const t="5b7b2261223a317d5d";const c=b(A(_(x(t).padStart(62,"0"))));e.expect(c).to.be.deep.eq(t)}))})),describe("getCoinType",(()=>{it("should work",(()=>{e.expect(I()).eq(1),e.expect(I("LTC","mainnet")).eq(2)}))})),describe("getPath",(()=>{it("should work",(()=>{e.expect(y()).eq("m/44'/1'/0'"),e.expect(y({chain:"LTC",network:"mainnet"})).eq("m/44'/2'/0'")}))})),describe("getIndexPath",(()=>{it("should work",(()=>{e.expect(M()).to.be.an("string"),e.expect(M({chain:"LTC",network:"mainnet",account:123})).eq("m/44'/2'/123'")}))})),describe("getRandomIntegerInsecure",(()=>{it("should work",(()=>{e.expect(N()).to.be.an("number")}))}))}));
