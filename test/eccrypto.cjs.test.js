"use strict";var t=require("bitcoin-computer-bitcore");var e=require("chai");var r=require("crypto");var n=require("crypto-js");var o=require("eciesjs");function c(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}function i(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(r){if("default"!==r){var n=Object.getOwnPropertyDescriptor(t,r);Object.defineProperty(e,r,n.get?n:{enumerable:!0,get:function(){return t[r]}})}})),e.default=t,Object.freeze(e)}var s=c(r);var f=c(n);var u=i(o);function a(t){return Buffer.from(f.default.SHA256(t).toString(),"hex").toString("hex").substr(0,4)}function l(t){return`${a(t)};${t}`}function p(t){const e=t.substr(0,4);const r=t.substr(5);if(!function(t,e){return a(t)===e}(r,e))throw new Error("Decryption failure");return r}function y(){return s.default.randomBytes(32).toString("hex")}function d(t,e){if(!/^[0-9a-f]{64}$/.test(e))throw new Error("Invalid secret");const r=Buffer.from(e,"hex").toString("binary");const n=l(t);return f.default.AES.encrypt(n,r).toString()}function m(t,e){if(!/^[0-9a-f]{64}$/.test(e))throw new Error("Invalid secret");const r=Buffer.from(e,"hex").toString("binary");return p(f.default.AES.decrypt(t,r).toString(f.default.enc.Utf8))}function b(t,e){if(!/^0[2-3][0-9a-f]{64}|04[0-9a-f]{128}$/.test(e))throw new Error("Invalid publicKey");const r=l(t);return u.encrypt(e,Buffer.from(r,"utf8")).toString("base64")}function h(t,e){if(!/^[0-9a-f]{64}$/.test(e))throw new Error("Invalid privateKey");return p(u.decrypt(e,Buffer.from(t,"base64")).toString("utf8"))}function g(t,e){const r=t.split(".");let n="";if(e.forEach((t=>{r.forEach((e=>{try{n=m(e,t)}catch(t){const e=["Decryption failure","Malformed UTF-8 data"];if(t instanceof Error&&!e.includes(t.message))throw t}}))})),n)return n;throw new Error("Decryption failure")}function x({__cypher:t,__secrets:e},r){let n="";if(r.forEach((r=>{e.forEach((e=>{try{const o=h(e,r);n=m(t,o)}catch(t){const e=["Decryption failure","Unsupported state or unable to authenticate data"];if(t instanceof Error&&!e.includes(t.message))throw t}}))})),n)return n;throw new Error("Decryption failure")}const{PrivateKey:S}=t.Bitcoin;describe("Crypto",(()=>{describe("Random secret",(()=>{it("Tests random secret",(()=>{const t=y();e.expect(t.length).eq(64)}))})),describe("Symmetric encryption",(()=>{it("Tests symmetric encryption",(()=>{const t=y();const r=d("Hello, World",t);e.expect(r).to.not.be.undefined,e.expect(typeof r).eq("string");const n=m(r,t);e.expect(n).eq("Hello, World")}))})),describe("Asymmetric encryption",(()=>{it("Tests asymmetric encryption",(()=>{const t=new S;const r=t.toPublicKey();const n=t.toBuffer().toString("hex");const o=b("Hello, World",r.toString());e.expect(o).to.not.be.undefined,e.expect(typeof o).eq("string");const c=h(o,n);e.expect(c).eq("Hello, World")}))})),describe("Symmetric encryption multi-secret",(()=>{it("Symmetric encryption multi-secret",(()=>{const t=y();const r=y();const n=[t,r].map((t=>d("Hello, World",t))).join(".");e.expect(n).to.not.be.undefined,e.expect(typeof n).eq("string");const o=g(n,[t]);e.expect(o).eq("Hello, World");const c=g(n,[r]);e.expect(c).eq("Hello, World")}))})),describe("Asymmetric encryption multi-key",(()=>{it("Tests asymmetric encryption multi-key",(()=>{const t=new S;const r=t.toPublicKey();const n=t.toBuffer().toString("hex");const o=r.toString();const c=new S;const i=c.toPublicKey();const s=c.toBuffer().toString("hex");const f=i.toString();const u=JSON.stringify({a:"a"});const a=function(t,e){const r=y();return{__cypher:d(t,r),__secrets:e.map((t=>b(r,t)))}}(u,[o,f]);e.expect(a).to.be.an("object"),e.expect(a.__cypher).to.be.an("string"),e.expect(a.__secrets).to.be.an("array").that.have.lengthOf(2);const l=x(a,[n]);const p=x(a,[s]);e.expect(l).eq(u),e.expect(p).eq(u)}))}))}));
