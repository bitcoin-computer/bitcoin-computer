import{expect as r}from"chai";import"bitcoin-computer-bitcore";import"axios";import"child_process";import"crypto";import"crypto-js";import"eciesjs";import"@endo/static-module-record";import e from"util";import"url";import"fs/promises";const{CHAIN:t,NETWORK:o,BCN_URL:n,RPC_USER:s,RPC_PASSWORD:a,TEST_MNEMONICS:i}=process.env;function u(r){return{smartArgs:r.filter((r=>r._rev)),dumbArgs:r.map((r=>r._rev?"__":r))}}parseInt(process.env.BC_DUST_LIMIT||"",10),parseInt(process.env.BC_DEFAULT_FEE||"",10),parseInt(process.env.BC_SCRIPT_CHUNK_SIZE||"",10),parseInt(process.env.MWEB_HEIGHT||"",10);const c=r=>(Object.prototype.toString.call(r).match(/\s([a-zA-Z]+)/)||[])[1];const p=r=>"object"==typeof r?c(r):c(r).toLowerCase();const l=r=>{if((r=>["number","string","boolean","undefined","Null"].includes(p(r)))(r))return r;if((r=>"Array"===p(r))(r))return r.map(l);if((r=>"Object"===p(r))(r)){const e=Object.keys(r).reduce(((e,t)=>(e[t]=l(r[t]),e)),{});const t=Object.create(Object.getPrototypeOf(r));return Object.assign(t,e)}throw new Error(`Unsupported data type for clone: ${p(r)}`)};var v={exports:{}};var f="win32"===process.platform;var b=e;function m(r,e){var t=[];for(var o=0;o<r.length;o++){var n=r[o];n&&"."!==n&&(".."===n?t.length&&".."!==t[t.length-1]?t.pop():e&&t.push(".."):t.push(n))}return t}function g(r){var e=r.length-1;var t=0;for(;t<=e&&!r[t];t++);var o=e;for(;o>=0&&!r[o];o--);return 0===t&&o===e?r:t>o?[]:r.slice(t,o+1)}var h=/^([a-zA-Z]:|[\\\/]{2}[^\\\/]+[\\\/]+[^\\\/]+)?([\\\/])?([\s\S]*?)$/;var d=/^([\s\S]*?)((?:\.{1,2}|[^\\\/]+?|)(\.[^.\/\\]*|))(?:[\\\/]*)$/;var w={};function _(r){var e=h.exec(r),t=(e[1]||"")+(e[2]||""),o=e[3]||"";var n=d.exec(o);return[t,n[1],n[2],n[3]]}function j(r){var e=h.exec(r),t=e[1]||"",o=!!t&&":"!==t[1];return{device:t,isUnc:o,isAbsolute:o||!!e[2],tail:e[3]}}function A(r){return"\\\\"+r.replace(/^[\\\/]+/,"").replace(/[\\\/]+/g,"\\")}w.resolve=function(){var r="",e="",t=!1;for(var o=arguments.length-1;o>=-1;o--){var n;if(o>=0?n=arguments[o]:r?(n=process.env["="+r])&&n.substr(0,3).toLowerCase()===r.toLowerCase()+"\\"||(n=r+"\\"):n=process.cwd(),!b.isString(n))throw new TypeError("Arguments to path.resolve must be strings");if(n){var s=j(n),a=s.device,i=s.isUnc,u=s.isAbsolute,c=s.tail;if((!a||!r||a.toLowerCase()===r.toLowerCase())&&(r||(r=a),t||(e=c+"\\"+e,t=u),r&&t))break}}return i&&(r=A(r)),r+(t?"\\":"")+(e=m(e.split(/[\\\/]+/),!t).join("\\"))||"."},w.normalize=function(r){var e=j(r),t=e.device,o=e.isUnc,n=e.isAbsolute,s=e.tail,a=/[\\\/]$/.test(s);return(s=m(s.split(/[\\\/]+/),!n).join("\\"))||n||(s="."),s&&a&&(s+="\\"),o&&(t=A(t)),t+(n?"\\":"")+s},w.isAbsolute=function(r){return j(r).isAbsolute},w.join=function(){var r=[];for(var e=0;e<arguments.length;e++){var t=arguments[e];if(!b.isString(t))throw new TypeError("Arguments to path.join must be strings");t&&r.push(t)}var o=r.join("\\");return/^[\\\/]{2}[^\\\/]/.test(r[0])||(o=o.replace(/^[\\\/]{2,}/,"\\")),w.normalize(o)},w.relative=function(r,e){r=w.resolve(r),e=w.resolve(e);var t=r.toLowerCase();var o=e.toLowerCase();var n=g(e.split("\\"));var s=g(t.split("\\"));var a=g(o.split("\\"));var i=Math.min(s.length,a.length);var u=i;for(var c=0;c<i;c++)if(s[c]!==a[c]){u=c;break}if(0==u)return e;var p=[];for(c=u;c<s.length;c++)p.push("..");return(p=p.concat(n.slice(u))).join("\\")},w._makeLong=function(r){if(!b.isString(r))return r;if(!r)return"";var e=w.resolve(r);return/^[a-zA-Z]\:\\/.test(e)?"\\\\?\\"+e:/^\\\\[^?.]/.test(e)?"\\\\?\\UNC\\"+e.substring(2):r},w.dirname=function(r){var e=_(r),t=e[0],o=e[1];return t||o?(o&&(o=o.substr(0,o.length-1)),t+o):"."},w.basename=function(r,e){var t=_(r)[2];return e&&t.substr(-1*e.length)===e&&(t=t.substr(0,t.length-e.length)),t},w.extname=function(r){return _(r)[3]},w.format=function(r){if(!b.isObject(r))throw new TypeError("Parameter 'pathObject' must be an object, not "+typeof r);var e=r.root||"";if(!b.isString(e))throw new TypeError("'pathObject.root' must be a string or undefined, not "+typeof r.root);var t=r.dir;var o=r.base||"";return t?t[t.length-1]===w.sep?t+o:t+w.sep+o:o},w.parse=function(r){if(!b.isString(r))throw new TypeError("Parameter 'pathString' must be a string, not "+typeof r);var e=_(r);if(!e||4!==e.length)throw new TypeError("Invalid path '"+r+"'");return{root:e[0],dir:e[0]+e[1].slice(0,-1),base:e[2],ext:e[3],name:e[2].slice(0,e[2].length-e[3].length)}},w.sep="\\",w.delimiter=";";var y=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/;var E={};function S(r){return y.exec(r).slice(1)}function T(r,e){let t=0;return e.map((e=>"__"===e?r[t++]:e))}E.resolve=function(){var r="",e=!1;for(var t=arguments.length-1;t>=-1&&!e;t--){var o=t>=0?arguments[t]:process.cwd();if(!b.isString(o))throw new TypeError("Arguments to path.resolve must be strings");o&&(r=o+"/"+r,e="/"===o[0])}return(e?"/":"")+(r=m(r.split("/"),!e).join("/"))||"."},E.normalize=function(r){var e=E.isAbsolute(r),t=r&&"/"===r[r.length-1];return(r=m(r.split("/"),!e).join("/"))||e||(r="."),r&&t&&(r+="/"),(e?"/":"")+r},E.isAbsolute=function(r){return"/"===r.charAt(0)},E.join=function(){var r="";for(var e=0;e<arguments.length;e++){var t=arguments[e];if(!b.isString(t))throw new TypeError("Arguments to path.join must be strings");t&&(r+=r?"/"+t:t)}return E.normalize(r)},E.relative=function(r,e){r=E.resolve(r).substr(1),e=E.resolve(e).substr(1);var t=g(r.split("/"));var o=g(e.split("/"));var n=Math.min(t.length,o.length);var s=n;for(var a=0;a<n;a++)if(t[a]!==o[a]){s=a;break}var i=[];for(a=s;a<t.length;a++)i.push("..");return(i=i.concat(o.slice(s))).join("/")},E._makeLong=function(r){return r},E.dirname=function(r){var e=S(r),t=e[0],o=e[1];return t||o?(o&&(o=o.substr(0,o.length-1)),t+o):"."},E.basename=function(r,e){var t=S(r)[2];return e&&t.substr(-1*e.length)===e&&(t=t.substr(0,t.length-e.length)),t},E.extname=function(r){return S(r)[3]},E.format=function(r){if(!b.isObject(r))throw new TypeError("Parameter 'pathObject' must be an object, not "+typeof r);var e=r.root||"";if(!b.isString(e))throw new TypeError("'pathObject.root' must be a string or undefined, not "+typeof r.root);return(r.dir?r.dir+E.sep:"")+(r.base||"")},E.parse=function(r){if(!b.isString(r))throw new TypeError("Parameter 'pathString' must be a string, not "+typeof r);var e=S(r);if(!e||4!==e.length)throw new TypeError("Invalid path '"+r+"'");return e[1]=e[1]||"",e[2]=e[2]||"",e[3]=e[3]||"",{root:e[0],dir:e[0]+e[1].slice(0,-1),base:e[2],ext:e[3],name:e[2].slice(0,e[2].length-e[3].length)}},E.sep="/",E.delimiter=":",v.exports=f?w:E,v.exports.posix=E,v.exports.win32=w,describe("helpers",(()=>{describe("splitArgs",(()=>{it("should work for an array of dumb objects",(()=>{r(u([{a:1},{b:2}])).to.deep.eq({dumbArgs:[{a:1},{b:2}],smartArgs:[]})})),it("should work for an array of smart objects",(()=>{r(u([{a:1,_rev:"rev1"},{b:2,_rev:"rev1"}])).to.deep.eq({dumbArgs:["__","__"],smartArgs:[{_rev:"rev1",a:1},{_rev:"rev1",b:2}]})})),it("should work for an array of smart objects",(()=>{r(u([{a:1},{b:2,_rev:"rev1"}])).to.deep.eq({dumbArgs:[{a:1},"__"],smartArgs:[{_rev:"rev1",b:2}]})}))})),describe("mergeArgs",(()=>{it("should work for an array of dumb objects",(()=>{const e=[{a:1}];const t=l(e);r(T(e,["__"])).to.deep.eq([{a:1}]),r(t).to.deep.eq(e)})),it("should work for an array of dumb objects",(()=>{const e=[{a:1},{b:2}];const{smartArgs:t,dumbArgs:o}=u(e);r(T(t,o)).to.deep.eq(e)})),it("should work for an array of smart objects",(()=>{const e=[{a:1,_rev:"rev0"},{b:2,_rev:"rev0"}];const{smartArgs:t,dumbArgs:o}=u(e);r(T(t,o)).to.deep.eq(e)})),it("should work for a mixed array of objects",(()=>{const e=[{a:1},{b:2,_rev:"rev0"}];const{smartArgs:t,dumbArgs:o}=u(e);r(T(t,o)).to.deep.eq(e)}))}))}));
